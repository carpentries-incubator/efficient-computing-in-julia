<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Efficient Computing in Julia: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="favicons/incubator/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicons/incubator/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicons/incubator/favicon-16x16.png">
<link rel="manifest" href="favicons/incubator/site.webmanifest">
<link rel="mask-icon" href="favicons/incubator/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Efficient Computing in Julia
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Efficient Computing in Julia
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Efficient Computing in Julia
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="020-getting-started.html">1. Getting Started</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="030-julia-basics.html">2. Introduction to Julia</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="040-dispatch-and-types.html">3. Types and Dispatch</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="060-simulating-solar-system.html">4. Simulating the Solar System</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="070-pkg.html">5. Packages and environments</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="080-package-development.html">6. Package development</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="090-best-practices.html">7. Best practices</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="100-introduction-performance.html">8. Type Stability</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="120-allocations.html">9. Reducing allocations on the Logistic Map</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="130-value-types-and-ca.html">10. Value types: game of life</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="140-threads-async-and-tasks.html">11. Threads, ASync and Tasks</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush13">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading13">
        <a href="170-gpu-programming.html">12. GPU Programming</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush14">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading14">
        <a href="180-cool-libraries.html">13. Recap and Recommended libraries</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush15">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading15">
        <a href="a01-collatz.html">14. Appendix: Iterators and type stability</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources">
<a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-020-getting-started"><p>Content from <a href="020-getting-started.html">Getting Started</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/020-getting-started.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Why should I use Julia?</li>
<li>How do I get started with Julia?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Start a REPL</li>
<li>Run lines from VS Code</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="why-julia">Why Julia<a class="anchor" aria-label="anchor" href="#why-julia"></a>
</h2>
<hr class="half-width">
<p>Most of the participants will be coming from Python, MATLAB or a
lower level language like C/C++ or Fortran. Why should you be interested
in learning Julia?</p>
<div class="section level3">
<h3 id="performance-and-usability">Performance and usability<a class="anchor" aria-label="anchor" href="#performance-and-usability"></a>
</h3>
<p>Julia promises:</p>
<ul>
<li>Native performance: close to or sometimes even exceeding C++ or
Fortran.</li>
<li>Solve the multiple language issue: one language for everything
(including GPU).</li>
<li>As easy to get into as Python or R.</li>
<li>Designed for parallel computing.</li>
</ul>
<p>These promises seem tantalizing and are in part what draws people to
Julia, but in practice getting into Julia and writing performant code
are two different things. Julia has its own idiosyncrasies that need to
be understood to really squeeze every erg of performance out of your
system.</p>
<p>Julia obtains its performance from being a just-in-time (JIT)
compiler, on top of the LLVM compiler stack (similar to how Python’s
Numba operates).</p>
</div>
<div class="section level3">
<h3 id="language-intrinsics">Language intrinsics<a class="anchor" aria-label="anchor" href="#language-intrinsics"></a>
</h3>
<p>Next to being performant, it turns out that Julia is a very nice
language that does some things a bit different from what you may be used
to:</p>
<ul>
<li>
<strong>First-class arrays</strong> and
<strong>Broadcasting</strong>: arrays, slicing and operating on arrays
have dedicated syntax, similar to MATLAB.</li>
<li>
<strong>Multiple dispatch</strong>: Julia functions can be
specialized on the entire call signature (not just its first argument
like in Object Oriented Programming).</li>
<li>
<strong>Macros and Meta-programming</strong>: The just-in-time
nature of the Julia compiler exposes a wide range of meta-programming
capabilities, ranging from small macros to enhance the expressibility of
the language to full-on code generation.</li>
</ul>
<p>Meta-programming, while very powerful, is also very easy to abuse,
often leading to unreadable non-idiomatic code. So tread with care!
We’ll see some examples where macros are indispensable though, and the
SciML stack relies deeply on on-the-fly code-generation.</p>
<div id="discussion1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Discussion</h3>
<div class="callout-content">
<p>Why are you interested in Julia? What is your current go-to for
efficient computing?</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="recommended-materials">Recommended materials<a class="anchor" aria-label="anchor" href="#recommended-materials"></a>
</h2>
<hr class="half-width">
<p>If you want to learn more about computer programming in general, a
great place to start is <a href="https://web.mit.edu/6.001/6.037/sicp.pdf" class="external-link">Structure and
Interpretation of Computer Programs</a>, including the <a href="https://www.youtube.com/playlist?list=PLE18841CABEA24090" class="external-link">Lectures
on Youtube</a>. These are old but wonderful and really teach some wisdom
around designing complex software systems. Also, this might cure any
latent adiction to object oriented programming.</p>
<p>If you want to learn about efficient programming in Julia, check out
<a href="https://www.youtube.com/playlist?list=PLCAl7tjCwWyGjdzOOnlbGnVNZk0kB8VSa" class="external-link">Parallel
Computing and Scientific Machine Learning</a>. These go in much more
detail than we can do in this lecture.</p>
<p>The materials in this lesson are aimed somewhere in between SICP and
PCSML. We’ll look at real scientific examples to dive into computational
concepts.</p>
</section><section><h2 class="section-heading" id="running-julia">Running Julia<a class="anchor" aria-label="anchor" href="#running-julia"></a>
</h2>
<hr class="half-width">
<p>When working in Julia it is very common to do so from the REPL
(Read-Eval-Print Loop). Please open the Julia REPL on your system</p>
<pre class="shell"><code>$ julia</code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>               _
   _       _ _(_)_     |  Documentation: https://docs.julialang.org
  (_)     | (_) (_)    |
   _ _   _| |_  __ _   |  Type "?" for help, "]?" for Pkg help.
  | | | | | | |/ _` |  |
  | | |_| | | | (_| |  |  Version 1.10.3 (2024-04-30)
 _/ |\__'_|_|_|\__'_|  |  Official https://julialang.org/ release
|__/                   |

julia&gt;</code></pre>
</div>
<p>The REPL needs a small introduction since it has several
<strong>modes</strong>.</p>
<table style="width:100%;" class="table">
<colgroup>
<col width="26%">
<col width="42%">
<col width="31%">
</colgroup>
<thead><tr class="header">
<th>Key</th>
<th>Prompt</th>
<th>Mode</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>None</td>
<td><code>julia&gt;</code></td>
<td>Standard <strong>Julia</strong> input.</td>
</tr>
<tr class="even">
<td><code>]</code></td>
<td><code>pkg&gt;</code></td>
<td>
<strong>Pkg</strong> mode. Commands entered here are functions in
the <code>Pkg</code> module.</td>
</tr>
<tr class="odd">
<td><code>;</code></td>
<td><code>shell&gt;</code></td>
<td>
<strong>Shell</strong> mode.</td>
</tr>
<tr class="even">
<td><code>?</code></td>
<td><code>help?&gt;</code></td>
<td>
<strong>Help</strong> mode. Type the name of any entity to look up
its documentation.</td>
</tr>
</tbody>
</table>
<p>To switch back to the standard Julia input from another mode, press
<code>Ctrl+C</code></p>
<div id="play-with-the-repl-5min" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="play-with-the-repl-5min" class="callout-inner">
<h3 class="callout-title">Play with the REPL (5min)</h3>
<div class="callout-content">
<ol style="list-style-type: lower-alpha">
<li>
<code>Pkg</code> mode has a <code>help</code> command to help you
along. Find out what the <code>add</code> command does.</li>
<li>Check the contents of the folder in which you are running your REPL
(<code>ls</code> on Unix, <code>dir</code> on Windows).</li>
<li>Find out what the <code>print</code> method does in Julia.</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<ol style="list-style-type: lower-alpha">
<li>
<code>]help add</code>, the <code>add</code> command installs
packages</li>
<li><code>;ls</code></li>
<li><code>?print</code></li>
</ol>
</div>
</div>
</div>
</div>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>Please take a look at the Julia documentation now at <a href="https://docs.julialang.org/en/v1/" class="external-link">https://docs.julialang.org/en/v1/</a>.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="pluto">Pluto<a class="anchor" aria-label="anchor" href="#pluto"></a>
</h2>
<hr class="half-width">
<p>Pluto is the notebook environment from which we will teach much of
this workshop. We can run it from the Julia REPL.</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>pkg&gt; add Pluto
... quite a bit of output ...

julia&gt; using Pluto

julia&gt; Pluto.run()
[ Info: Loading...
┌ Info:
└ Opening http://localhost:1235/?secret=xyzxyzxyz in your default browser... ~ have fun!
┌ Info:
│ Press Ctrl+C in this terminal to stop Pluto
└</code></pre>
</div>
</section><section><h2 class="section-heading" id="vs-code">VS Code<a class="anchor" aria-label="anchor" href="#vs-code"></a>
</h2>
<hr class="half-width">
<p>VS Code is the editor for which Julia has the best support. We’ll be
needing to run Julia in multiple threads later on, so we’ll set some
arguments for the REPL in <code>settings.json</code> (press
<code>Ctrl+Shift+P</code> and search for
<code>Open User Settings (JSON)</code>).</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">JSON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode json" tabindex="0"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    <span class="er">...</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="dt">"julia.additionalArgs"</span><span class="fu">:</span> <span class="ot">[</span> </span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>        <span class="st">"-t"</span><span class="ot">,</span> <span class="st">"4"</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="fu">}</span></span></code></pre>
</div>
<p>Now when you start a new REPL (<code>Ctrl+Shift+P</code>, search
“Julia REPL”), you can query the number of threads available:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="bu">Threads</span>.<span class="fu">nthreads</span>()</span></code></pre>
</div>
<div id="julia-as-a-calculator-5min" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="julia-as-a-calculator-5min" class="callout-inner">
<h3 class="callout-title">Julia as a calculator (5min)</h3>
<div class="callout-content">
<p>Try to play around in the VS Code REPL to use Julia as a
calculator.</p>
<ol style="list-style-type: lower-alpha">
<li>What do you find is the operator for exponentiation?</li>
<li>How do you assign a variable?</li>
<li>What happens when you divide any two integers? Use the
<code>typeof</code> function to inspect the type of the result. Can you
figure out how to integer division (search the documentation!)?</li>
<li>What happens in Pluto when you change a variable that is depended
upon?</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<ol style="list-style-type: lower-alpha">
<li>In Julia exponentiation is <code>^</code>.</li>
<li>Just like you’re used to <code>x = 3</code>.</li>
<li>The <code>/</code> operator always returns a floating point value.
To get to integer division, we want the <code>÷</code> operator, which
can be typed using <code>\div</code> and then press TAB. Or you can use
the equivalent <code>div</code> function.</li>
<li>Pluto updates all dependent computations automatically. This is
known as a <strong>reactive notebook</strong>.</li>
</ol>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>In Julia, the REPL is much more important than in some other
languages.</li>
<li>Pluto is a reactive environment</li>
<li>VS Code has the best editor integration for Julia</li>
</ul>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="activate-the-workshop-environment">Activate the Workshop Environment<a class="anchor" aria-label="anchor" href="#activate-the-workshop-environment"></a>
</h2>
<hr class="half-width">
<p>For this workshop, we prepared an environment. Press <code>]</code>
in the REPL to activate <code>Pkg</code> mode. Make sure that you are in
the path where you prepared your environment (see Setup
Instructions).</p>
<pre><code>(v1.11) pkg&gt; activate .
(EfficientJulia) pkg&gt;</code></pre>
<p>Alternatively, check the little “Julia env” message at the bottom of
VS Code, and make sure that the correct environment is there.</p>
<p>You should now be able to generate a plot using <code>GLMakie</code>
(that one dependency that made you wait)</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>x <span class="op">=</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">:</span><span class="fl">0.1</span><span class="op">:</span><span class="fl">3.0</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>z <span class="op">=</span> <span class="fu">sinc</span>.(<span class="fu">sqrt</span>.(x<span class="op">.^</span><span class="fl">2</span> <span class="op">.+</span> x<span class="op">'.^</span><span class="fl">2</span>))</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="fu">surface</span>(x, x, z, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="fu">wireframe!</span>(x, x, z, color<span class="op">=:</span>black, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span></code></pre>
</div>
<figure><img src="fig/getting-started-makie.png" alt="A 3d rendering of a sinc function." class="figure mx-auto d-block"><div class="figcaption">A 3D surface plot</div>
</figure><div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Figure code </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler1" aria-labelledby="headingSpoiler1">
<div class="accordion-body">
<p>To create the above figure:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">#| classes: ["task"]</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co">#| creates: episodes/fig/getting-started-makie.png</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">#| collect: figures</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="kw">module</span> Script</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="kw">function</span> <span class="fu">main</span>()</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    x <span class="op">=</span> <span class="op">-</span><span class="fl">3.0</span><span class="op">:</span><span class="fl">0.1</span><span class="op">:</span><span class="fl">3.0</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    z <span class="op">=</span> <span class="fu">sinc</span>.(<span class="fu">sqrt</span>.(x<span class="op">.^</span><span class="fl">2</span> <span class="op">.+</span> x<span class="op">'.^</span><span class="fl">2</span>))</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size<span class="op">=</span>(<span class="fl">1024</span>, <span class="fl">768</span>))</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis3</span>(fig[<span class="fl">1</span>,<span class="fl">1</span>])</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>    <span class="fu">surface!</span>(ax, x, x, z, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>    <span class="fu">wireframe!</span>(ax, x, x, z, color<span class="op">=:</span>black, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>    <span class="fu">save</span>(<span class="st">"episodes/fig/getting-started-makie.png"</span>, fig)</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>Script.<span class="fu">main</span>()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-030-julia-basics"><p>Content from <a href="030-julia-basics.html">Introduction to Julia</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/030-julia-basics.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I write elementary programs in Julia?</li>
<li>What are the differences with Python/MATLAB/R?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>functions</li>
<li>loops</li>
<li>conditionals</li>
<li>scoping</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Unfortunately, it lies outside the scope of this workshop to give an
introduction to the full Julia language. Instead, we’ll briefly show the
basic syntax, and then focus on some key differences with other popular
languages.</p>
<section><h2 class="section-heading" id="about-julia">About Julia<a class="anchor" aria-label="anchor" href="#about-julia"></a>
</h2>
<hr class="half-width">
<p>These are some words that we will write down: never forget.</p>
<ul>
<li>A just-in-time compiled, dynamically typed language</li>
<li>multiple dispatch</li>
<li>expression based syntax</li>
<li>rich macro system</li>
</ul>
<p>Oddities for Pythonistas:</p>
<ul>
<li>1-based indexing</li>
<li>lexical scoping</li>
</ul>
<p>Better well stolen … Always ask when learning a new language: what
are the primitives, the means of combination and the means of
abstraction. Many languages are very similar in these regards, so we’ll
look at things that are different:</p>
<table class="table">
<colgroup>
<col width="19%">
<col width="38%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>What</th>
<th>Procedures</th>
<th>Data</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>primitives</td>
<td>standard library</td>
<td>(numbers, strings, etc.) arrays, symbols, channels</td>
</tr>
<tr class="even">
<td>means of combination</td>
<td>(<code>for</code>, <code>if</code> etc.) broadcasting,
<code>do</code>
</td>
<td>tuples, <code>struct</code>, expressions</td>
</tr>
<tr class="odd">
<td>means of abstraction</td>
<td>functions, dispatch, macros (no classes!)</td>
<td>
<code>abstract type</code>, generics</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="eval">Eval<a class="anchor" aria-label="anchor" href="#eval"></a>
</h3>
<p>How is Julia evaluated? Types only instantiate at run-time,
triggering the compile time specialization of untyped functions.</p>
<ul>
<li>Julia can be “easy”, because the user doesn’t have to tinker with
types.</li>
<li>Julia can be “fast”, as soon as the compiler knows all the
types.</li>
</ul>
<p>When a function is called with a hitherto new type signature,
compilation is triggered. Julia’s biggest means of abstraction:
<em>multiple dispatch</em> is only an emergent property of this
evaluation strategy.</p>
<p>Julia has a heritage from functional programming languages (nowadays
well hidden not to scare people). What we get from this:</p>
<ul>
<li>expression based syntax: everything is an expression, meaning it
reduces to a value</li>
<li>a rich macro system: we can extend the language itself to suit our
needs (not covered in this workshop)</li>
</ul>
<p>Julia is designed to replace MATLAB:</p>
<ul>
<li>high degree of built-in support for multi-dimensional arrays and
linear algebra</li>
<li>ecosystem of libraries around numeric modelling</li>
</ul>
<p>Julia is designed to replace Fortran:</p>
<ul>
<li>high performance</li>
<li>accelerate using <code>Threads</code> or through the GPU
interfaces</li>
<li>scalable through <code>Distributed</code> or <code>MPI</code>
</li>
</ul>
<p>Julia is designed to replace Conda:</p>
<ul>
<li>quality package system with pre-compiled binary libraries for system
dependencies</li>
<li>highly reproducible</li>
<li>easy to use on HPC facilities</li>
</ul>
<p>Julia is not (some people might get angry for this):</p>
<ul>
<li>a suitable scripting language</li>
<li>a systems programming language like C or Rust (imagine waiting for
<code>ls</code> to compile every time you run it)</li>
<li>replacing either C or Python anytime soon</li>
</ul>
</div>
</section><section><h2 class="section-heading" id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a>
</h2>
<hr class="half-width">
<p>Functions are declared with the <code>function</code> keyword. The
<strong>block</strong> or function <strong>body</strong> is ended with
<code>end</code>. All blocks in Julia end with <code>end</code>.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="kw">const</span> G <span class="op">=</span> <span class="fl">6.6743e-11</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="kw">function</span> <span class="fu">gravitational_force</span>(m1, m2, r)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="cf">return</span> G <span class="op">*</span> m1 <span class="op">*</span> m2 <span class="op">/</span> r<span class="op">^</span><span class="fl">2</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>Let’s compute the force between Earth and Moon, given the following
constants:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">const</span> EARTH_MASS <span class="op">=</span> <span class="fl">5.97219e24</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="kw">const</span> LUNAR_MASS <span class="op">=</span> <span class="fl">7.34767e22</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="kw">const</span> LUNAR_DISTANCE <span class="op">=</span> <span class="fl">384_400_000.0</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">gravitational_force</span>(EARTH_MASS, LUNAR_MASS, LUNAR_DISTANCE)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">1.982084770423259e20</span></span></code></pre>
</div>
<p>There is a shorter syntax for functions that is useful for
one-liners:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">gravitational_force</span>(m1, m2, r) <span class="op">=</span> G <span class="op">*</span> m1 <span class="op">*</span> m2 <span class="op">/</span> r<span class="op">^</span><span class="fl">2</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="anonymous-functions-or-lambdas">Anonymous functions (or lambdas)<a class="anchor" aria-label="anchor" href="#anonymous-functions-or-lambdas"></a>
</h3>
<p>Julia inherits a lot of concepts from functional programming. There
are two ways to define anonymous functions:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>F_g <span class="op">=</span> <span class="kw">function</span>(m1, m2, r)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="cf">return</span> G <span class="op">*</span> m1 <span class="op">*</span> m2 <span class="op">/</span> r<span class="op">^</span><span class="fl">2</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>And a shorter syntax,</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>F_g <span class="op">=</span> (m1, m2, r) <span class="op">-&gt;</span> G <span class="op">*</span> m1 <span class="op">*</span> m2 <span class="op">/</span> r<span class="op">^</span><span class="fl">2</span></span></code></pre>
</div>
<div id="higher-order-functions" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="higher-order-functions" class="callout-inner">
<h3 class="callout-title">Higher order functions</h3>
<div class="callout-content">
<p>Use the <code>map</code> function in combination with an anonymous
function to compute the squares of the first ten integers (use
<code>1:10</code> to create that range).</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>Read the documentation of <code>map</code> using the <code>?</code>
help mode, also available in Pluto.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">map</span>(x <span class="op">-&gt;</span> x<span class="op">^</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>)</span></code></pre>
</div>
<p>In fact, we’ll see that <code>map</code> is not often used, since
Julia has many better ways to express mapping operations of this
kind.</p>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="if-statements-for-loops">If statements, for loops<a class="anchor" aria-label="anchor" href="#if-statements-for-loops"></a>
</h2>
<hr class="half-width">
<p>Here’s another function that’s a little more involved.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">is_prime</span>(x)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  <span class="cf">if</span> x <span class="op">&lt;</span> <span class="fl">2</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">false</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="cf">for</span> i <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fu">isqrt</span>(x)</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">%</span> i <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>      <span class="cf">return</span> <span class="cn">false</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>  <span class="cf">return</span> <span class="cn">true</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div id="ranges" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="ranges" class="callout-inner">
<h3 class="callout-title">Ranges</h3>
<div class="callout-content">
<p>The <code>for</code> loop iterates over the range
<code>2:isqrt(x)</code>. We’ll see that Julia indexes sequences starting
at integer value <code>1</code>. This usually implies that ranges are
given inclusive on both ends: for example, <code>collect(3:6)</code>
evaluates to <code>[3, 4, 5, 6]</code>.</p>
</div>
</div>
</div>
<div id="more-on-for-loops" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="more-on-for-loops" class="callout-inner">
<h3 class="callout-title">More on for-loops</h3>
<div class="callout-content">
<p>Loop iterations can be skipped using <code>continue</code>, or broken
with <code>break</code>, identical to C or Python.</p>
</div>
</div>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>The <code>i == j &amp;&amp; continue</code> is a short-cut notation
for</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="cf">if</span> i <span class="op">==</span> j</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>	<span class="cf">continue</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="cf">end</span></span></code></pre>
</div>
<p>We could also have written <code>i != j || continue</code>.</p>
<p>In general, the <code>||</code> and <code>&amp;&amp;</code> operators
can be chained to check increasingly stringent tests. For example:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">inbounds</span>(<span class="dt">Bool</span>, i, data) <span class="op">&amp;&amp;</span> data[i] <span class="op">&lt;</span> <span class="fl">10</span> <span class="op">&amp;&amp;</span> <span class="cf">return</span> <span class="fl">3</span><span class="op">*</span>data[i]</span></code></pre>
</div>
<p>Here, the second condition can only be evaluated if the first one was
true.</p>
<p><strong>Rewrite the <code>is_prime</code> function using this
notation.</strong></p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">is_prime</span>(x)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>    x <span class="op">&lt;</span> <span class="fl">2</span> <span class="op">&amp;&amp;</span> <span class="cf">return</span> <span class="cn">false</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    <span class="cf">for</span> i <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fu">isqrt</span>(x)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>        x <span class="op">%</span> i <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="cf">return</span> <span class="cn">false</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">true</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="fu">is_prime</span>(<span class="fl">42</span>)</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="fu">is_prime</span>(<span class="fl">43</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="return-statement" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="return-statement" class="callout-inner">
<h3 class="callout-title">Return statement</h3>
<div class="callout-content">
<p>In Julia, the <code>return</code> statement is not always strictly
necessary. Every statement is an expression, meaning that it has a
value. The value of a compound block is simply that of its last
expression. In the above function however, we have a non-local return:
once we find a divider for a number, we know the number is not prime,
and we don’t need to check any further.</p>
<p>Many people find it more readable however, to always have an explicit
<code>return</code>.</p>
<p>The fact that the <code>return</code> statement is optional for
normal function exit is part of a larger philosophy: everything is an
expression.</p>
</div>
</div>
</div>
<div id="lexical-scoping" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="lexical-scoping" class="callout-inner">
<h3 class="callout-title">Lexical scoping</h3>
<div class="callout-content">
<p>Julia is <strong>lexically scoped</strong>. This means that variables
do not outlive the block that they’re defined in. In a nutshell, this
means the following:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">let</span> s <span class="op">=</span> <span class="fl">42</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="fu">println</span>(s)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="cf">for</span> s <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="fu">println</span>(s)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>  <span class="fu">println</span>(s)</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">42</span></span>
<span><span class="fl">1</span></span>
<span><span class="fl">2</span></span>
<span><span class="fl">3</span></span>
<span><span class="fl">4</span></span>
<span><span class="fl">5</span></span>
<span><span class="fl">42</span></span></code></pre>
</div>
<p>In effect, the variable <code>s</code> inside the for-loop is said to
<strong>shadow</strong> the outer definition. Here, we also see a first
example of a <code>let</code> binding, creating a scope for some
temporary variables to live in.</p>
</div>
</div>
</div>
<div id="loops-and-conditionals" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="loops-and-conditionals" class="callout-inner">
<h3 class="callout-title">Loops and conditionals</h3>
<div class="callout-content">
<p>Write a loop that prints out all primes below 100.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>  <span class="cf">if</span> <span class="fu">is_prime</span>(i)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>    <span class="fu">println</span>(i)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="cf">end</span></span></code></pre>
</div>
<p>If you like to collect those into a vector, try the following:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fl">1</span><span class="op">:</span><span class="fl">100</span> <span class="op">|&gt;</span> <span class="fu">filter</span>(is_prime) <span class="op">|&gt;</span> collect</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="macros">Macros<a class="anchor" aria-label="anchor" href="#macros"></a>
</h2>
<hr class="half-width">
<p>Julia has macros. These are invocations that change the behaviour of
a given piece of code. In effect, arguments of a macro are syntactic
forms that can be rewritten by the macro. These can reduce the amount of
code you need to write to express certain concepts. You can recognize
macro calls by the <code>@</code> sign in front of them.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="pp">@assert</span> <span class="cn">true</span> <span class="st">"This will always pass"</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="pp">@assert</span> <span class="cn">false</span> <span class="st">"Oh, noes!"</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="pp">@macroexpand</span> <span class="pp">@assert</span> <span class="cn">false</span> <span class="st">"Oh, noes!"</span></span></code></pre>
</div>
<p>We will explain some macro’s as they are used. We won’t get into
writing macros ourselves. They can be incredibly useful, but should also
come with a warning: overuse of macros can make your code non-idiomatic
and therefore harder to read. Also macro-heavy frameworks tend to be
harder to debug, and often lack in composability.</p>
</section><section><h2 class="section-heading" id="some-important-first-lessons">Some important first lessons<a class="anchor" aria-label="anchor" href="#some-important-first-lessons"></a>
</h2>
<hr class="half-width">
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Julia has <code>if-else</code>, <code>for</code>,
<code>while</code>, <code>function</code> and <code>module</code> blocks
that are not dissimilar from other languages.</li>
<li>Blocks are all ended with <code>end</code>.</li>
<li>Always enclose code in functions because functions are compiled</li>
<li>Don’t use global mutable variables</li>
<li>Julia variables are not visible outside the block in which they’re
defined (unlike Python).</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-040-dispatch-and-types"><p>Content from <a href="040-dispatch-and-types.html">Types and Dispatch</a></p>
<hr>
<p>Last updated on 2025-01-12 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/040-dispatch-and-types.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How does Julia deal with types?</li>
<li>Can I do Object Oriented Programming?</li>
<li>People keep talking about multiple dispatch. What makes it so
special?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>dispatch</li>
<li>structs</li>
<li>abstract types</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Julia is a dynamically typed language. Nevertheless, we will see that
knowing where and where not to annotate types in your program is crucial
for managing performance.</p>
<p>In Julia there are two reasons for using the type system:</p>
<ul>
<li>structuring your data by declaring a <code>struct</code>
</li>
<li>dispatching methods based on their argument types</li>
</ul>
<section><h2 class="section-heading" id="inspection">Inspection<a class="anchor" aria-label="anchor" href="#inspection"></a>
</h2>
<hr class="half-width">
<p>You may inspect the dynamic type of a variable or expression using
the <code>typeof</code> function. For instance:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">typeof</span>(<span class="fl">3</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">Int64</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">typeof</span>(<span class="st">"hello"</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">String</span></span></code></pre>
</div>
<div id="plenary-types-of-floats" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="plenary-types-of-floats" class="callout-inner">
<h3 class="callout-title">(plenary) Types of floats</h3>
<div class="callout-content">
<p>Check the type of the following values:</p>
<ol style="list-style-type: lower-alpha">
<li><code>3</code></li>
<li><code>3.14</code></li>
<li><code>6.62607015e-34</code></li>
<li><code>6.6743f-11</code></li>
<li><code>6e0 * 7f0</code></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<ol style="list-style-type: lower-alpha">
<li><code>Int64</code></li>
<li><code>Float64</code></li>
<li><code>Float64</code></li>
<li><code>Float32</code></li>
<li><code>Float64</code></li>
</ol>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="structures">Structures<a class="anchor" aria-label="anchor" href="#structures"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">struct</span> Point2</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  x<span class="op">::</span><span class="dt">Float64</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  y<span class="op">::</span><span class="dt">Float64</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">let</span> p <span class="op">=</span> <span class="fu">Point2</span>(<span class="fl">1</span>, <span class="fl">3</span>)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="fu">println</span>(<span class="st">"Point at </span><span class="sc">$</span><span class="st">{</span>p<span class="st">.x}, </span><span class="sc">$</span><span class="st">{</span>p<span class="st">.y}"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a>
</h3>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">dot</span>(a<span class="op">::</span><span class="dt">Point2</span>, b<span class="op">::</span><span class="dt">Point2</span>) <span class="op">=</span> a.x<span class="op">*</span>b.x <span class="op">+</span> a.y<span class="op">*</span>b.y</span></code></pre>
</div>
<div id="d-point" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="d-point" class="callout-inner">
<h3 class="callout-title">3d Point</h3>
<div class="callout-content">

</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">struct</span> Point3</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  x<span class="op">::</span><span class="dt">Float64</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  y<span class="op">::</span><span class="dt">Float64</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  z<span class="op">::</span><span class="dt">Float64</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="fu">dot</span>(a<span class="op">::</span><span class="dt">Point3</span>, b<span class="op">::</span><span class="dt">Point3</span>) <span class="op">=</span> a.x<span class="op">*</span>b.x <span class="op">+</span> a.y<span class="op">*</span>b.y <span class="op">+</span> a.z<span class="op">*</span>b.z</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="multiple-dispatch-function-overloading">Multiple dispatch (function overloading)<a class="anchor" aria-label="anchor" href="#multiple-dispatch-function-overloading"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="bu">Base</span>.<span class="op">:</span><span class="fu">+</span>(a<span class="op">::</span><span class="dt">Point2</span>, b<span class="op">::</span><span class="dt">Point2</span>) <span class="op">=</span> <span class="fu">Point2</span>(a.x<span class="op">+</span>b.x, a.y<span class="op">+</span>b.y)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">Point2</span>(<span class="fl">1</span>, <span class="fl">2</span>) <span class="op">+</span> <span class="fu">Point2</span>(<span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fu">Point2</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre>
</div>
<div id="oop-sort-of" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="oop-sort-of" class="callout-inner">
<h3 class="callout-title">OOP (Sort of)</h3>
<div class="callout-content">
<p>Julia is not an Object Oriented language. If you feel the unstoppable
urge to implement a class-like abstraction, this can be done through
abstract types.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="kw">abstract type</span> Vehicle <span class="kw">end</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="kw">struct</span> Car <span class="op">&lt;:</span><span class="dt"> Vehicle</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="kw">struct</span> Bike <span class="op">&lt;:</span><span class="dt"> Vehicle</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="kw">function</span> <span class="fu">travel_time</span>(v<span class="op">::</span><span class="dt">Vehicle</span>, distance<span class="op">::</span><span class="dt">Float64</span>)</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="kw">function</span> <span class="fu">fuel_cost</span>(v<span class="op">::</span><span class="dt">Vehicle</span>, <span class="op">::</span><span class="dt">Float64</span>)</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="kw">function</span> <span class="fu">fuel_cost</span>(v<span class="op">::</span><span class="dt">Car</span>, distance<span class="op">::</span><span class="dt">Float64</span>)</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Julia is fundamentally a dynamically typed language.</li>
<li>Static types are only ever used for dispatch.</li>
<li>Multiple dispatch is the most important means of abstraction in
Julia.</li>
<li>Parametric types are important to achieve type stability.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-060-simulating-solar-system"><p>Content from <a href="060-simulating-solar-system.html">Simulating the Solar System</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/060-simulating-solar-system.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I work with physical units?</li>
<li>How do I quickly visualize some data?</li>
<li>How is dispatch used in practice?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Learn to work with <code>Unitful</code>
</li>
<li>Take the first steps with <code>Makie</code> for visualisation</li>
<li>Work with <code>const</code>
</li>
<li>Define a <code>struct</code>
</li>
<li>Get familiar with some idioms in Julia</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In this episode we’ll be building a simulation of the solar system.
That is, we’ll only consider the Sun, Earth and Moon, but feel free to
add other planets to the mix later on! To do this we need to work with
the laws of gravity. We will be going on extreme tangents, exposing
interesting bits of the Julia language as we go.</p>
<section><h2 class="section-heading" id="introduction-to-unitful">Introduction to <code>Unitful</code>
<a class="anchor" aria-label="anchor" href="#introduction-to-unitful"></a>
</h2>
<hr class="half-width">
<p>We’ll be using the <code>Unitful</code> library to ensure that we
don’t mix up physical units.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">Unitful</span></span></code></pre>
</div>
<p>Using <code>Unitful</code> is without any run-time overhead. The unit
information is completely contained in the <code>Quantity</code> type.
With <code>Unitful</code> we can attach units to quantities using the
<code>@u_str</code> syntax:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fl">1.0</span>u<span class="st">"kg"</span> <span class="op">==</span> <span class="fl">1000.0</span>u<span class="st">"g"</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fl">2.0</span>u<span class="st">"m"</span> <span class="op">-</span> <span class="fl">8.0</span>u<span class="st">"cm"</span></span></code></pre>
</div>
<div id="breaking-down-the-syntax" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="breaking-down-the-syntax" class="callout-inner">
<h3 class="callout-title">Breaking down the syntax</h3>
<div class="callout-content">
<p>There is a bit of syntax to break down here. A number followed by an
identifier are multiplied with the <code>*</code> operator. This is just
syntactic sugar, but it makes certain expressions nicer.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">gaussian</span>(μ, σ) <span class="op">=</span> x <span class="op">-&gt;</span> <span class="fl">1</span><span class="op">/</span><span class="fu">√</span>(<span class="fl">2</span>π)σ <span class="op">*</span> <span class="fu">exp</span>(<span class="fu">-</span>(x <span class="op">-</span> μ)<span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fl">2</span>σ<span class="op">^</span><span class="fl">2</span>)</span></code></pre>
</div>
<p>At the same time, there is such a thing as <code>_str</code>
macros.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">macro</span> <span class="fu">twice_str</span>(a)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="op">:</span>(<span class="op">$</span>a <span class="op">*</span> <span class="op">$</span>a)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>twice<span class="st">"Hello"</span></span></code></pre>
</div>
<p>Combining the <code>@u_str</code> macro, which is defined in
<code>Unitful</code>, with the multiplication sugar gets us here:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="pp">@macroexpand</span> <span class="fl">3</span>u<span class="st">"m/s"</span></span></code></pre>
</div>
</div>
</div>
</div>
<div id="try-adding-incompatible-quantities" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="try-adding-incompatible-quantities" class="callout-inner">
<h3 class="callout-title">Try adding incompatible quantities</h3>
<div class="callout-content">
<p>For instance, add a quantity in meters to one in seconds. Be
creative. Can you understand the error messages?</p>
</div>
</div>
</div>
<p>Next to that, we use the <code>Vec3d</code> type from
<code>GeometryBasics</code> to store vector particle positions.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="im">using</span> <span class="bu">GeometryBasics</span></span></code></pre>
</div>
<p>Libraries in Julia tend to work well together, even if they’re not
principally designed to do so. We can combine <code>Vec3d</code> with
<code>Unitful</code> with no problems.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">Vec3d</span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>)u<span class="st">"km"</span></span></code></pre>
</div>
<div id="generate-random-vec3d" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="generate-random-vec3d" class="callout-inner">
<h3 class="callout-title">Generate random Vec3d</h3>
<div class="callout-content">
<p>The <code>Vec3d</code> type is a static 3-vector of double precision
floating point values. Read the documentation on the <a href="https://docs.julialang.org/en/v1/stdlib/Random/#Base.randn" class="external-link"><code>randn</code>
function</a>. Can you figure out a way to generate a random
<code>Vec3d</code>?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>One way is to generate three random numbers and convert the resulting
array to a <code>Vec3d</code>:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">Vec3d</span>(<span class="fu">randn</span>(<span class="dt">Float64</span>, <span class="fl">3</span>))</span></code></pre>
</div>
<p>But it is even better to call <code>randn</code> with the
<code>Vec3d</code> argument directly:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">randn</span>(Vec3d)</span></code></pre>
</div>
<p>(We can time these using <code>@btime</code> from
<code>BenchmarkTools</code>)</p>
</div>
</div>
</div>
</div>
<p>Two bodies of mass <span class="math inline">\(M\)</span> and <span class="math inline">\(m\)</span> attract each other with the force</p>
<p><span class="math display">\[F = \frac{GMm}{r^2},\]</span></p>
<p>where <span class="math inline">\(r\)</span> is the distance between
those bodies, and <span class="math inline">\(G\)</span> is the
universal gravitational constant.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="kw">const</span> G <span class="op">=</span> <span class="fl">6.6743e-11</span>u<span class="st">"m^3*kg^-1*s^-2"</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="fu">gravitational_force</span>(m1, m2, r) <span class="op">=</span> G <span class="op">*</span> m1 <span class="op">*</span> m2 <span class="op">/</span> r<span class="op">^</span><span class="fl">2</span></span></code></pre>
</div>
<p>Verify that the force exerted between two 1 million kg bodies at a
distance of 2.5 meters is about equal to holding a 1kg object on Earth.
Or equivalently two one tonne objects at a distance of 2.5 mm (all of
the one tonne needs to be concentrated in a space tiny enough to get two
of them at that close a distance)</p>
<p>A better way to write the force would be,</p>
<p><span class="math display">\[\vec{F} = \hat{r} \frac{G M
m}{|r|^2},\]</span></p>
<p>where <span class="math inline">\(\hat{r} = \vec{r} / |r|\)</span>,
so in total we get a third power, <span class="math inline">\(|r|^3 =
(r^2)^{3/2}\)</span>, where <span class="math inline">\(r^2\)</span> can
be computed with the dot-product.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="fu">gravitational_force</span>(m1, m2, r<span class="op">::</span><span class="dt">AbstractVector</span>) <span class="op">=</span> r <span class="op">*</span> (G <span class="op">*</span> m1 <span class="op">*</span> m2 <span class="op">*</span> (r <span class="op">⋅</span> r)<span class="op">^</span>(<span class="op">-</span><span class="fl">1.5</span>))</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">gravitational_force</span>(<span class="fl">1e3</span>u<span class="st">"kg"</span>, <span class="fl">1e3</span>u<span class="st">"kg"</span>, <span class="fu">Vec3d</span>(<span class="fl">2.5</span>, <span class="fl">0</span>, <span class="fl">0</span>)u<span class="st">"mm"</span>) <span class="op">.|&gt;</span> u<span class="st">"N"</span></span></code></pre>
</div>
<div id="callout2" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>Not all of you will be jumping up and down for doing high-school
physics. We will get to other sciences than physics later in this
workshop, I promise!</p>
</div>
</div>
</div>
<div id="callout3" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>The <code>⋅</code> operator (enter using
<code>\cdot&lt;TAB&gt;</code>) performs the
<code>LinearAlgebra.dot</code> function. We could have done
<code>sum(r * r)</code>. However, the <code>sum</code> function works on
iterators and has a generic implementation. We could define our own
<code>dot</code> function:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">dot</span>(a<span class="op">::</span><span class="dt">AbstractVector{T}</span>, b<span class="op">::</span><span class="dt">AbstractVector{T}</span>) <span class="kw">where</span> {T}</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    Prod <span class="op">=</span> <span class="fu">typeof</span>(<span class="fu">zero</span>(T) <span class="op">*</span> <span class="fu">zero</span>(T))</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>	x <span class="op">=</span> <span class="fu">zero</span>(Prod)</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>	<span class="pp">@simd</span> ivdep <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(a)</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>		x <span class="op">+=</span> a[i] <span class="op">*</span> b[i]</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>	<span class="cf">end</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>	<span class="cf">return</span> x</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>If we look for the source</p>
<pre><code>@which LinearAlgebra.dot(a, b)</code></pre>
<p>We find that we’re actually running the dot product from the
<code>StaticArrays</code> library, which has a very similar
implementation as ours.</p>
</div>
</div>
</div>
<div id="the-zero-function" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="the-zero-function" class="callout-inner">
<h3 class="callout-title">The <code>zero</code> function</h3>
<div class="callout-content">
<p>The <code>zero</code> function is overloaded to return a zero object
for any type that has a natural definition of zero.</p>
</div>
</div>
</div>
<div id="the-one-function" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="the-one-function" class="callout-inner">
<h3 class="callout-title">The <code>one</code> function</h3>
<div class="callout-content">
<p>The return-value of <code>zero</code> should be the additive identity
of the given type. So for any type <code>T</code>:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="kw">let</span> T <span class="op">=</span> <span class="dt">Int</span>, x <span class="op">=</span> <span class="fu">rand</span>(T); x <span class="op">==</span> x <span class="op">+</span> <span class="fu">zero</span>(T) <span class="kw">end</span></span></code></pre>
</div>
<p>There also is the <code>one</code> function which returns the
multiplicative identity of a given type. Try to use the <code>*</code>
operator on two strings. What do you expect <code>one(String)</code> to
return?</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="particles">Particles<a class="anchor" aria-label="anchor" href="#particles"></a>
</h2>
<hr class="half-width">
<p>We are now ready to define the <code>Particle</code> type.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="im">using</span> <span class="bu">Unitful</span>: Mass, Length, Velocity</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="kw">mutable struct</span> Particle</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>    mass<span class="op">::</span><span class="dt">typeof</span>(<span class="fl">1.0</span>u<span class="st">"kg"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>    position<span class="op">::</span><span class="dt">typeof</span>(<span class="fu">Vec3d</span>(<span class="fl">1</span>)u<span class="st">"m"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>    momentum<span class="op">::</span><span class="dt">typeof</span>(<span class="fu">Vec3d</span>(<span class="fl">1</span>)u<span class="st">"kg*m/s"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="fu">Particle</span>(mass<span class="op">::</span><span class="dt">Mass</span>, position<span class="op">::</span><span class="dt">Vec3{L}</span>, velocity<span class="op">::</span><span class="dt">Vec3{V}</span>) <span class="kw">where</span> {L<span class="op">&lt;:</span><span class="dt">Length</span>,V<span class="op">&lt;:</span><span class="dt">Velocity</span>} <span class="op">=</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>    <span class="fu">Particle</span>(mass, position, velocity <span class="op">*</span> mass)</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="fu">velocity</span>(p<span class="op">::</span><span class="dt">Particle</span>) <span class="op">=</span> p.momentum <span class="op">/</span> p.mass</span></code></pre>
</div>
<p>We store the momentum of the particle, so that what follows is
slightly simplified.</p>
<p>It is custom to divide the computation of orbits into a <em>kick</em>
and <em>drift</em> function. (There are deep mathematical reasons for
this that we won’t get into.) We’ll first implement the
<code>kick!</code> function, that updates a collection of particles,
given a certain time step.</p>
</section><section><h2 class="section-heading" id="the-kick">The kick<a class="anchor" aria-label="anchor" href="#the-kick"></a>
</h2>
<hr class="half-width">
<p>The following function performs the <code>kick!</code> operation on a
set of particles. We’ll go on a little tangent for every line in the
function.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">kick!</span>(particles, dt)</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(particles)</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>(i<span class="op">-</span><span class="fl">1</span>)</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>            r <span class="op">=</span> particles[j].position <span class="op">-</span> particles[i].position</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>            force <span class="op">=</span> <span class="fu">gravitational_force</span>(particles[i].mass, particles[j].mass, r)</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>            particles[i].momentum <span class="op">+=</span> dt <span class="op">*</span> force</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>            particles[j].momentum <span class="op">-=</span> dt <span class="op">*</span> force</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>    <span class="cf">return</span> particles</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div id="why-the-exclamation-mark" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="why-the-exclamation-mark" class="callout-inner">
<h3 class="callout-title">Why the <code>!</code> exclamation mark?</h3>
<div class="callout-content">
<p>In Julia it is custom to have an exclamation mark at the end of names
of functions that mutate their arguments.</p>
</div>
</div>
</div>
<div id="use-eachindex" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="use-eachindex" class="callout-inner">
<h3 class="callout-title">Use <code>eachindex</code>
</h3>
<div class="callout-content">
<p>Note the way we used <code>eachindex</code>. This idiom guarantees
that we can’t make out-of-bounds errors. Also this kind of indexing is
generic over other collections than vectors. However, this is
immediately destroyed by our next loop.</p>
</div>
</div>
</div>
<div id="broadcasting-vs.-specialization" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="broadcasting-vs.-specialization" class="callout-inner">
<h3 class="callout-title">Broadcasting vs. specialization</h3>
<div class="callout-content">
<p>We’re subtracting two vectors. We could have written that with
dot-notation indicating a broadcasted function application. Generate two
random numbers:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>a, b <span class="op">=</span> <span class="fu">randn</span>(Vec3d, <span class="fl">2</span>)</span></code></pre>
</div>
<p>Then time the subtraction broadcasted and non-broadcasted. Which is
faster? Why?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="pp">@btime</span> a <span class="op">-</span> b</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="pp">@btime</span> a <span class="op">.-</span> b</span></code></pre>
</div>
<p>Broadcasting is slower. It seems to do some needless allocation.
Clearly, the authors of <code>GeometryBasics</code> have taken effort to
optimize basic vector operations.</p>
</div>
</div>
</div>
</div>
<div id="callout7" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>We’re iterating over the range <code>1:(i-1)</code>, and so we don’t
compute forces twice. Momentum should be conserved!</p>
</div>
</div>
</div>
<p>Luckily the <code>drift!</code> function is much easier to implement,
and doesn’t require that we know about all particles.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">drift!</span>(p<span class="op">::</span><span class="dt">Particle</span>, dt)</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>    p.position <span class="op">+=</span> dt <span class="op">*</span> p.momentum <span class="op">/</span> p.mass</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="kw">function</span> <span class="fu">drift!</span>(particles, dt)</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> <span class="fu">values</span>(particles)</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>        <span class="fu">drift!</span>(p, dt)</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>    <span class="cf">return</span> particles</span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>Note that we defined the <code>drift!</code> function twice, for
different arguments. We’re using the dispatch mechanism to write
clean/readable code.</p>
<div class="section level3">
<h3 id="fixing-arguments">Fixing arguments<a class="anchor" aria-label="anchor" href="#fixing-arguments"></a>
</h3>
<p>One pattern that you can find repeatedly in the standard library is
that of <em>fixing</em> arguments of functions to make them more
composable. For instance, most comparison operators allow you to give a
single argument, saving the second argument for a second invocation.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="fu">filter</span>(x <span class="op">-&gt;</span> x <span class="op">&lt;</span> <span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>)</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="fu">filter</span>(<span class="fu">&lt;</span>(<span class="fl">3</span>), <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>)</span></code></pre>
</div>
<p>and even</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">map</span>(<span class="fu">filter</span>(<span class="fu">&lt;</span>(<span class="fl">5</span>)), <span class="fu">eachcol</span>(<span class="fu">rand</span>(<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">5</span>)))</span></code></pre>
</div>
<p>We can do a similar thing here:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="fu">kick!</span>(dt) <span class="op">=</span> <span class="bu">Base</span>.<span class="fu">Fix2</span>(kick!, dt)</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="fu">drift!</span>(dt) <span class="op">=</span> <span class="bu">Base</span>.<span class="fu">Fix2</span>(drift!, dt)</span></code></pre>
</div>
<p>These kinds of identities let us be flexible in how to use and
combine methods in different circumstances.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="fu">leap_frog!</span>(dt) <span class="op">=</span> <span class="fu">drift!</span>(dt) <span class="op">∘</span> <span class="fu">kick!</span>(dt)</span></code></pre>
</div>
<p>This defines the <code>leap_frog!</code> function as first performing
a <code>kick!</code> and then a <code>drift!</code>. Another way to
compose these functions is the <code>|&gt;</code> operator. In contrast
to the <code>∘</code> operator, <code>|&gt;</code> is very popular and
seen everywhere in Julia code bases.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="fu">leap_frog!</span>(particles, dt) <span class="op">=</span> particles <span class="op">|&gt;</span> <span class="fu">kick!</span>(dt) <span class="op">|&gt;</span> <span class="fu">drift!</span>(dt)</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="fu">leap_frog!</span>(dt) <span class="op">=</span> <span class="bu">Base</span>.<span class="fu">Fix2</span>(leap_frog!, dt)</span></code></pre>
</div>
</div>
</section><section><h2 class="section-heading" id="with-random-particles">With random particles<a class="anchor" aria-label="anchor" href="#with-random-particles"></a>
</h2>
<hr class="half-width">
<p>Let’s run a simulation with some random particles</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">run_simulation</span>(particles, dt, n)</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>    result <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{typeof(Vec3d(1)u"m")}</span>(<span class="cn">undef</span>, n, <span class="fu">length</span>(particles))</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>    x <span class="op">=</span> <span class="fu">deepcopy</span>(particles)</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>    <span class="cf">for</span> c <span class="kw">in</span> <span class="fu">eachrow</span>(result)</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a>        x <span class="op">=</span> <span class="fu">leap_frog!</span>(dt)(x)</span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a>        c[<span class="op">:</span>] <span class="op">=</span> [p.position for p <span class="kw">in</span> <span class="fu">values</span>(x)]</span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a>    <span class="fu">DataFrame</span>(<span class="op">:</span>time <span class="op">=&gt;</span> (<span class="fl">1</span><span class="op">:</span>n)dt, (<span class="fu">Symbol</span>.(<span class="st">"p"</span>, <span class="fu">keys</span>(particles)) <span class="op">.=&gt;</span> <span class="fu">eachcol</span>(result))<span class="op">...</span>)</span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="frame-of-reference">Frame of reference<a class="anchor" aria-label="anchor" href="#frame-of-reference"></a>
</h3>
<p>We need to make sure that our entire system doesn’t have a net
velocity. Otherwise it will be hard to visualize our results!</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">set_still!</span>(particles)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>    total_momentum <span class="op">=</span> <span class="fu">sum</span>(p.momentum <span class="cf">for</span> p <span class="kw">in</span> <span class="fu">values</span>(particles))</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>    total_mass <span class="op">=</span> <span class="fu">sum</span>(p.mass <span class="cf">for</span> p <span class="kw">in</span> <span class="fu">values</span>(particles))</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>    correction <span class="op">=</span> total_momentum <span class="op">/</span> total_mass</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> <span class="fu">values</span>(particles)</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>        p.momentum <span class="op">-=</span> correction <span class="op">*</span> p.mass</span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>    <span class="cf">return</span> particles</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a><span class="cf">end</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="plotting">Plotting<a class="anchor" aria-label="anchor" href="#plotting"></a>
</h3>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_orbits</span>(orbits<span class="op">::</span><span class="dt">DataFrame</span>)</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>()</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis3</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>], limits<span class="op">=</span>((<span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span>), (<span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span>), (<span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span>)))</span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>    <span class="cf">for</span> colname <span class="kw">in</span> <span class="fu">names</span>(orbits)[<span class="fl">2</span><span class="op">:</span><span class="kw">end</span>]</span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>        <span class="fu">scatter!</span>(ax, [orbits[<span class="fl">1</span>, colname] <span class="op">/</span> u<span class="st">"m"</span>])</span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>        <span class="fu">lines!</span>(ax, orbits[!, colname] <span class="op">/</span> u<span class="st">"m"</span>)</span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a>    fig</span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>Try a few times with two random particles. You may want to use the
<code>set_still!</code> function to negate any collective motion.</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">random_orbits</span>(n, mass)</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>    <span class="fu">random_particle</span>() <span class="op">=</span> <span class="fu">Particle</span>(mass, <span class="fu">randn</span>(Vec3d)u<span class="st">"m"</span>, <span class="fu">randn</span>(Vec3d)u<span class="st">"mm/s"</span>)</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>    particles <span class="op">=</span> <span class="fu">set_still!</span>([<span class="fu">random_particle</span>() for _ <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n])</span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>    <span class="fu">run_simulation</span>(particles, <span class="fl">1.0</span>u<span class="st">"s"</span>, <span class="fl">5000</span>)</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="fu">random_orbits</span>(<span class="fl">3</span>, <span class="fl">1e6</span>u<span class="st">"kg"</span>) <span class="op">|&gt;</span> plot_orbits</span></code></pre>
</div>
<figure><img src="fig/random-orbits.png" alt="the three-body problem" class="figure mx-auto d-block"><div class="figcaption">Possible random orbits for two and three
particles.</div>
</figure>
</div>
</section><section><h2 class="section-heading" id="solar-system">Solar System<a class="anchor" aria-label="anchor" href="#solar-system"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="co">#| id: gravity</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="kw">const</span> SUN <span class="op">=</span> <span class="fu">Particle</span>(<span class="fl">2e30</span>u<span class="st">"kg"</span>,</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>    <span class="fu">Vec3d</span>(<span class="fl">0.0</span>)u<span class="st">"m"</span>,</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>    <span class="fu">Vec3d</span>(<span class="fl">0.0</span>)u<span class="st">"m/s"</span>)</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a><span class="kw">const</span> EARTH <span class="op">=</span> <span class="fu">Particle</span>(<span class="fl">6e24</span>u<span class="st">"kg"</span>,</span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a>    <span class="fu">Vec3d</span>(<span class="fl">1.5e11</span>, <span class="fl">0</span>, <span class="fl">0</span>)u<span class="st">"m"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>    <span class="fu">Vec3d</span>(<span class="fl">0</span>, <span class="fl">3e4</span>, <span class="fl">0</span>)u<span class="st">"m/s"</span>)</span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a><span class="kw">const</span> MOON <span class="op">=</span> <span class="fu">Particle</span>(<span class="fl">7.35e22</span>u<span class="st">"kg"</span>,</span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a>    EARTH.position <span class="op">+</span> <span class="fu">Vec3d</span>(<span class="fl">3.844e8</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>)u<span class="st">"m"</span>,</span>
<span id="cb32-12"><a href="#cb32-12" tabindex="-1"></a>    <span class="fu">velocity</span>(EARTH) <span class="op">+</span> <span class="fu">Vec3d</span>(<span class="fl">0</span>, <span class="fl">1e3</span>, <span class="fl">0</span>)u<span class="st">"m/s"</span>)</span></code></pre>
</div>
<div id="challenge" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="challenge" class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Plot the orbit of the moon around the earth. Make a
<code>Dataframe</code> that contains all model data, and work from
there. Can you figure out the period of the orbit?</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>standard functions like <code>rand</code>, <code>zero</code> and
operators can be extended by libraries to work with new types</li>
<li>functions (not objects) are central to programming Julia</li>
<li>don’t over-specify argument types: Julia is dynamically typed,
embrace it</li>
</ul>
</div>
</div>
</div>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Testing and Plots </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler1" aria-labelledby="headingSpoiler1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="co">#| file: src/Gravity.jl</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a><span class="kw">module</span> Gravity</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a><span class="im">using</span> <span class="bu">Unitful</span></span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a><span class="im">using</span> <span class="bu">GeometryBasics</span></span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span></span>
<span id="cb33-8"><a href="#cb33-8" tabindex="-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span></span>
<span id="cb33-9"><a href="#cb33-9" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" tabindex="-1"></a><span class="op">&lt;&lt;</span>gravity<span class="op">&gt;&gt;</span></span>
<span id="cb33-11"><a href="#cb33-11" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="co">#| classes: ["task"]</span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="co">#| creates: episodes/fig/random-orbits.png</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="co">#| collect: figures</span></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a><span class="kw">module</span> Script</span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a><span class="im">using</span> <span class="bu">Unitful</span></span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span></span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span></span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a><span class="im">using</span> <span class="bu">EfficientJulia.Gravity</span>: random_orbits</span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_orbits!</span>(ax, orbits<span class="op">::</span><span class="dt">DataFrame</span>)</span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a>    <span class="cf">for</span> colname <span class="kw">in</span> <span class="fu">names</span>(orbits)[<span class="fl">2</span><span class="op">:</span><span class="kw">end</span>]</span>
<span id="cb34-15"><a href="#cb34-15" tabindex="-1"></a>        <span class="fu">scatter!</span>(ax, [orbits[<span class="fl">1</span>,colname] <span class="op">/</span> u<span class="st">"m"</span>])</span>
<span id="cb34-16"><a href="#cb34-16" tabindex="-1"></a>        <span class="fu">lines!</span>(ax, orbits[!,colname] <span class="op">/</span> u<span class="st">"m"</span>)</span>
<span id="cb34-17"><a href="#cb34-17" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb34-18"><a href="#cb34-18" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb34-19"><a href="#cb34-19" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" tabindex="-1"></a><span class="kw">function</span> <span class="fu">main</span>()</span>
<span id="cb34-21"><a href="#cb34-21" tabindex="-1"></a>    <span class="bu">Random</span>.<span class="fu">seed!</span>(<span class="fl">0</span>)</span>
<span id="cb34-22"><a href="#cb34-22" tabindex="-1"></a>    orbs1 <span class="op">=</span> <span class="fu">random_orbits</span>(<span class="fl">2</span>, <span class="fl">1e6</span>u<span class="st">"kg"</span>)</span>
<span id="cb34-23"><a href="#cb34-23" tabindex="-1"></a>    <span class="bu">Random</span>.<span class="fu">seed!</span>(<span class="fl">15</span>)</span>
<span id="cb34-24"><a href="#cb34-24" tabindex="-1"></a>    orbs2 <span class="op">=</span> <span class="fu">random_orbits</span>(<span class="fl">3</span>, <span class="fl">1e6</span>u<span class="st">"kg"</span>)</span>
<span id="cb34-25"><a href="#cb34-25" tabindex="-1"></a></span>
<span id="cb34-26"><a href="#cb34-26" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size<span class="op">=</span>(<span class="fl">1024</span>, <span class="fl">600</span>))</span>
<span id="cb34-27"><a href="#cb34-27" tabindex="-1"></a>    ax1 <span class="op">=</span> <span class="fu">Axis3</span>(fig[<span class="fl">1</span>,<span class="fl">1</span>], azimuth<span class="op">=</span><span class="cn">π</span><span class="op">/</span><span class="fl">2</span><span class="op">+</span><span class="fl">0.1</span>, elevation<span class="op">=</span><span class="fl">0.1</span>π, title<span class="op">=</span><span class="st">"two particles"</span>)</span>
<span id="cb34-28"><a href="#cb34-28" tabindex="-1"></a>    ax2 <span class="op">=</span> <span class="fu">Axis3</span>(fig[<span class="fl">1</span>,<span class="fl">2</span>], azimuth<span class="op">=</span><span class="cn">π</span><span class="op">/</span><span class="fl">3</span>, title<span class="op">=</span><span class="st">"three particles"</span>)</span>
<span id="cb34-29"><a href="#cb34-29" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" tabindex="-1"></a>    <span class="fu">plot_orbits!</span>(ax1, orbs1)</span>
<span id="cb34-31"><a href="#cb34-31" tabindex="-1"></a>    <span class="fu">plot_orbits!</span>(ax2, orbs2)</span>
<span id="cb34-32"><a href="#cb34-32" tabindex="-1"></a></span>
<span id="cb34-33"><a href="#cb34-33" tabindex="-1"></a>    <span class="fu">save</span>(<span class="st">"episodes/fig/random-orbits.png"</span>, fig)</span>
<span id="cb34-34"><a href="#cb34-34" tabindex="-1"></a>    fig</span>
<span id="cb34-35"><a href="#cb34-35" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb34-36"><a href="#cb34-36" tabindex="-1"></a></span>
<span id="cb34-37"><a href="#cb34-37" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb34-38"><a href="#cb34-38" tabindex="-1"></a></span>
<span id="cb34-39"><a href="#cb34-39" tabindex="-1"></a>Script.<span class="fu">main</span>()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-070-pkg"><p>Content from <a href="070-pkg.html">Packages and environments</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/070-pkg.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I work with environments?</li>
<li>What are these <code>Project.toml</code> and
<code>Manifest.toml</code> files?</li>
<li>How do I install more dependencies?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>pkg&gt; status</li>
<li>pkg&gt; add (in more details)</li>
<li>pkg&gt; remove</li>
<li>Project.toml</li>
<li>Manifest.toml</li>
<li>pkg&gt; instantiate</li>
<li>pkg&gt; activate</li>
<li>pkg&gt; activate –temp</li>
<li>pkg&gt; activate <span class="citation">@place</span>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In general software development, it often makes sense to make use of
existing packages rather than implementing everything yourself. The
Julia world is no different, and provides a standard way to manage this,
via the <code>Pkg</code> system.</p>
<p>In the following, we will explore using the Julia REPL to set up a
project and manage adding dependencies.</p>
<section><h2 class="section-heading" id="make-a-new-project">Make a new project<a class="anchor" aria-label="anchor" href="#make-a-new-project"></a>
</h2>
<hr class="half-width">
<p>We will first make a directory and move to it:</p>
<pre class="shell"><code>mkdir Dummy
cd Dummy</code></pre>
<p>We open the Julia REPL and enter <code>pkg</code> mode by pressing
<code>]</code>:</p>
<pre class="shell"><code>julia
julia&gt; # press ]
pkg&gt;</code></pre>
<p>In this mode, we can run a variety of commands for managing our
project’s dependencies.</p>
<p>First we will use <code>pkg&gt; status</code> to check what the
current situation is, according to Julia:</p>
<pre class="shell"><code><span><span class="va">pkg</span><span class="op">&gt;</span> <span class="va">status</span></span></code></pre>
<p>The output gives us details about the current environment we are
using. There will be a list of any dependencies that have been
installed, and their versions.</p>
<p>The first line of output may look something like this:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Status `~/.julia/environments/v1.11/Project.toml`</code></pre>
</div>
<p>This shows the path to the current environment definition, which is
in a file called <code>Project.toml</code> (we will discuss this later).
From the path we see that this is the default environment for our
version of Julia (in the above case, <code>v1.11</code>). This is the
environment that will be used unless the user specifies a different
one.</p>
<p>In practice, we generally make specific environments for specific
projects. This avoids issues of multiple/clashing versions of
dependencies, removes unused dependencies (keeping the project
environemtn clean) and allows you to easily publish your project as a
package, if desired.</p>
<p>Therefore, let us indicate to Julia that we wish to use an
environment for our <code>Dummy</code> project. We do this using the
<code>pkg&gt; activate</code> command:</p>
<pre class="shell"><code>pkg&gt; activate .</code></pre>
<p>Note that the <code>.</code> is important here, as we are supplying a
path as an argument to <code>activate</code>. This tells Julia that we
want to use the current (<code>./</code>) directory as a location for a
project. Julia will confirm that you are activating a new project at
your current location (the <code>Dummy/</code> directory).</p>
<p>As before, we can use <code>pkg&gt; status</code> at any time to
check what environment we are in:</p>
<pre class="shell"><code><span><span class="va">pkg</span><span class="op">&gt;</span> <span class="va">status</span></span></code></pre>
<p>This will now output “Status” followed by a path to the
<code>Dummy/</code> directory. This indicates that we have successfully
begun working in an environment based there.</p>
<p>The output also indicates that this is an
<code>(empty project)</code>. This is because we have not added any
dependencies yet.</p>
</section><section><h2 class="section-heading" id="adding-dependencies-to-your-project">Adding dependencies to your project<a class="anchor" aria-label="anchor" href="#adding-dependencies-to-your-project"></a>
</h2>
<hr class="half-width">
<p>If we wish to use functionality of another package in our code, we
can add it as a dependency of our project. For example, let us say we
wish to add Julia’s <code>Random</code> package as a dependency. We can
do this using <code>pkg&gt; add</code>:</p>
<pre class="shell"><code>pkg&gt; add Random</code></pre>
<p>Julia will now download a version of this package and pre-compile
it.</p>
<pre class="shell"><code><span><span class="va">pkg</span><span class="op">&gt;</span> <span class="va">status</span></span></code></pre>
<p>Running <code>pkg&gt; status</code> now will list ‘Random’ as a
dependency, instead of showing “(empty project)” as it did before.</p>
<p>You may notice that a line in the output also indicates that a
<code>Project.toml</code> file has been updated.</p>
</section><section><h2 class="section-heading" id="project-toml-and-manifest-toml">
<code>Project.toml</code> and <code>Manifest.toml</code>
<a class="anchor" aria-label="anchor" href="#project-toml-and-manifest-toml"></a>
</h2>
<hr class="half-width">
<p>Looking in the previously empty <code>Dummy/</code> directory, you
should now see the appearance of two files: <code>Project.toml</code>
and <code>Manifest.toml</code>.</p>
<p>From the terminal, you can open these in your currently running
vscode window using <code>code -r</code>:</p>
<pre class="shell"><code>code -r Project.toml</code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[deps]
Random = "9a3f8284-a2c9-5f02-9a11-845980a1fd5c"</code></pre>
</div>
<p>Inspecting <code>Project.toml</code>, we see that it has a
<code>[deps]</code> section, which stands for “dependencies”. There is a
single dependency, <code>Random</code>, along with a long string of
letters and numbers. This is the Universally Unique Identifier (UUID) of
the package. This will be covered in a later episode.</p>
<p>Next, we inspect <code>Manifest.toml</code>.</p>
<pre class="shell"><code>code -r Manifest.toml</code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># This file is machine-generated - editing it directly is not advised

julia_version = "1.11.3"
manifest_format = "2.0"
project_hash = "fa3e19418881bf344f5796e1504923a7c80ab1ed"

[[deps.Random]]
deps = ["SHA"]
uuid = "9a3f8284-a2c9-5f02-9a11-845980a1fd5c"
version = "1.11.0"

[[deps.SHA]]
uuid = "ea8e919c-243c-51af-8825-aaa63cd721ce"
version = "0.7.0"</code></pre>
</div>
<p>Initially, we see that it contains some information that is similar
to the contents of <code>Project.toml</code>. We see the
<code>Random</code> package we added earlier, and its UUID, but now also
a specific version for that package. We also a dependency of the
<code>Random</code> package itself.</p>
<p>So both <code>Project.toml</code> and <code>Manifest.toml</code>
appear to specify the dependencies of the project. Generally speaking,
dependencies may have many versions which may be acceptable
(compatible). <code>Project.toml</code> gives the requirements of the
project on a comparatively high-level, whereas
<code>Manifest.toml</code> specifies exact versions for each dependency,
as well as a hash of the entire project. Therefore,
<code>Manifest.toml</code> specifies a particular working installation
of the package. For most projects, many <code>Manifest.toml</code>
configurations could be possible.</p>
<p>Note: As the comment at the top of <code>Manifest.toml</code> states,
the file is automatically generated and should generally not be edited
directly.</p>
<div class="section level3">
<h3 id="removing-dependencies">Removing dependencies<a class="anchor" aria-label="anchor" href="#removing-dependencies"></a>
</h3>
<p>If a dependency was added by mistake, or if we no longer need it, we
may wish to remove it. In our case, we only added the
<code>Random</code> package as an example - we have no plans to use it.
So let’s remove it as a dependency.</p>
<pre class="shell"><code>pkg&gt; remove Random</code></pre>
<p>If we check <code>pkg&gt; status</code> again, we see that we have
returned to the “(empty project)” state. Similarly, looking inside
<code>Project.toml</code> we see that the dependency has indeed
disappeared from the project.</p>
<pre class="shell"><code><span><span class="va">pkg</span><span class="op">&gt;</span> <span class="va">status</span></span></code></pre>
<div id="add-and-remove-the-dates-package-3-min" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="add-and-remove-the-dates-package-3-min" class="callout-inner">
<h3 class="callout-title">Add and remove the Dates package (3 min)</h3>
<div class="callout-content">
<p>There is a <code>Dates</code> standard Julia package. Try adding this
as a dependency, then check <code>Project.toml</code> and
<code>Manifest.toml</code> to see what has changed.</p>
<p>Then remove the <code>Dates</code> dependency when you are done.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<pre class="shell"><code>pkg&gt; add Dates
pkg&gt; status
pkg&gt; code -r Project.toml Manifest.toml
pkg&gt; remove Dates</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="activating-the-default-environment-again">Activating the default environment again<a class="anchor" aria-label="anchor" href="#activating-the-default-environment-again"></a>
</h3>
<p>Sometimes you may wish to return to using the default environment for
your Julia version.</p>
<p>If your version is e.g. <code>1.11</code> then the command would look
like:</p>
<pre class="shell"><code><span><span class="va">pkg</span><span class="op">&gt;</span> <span class="va">activate</span> <span class="op">@</span><span class="va">v1.11</span></span></code></pre>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>Note the <code>@</code> symbol before the environment name. This
tells us that it is a “shared” environment. That means it can be loaded
by name (i.e. without specifying the path to the
<code>Project.toml</code> file explicitly. You can make your own shared
environments for various reasons but that is beyond the scope of the
present lesson.</p>
</div>
</div>
</div>
<p>You can also simply type <code>activate</code> with no arguments and
Julia will also return to the default environment.</p>
</div>
<div class="section level3">
<h3 id="temporary-environments">Temporary environments<a class="anchor" aria-label="anchor" href="#temporary-environments"></a>
</h3>
<p>In some cases, you may wish to work with a “throwaway” environment -
one in which you can add dependencies without it affecting your current
project.</p>
<p>You can do this using <code>pkg&gt; activate --temp</code>:</p>
<pre class="shell"><code><span><span class="va">pkg</span><span class="op">&gt;</span> <span class="va">activate</span> <span class="op">-</span><span class="op">-</span><span class="va">temp</span></span></code></pre>
<p>This will output something like
<code>Activating new project at</code>/tmp/jl_4xvh88`.</p>
<p>You can now work with this as with any other environment, but without
the fear that changes you make are messing up the
<code>Project.toml</code> of the project you are working on.</p>
<p>As an example, let’s add the <code>Random</code> package again.</p>
<pre class="shell"><code>pkg&gt; status
pkg&gt; add Random
pkg&gt; status</code></pre>
<p>We see that <code>Random</code> is installed in our temporary
environment.</p>
<p>We can now exit the Julia REPL and open our <code>Project.toml</code>
file as before:</p>
<pre class="shell"><code>code -r Project.toml</code></pre>
<p>We see that this is empty (no dependencies), confirming that the
project has not been affected by changes made to the temp
environment.</p>
</div>
<div class="section level3">
<h3 id="using-another-project">Using another project<a class="anchor" aria-label="anchor" href="#using-another-project"></a>
</h3>
<p>Simply activating a project does not actually make Julia download and
install any dependencies that may be listed in <code>Project.toml</code>
(and <code>Manifest.toml</code>) but are missing on your machine.</p>
<p>You may have this sitation if someone you are developing with has
added a new dependency to the package, or shared their
<code>Manifest.toml</code> with you.</p>
<p>In such a case, you can make Julia fetch and install any dependencies
you need using the <code>pkg&gt; instantiate</code> command, to install
exactly the packages specified in the <code>Manifest.toml</code>.</p>
<pre class="shell"><code><span><span class="va">pkg</span><span class="op">&gt;</span> <span class="va">instantiate</span></span></code></pre>
<p><code>pkg&gt; instantiate</code> will not do anything if you already
have everything you need, so it is safe to use.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Julia has a built-in package manager called <code>Pkg</code>.</li>
<li>The package manager is usually accessed from the REPL, by pressing
<code>]</code>.</li>
<li>
<code>Project.toml</code> lists the dependencies of a package.</li>
<li>
<code>Manifest.toml</code> specifies a completely reproducible
environment with exact versions.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-080-package-development"><p>Content from <a href="080-package-development.html">Package development</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/080-package-development.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I generate a new Julia package that follows best
practices?</li>
<li>What is the best workflow for developing a Julia package?</li>
<li>How can I prevent having to recompile every time I make a
change?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Quick start with using the BestieTemplate to generate a package</li>
<li>Basic structure of a package</li>
<li>Revise.jl</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>We will use a Julia template called <code>BestieTemplate</code>. The
template code can be found on <code>GitHub</code>: <a href="https://github.com/JuliaBesties/BestieTemplate.jl" class="external-link uri">https://github.com/JuliaBesties/BestieTemplate.jl</a>.</p>
<p>Using the template automates the process of setting up the Julia
package structure and adding all the small files and tools to help with
applying best practices.</p>
<section><h2 class="section-heading" id="installing-bestietemplate-jl">Installing <code>BestieTemplate.jl</code>
<a class="anchor" aria-label="anchor" href="#installing-bestietemplate-jl"></a>
</h2>
<hr class="half-width">
<p>In order to use <code>BestieTemplate</code> to create our new
package, we first need to install it.</p>
<p>Open the <code>Julia</code> interpreter and enter <code>pkg</code>
mode by pressing <code>]</code>. Then use <code>add</code> as we have
done in previous exercises:</p>
<pre class="shell"><code>julia&gt; # press ]
pkg&gt; add BestieTemplate</code></pre>
<p>This might take a couple of minutes to download.</p>
</section><section><h2 class="section-heading" id="generating-a-fresh-new-julia-package">Generating a fresh new Julia package<a class="anchor" aria-label="anchor" href="#generating-a-fresh-new-julia-package"></a>
</h2>
<hr class="half-width">
<p>We then use the <code>BestieTemplate</code> package to generate a new
(empty) package at the specified path.</p>
<pre class="shell"><code>pkg&gt; # Press backspace to get out of pkg mode
julia&gt; using BestieTemplate
julia&gt; BestieTemplate.generate("MyPackage.jl")</code></pre>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>It is actually posible to apply this template to existing packages
too:</p>
<pre class="shell"><code><span><span class="fu">BestieTemplate.apply</span><span class="op">(</span><span class="st">"path/to/YourExistingPackage.jl"</span><span class="op">)</span></span></code></pre>
<p>However, for clarity we generate a completely new package in this
lesson.</p>
</div>
</div>
</div>
<p>You will now be presented with a series of questions, some required
and some optional.</p>
<ol style="list-style-type: decimal">
<li><p>Firstly you will be asked to choose a universally unique
identifier (UUID) for the new package. This is a label to uniquely
identify your package, thus avoiding relying on the package name
(identically named packages are fairly likely to occur in a programming
community). Luckily, <code>BestieTemplate</code> has auto-generated one
for you. Press enter to select it.</p></li>
<li><p>Type in your GitHub username, if you have one. If you don’t, then
make one up as it does not really matter for this example. This allows
BestieTemplate.jl to correctly generate URLs to your (potential) package
repository (Julia typically expects packages to be on GitHub)</p></li>
<li><p>Add the comma separated list of authors. You can type your own
name and email here.</p></li>
<li><p>Add the minimum Julia version that will be supported by your new
package. BestieTemplate automatically suggests the latest Long Term
Support (LTS) version, so we will press enter to use that one.</p></li>
<li><p>Choose a license for your package. This is up to the user. Use
the arrow keys to select e.g. <code>Apache-2.0</code>.</p></li>
<li><p>Add the names of the copyright holders - again, this should be
pre-filled with the name you typed earlier.</p></li>
</ol>
<p>You will then be provided with the option to only answer a small
number of ‘Recommended’ questions (first choice). Select this and choose
the default (pre-filled) values for each.</p>
<p>Your new package structure will now be created, with configuration
files set up according to the answers provided to the previous
questions.</p>
</section><section><h2 class="section-heading" id="structure-of-your-new-empty-package">Structure of your new (empty) package<a class="anchor" aria-label="anchor" href="#structure-of-your-new-empty-package"></a>
</h2>
<hr class="half-width">
<ul>
<li><p><code>.copier-answers.yml</code> Here you can see the answers you
provided when setting up your package with the
<code>BestieTemplate</code>.</p></li>
<li><p><code>Project.toml</code> The <code>Project.toml</code> file
specifies the name of our package, UUID and authors (as given in our
answers when setting up the template). It also specifies the package’s
current version and dependencies.</p></li>
<li><p><code>README.md</code> Standard place to document the purpose of
the package, installation instructions, links to more extensive
documentation etc.</p></li>
<li><p><code>CODE_OF_CONDUCT.md</code> A clear description about how
contributors are expected to behave and what processes are available in
the event of a breach of conduct.</p></li>
<li><p><code>LICENSE</code> Contains the text for the software license
you chose for this package.</p></li>
<li><p><code>CITATION.cff</code> Stores any authors or contributors to
the package, allowing the software itself to be citable.</p></li>
<li><p>Formatting tool configuration files:
<code>.JuliaFormatter.toml</code>, <code>.pre-commit-config.yaml</code>,
<code>.yamllint.yml</code>, <code>.markdownlint.json</code> These
configure the behaviour of linters and other code-style enforcement
tools. They are important for keeping a clean and tidy code
base.</p></li>
<li><p><code>src/</code> The location of source code files.</p></li>
<li><p><code>test/</code> The location of unit tests for the code in
this package.</p></li>
<li><p><code>docs/</code> The location of scripts for automatically
building documentation for the functions in your package (e.g. based on
docstrings). In the <code>docs/src/</code> directory you can also see
some documentation pages explaining how to contribute to the
package.</p></li>
<li><p><code>.github/</code> This will only come into use if you push
your package to GitHub. This directory contains some automated workflows
that do things like run tests, build documentation etc.</p></li>
</ul>
<div class="section level3">
<h3 id="activating-the-generated-package">Activating the generated package<a class="anchor" aria-label="anchor" href="#activating-the-generated-package"></a>
</h3>
<p>Now that we have generated our new package and inspected its contents
and structure, we would like to use it.</p>
<p>In the shell, let’s enter the the directory of the new package, and
open the <code>Julia</code> REPL:</p>
<pre class="shell"><code>cd MyPackage.jl/
julia</code></pre>
<p>We will start by checking what environment we are actually currently
using. We do this with the <code>pkg&gt; status</code> command:</p>
<pre class="shell"><code>julia&gt; # press ]
pkg&gt; status</code></pre>
<p>The output will show something like the following:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Status `~/.julia/environments/v1.11/Project.toml`</code></pre>
</div>
<p>This tells us that we are currently using the base environment for
the currently installed <code>Julia</code> version (in the above case,
<code>v1.11</code>. In a sense, you can think of this as the “default”
or “global” environment used by <code>Julia</code>, if no other has been
specified by the user.</p>
<p>The output of <code>pkg&gt; status</code> will also output the
dependencies (and precise versions) that are currently installed in that
environment. For example, you should see the <code>BestieTemplate</code>
package that we installed earlier to generate our new package.</p>
<p>But we don’t currently want this environment. We would like to use,
and work on, our new project. We do this by “activating” it:</p>
<pre class="shell"><code>pkg&gt; activate .</code></pre>
<p>Now let us check the <code>pkg</code> status again:</p>
<pre class="shell"><code><span><span class="va">pkg</span><span class="op">&gt;</span> <span class="va">status</span></span></code></pre>
<p>The output should now show <code>Project MyPackage v0.1.0</code>,
indicating that we are indeed using our new package. The “Status” line
will also now give the path to the <code>MyPackage.jl</code>’s
<code>Project.toml</code>, which is another sign that everything is in
order. However, the end of the line will say
<code>(empty project)</code>, because there are currently no
dependencies of our package.</p>
</div>
<div class="section level3">
<h3 id="adding-dependencies">Adding dependencies<a class="anchor" aria-label="anchor" href="#adding-dependencies"></a>
</h3>
<p>As before, we can try adding the <code>Random</code> package.</p>
<pre class="shell"><code>pkg&gt; add Random</code></pre>
<p>Checking the new contents of <code>Project.toml</code>, we see that a
<code>[deps]</code> section has appeared:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[deps]
Random = "9a3f8284-a2c9-5f02-9a11-845980a1fd5c"</code></pre>
</div>
<p>This shows that the <code>Random</code> package is a dependency of
our package, and also specifies the UUID that precisely identifies the
package. Remember that our package, <code>MyPackage.jl</code> also has
such a UUID.</p>
<p>Running <code>pkg&gt; status</code> again will now also list this
dependency, instead of “(empty project)”.</p>
<p>You should now see that a <code>Manifest.toml</code> file is also in
the package directory. In this file, you should see something like the
following:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># This file is machine-generated - editing it directly is not advised

julia_version = "1.11.3"
manifest_format = "2.0"
project_hash = "edf6df7b02a39be5254eb0c7ce37b253a09a1e4c"

[[deps.Random]]
deps = ["SHA"]
uuid = "9a3f8284-a2c9-5f02-9a11-845980a1fd5c"
version = "1.11.0"

[[deps.SHA]]
uuid = "ea8e919c-243c-51af-8825-aaa63cd721ce"
version = "0.7.0"</code></pre>
</div>
<p>As before, we can now remove this <code>Random</code> package because
we do not need it.</p>
<pre class="shell"><code>pkg&gt; remove Random</code></pre>
<p>If we check <code>pkg&gt; status</code> again, we see that we have
returned to the “(empty project)” state. Similarly, looking inside
<code>Project.toml</code> we see that the dependency has indeed
disappeared from the project.</p>
</div>
</section><section><h2 class="section-heading" id="developing-the-package">Developing the package<a class="anchor" aria-label="anchor" href="#developing-the-package"></a>
</h2>
<hr class="half-width">
<p>Now that we have our empty package set up, we would like to develop
some code for it!</p>
<p>Navigate to <code>src/MyPackage.jl</code> to see some dummy code has
already been generated by the template:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">module</span> MyPackage</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="st">    hi = hello_world()</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="st">A simple function to return "Hello, World!"</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="kw">function</span> <span class="fu">hello_world</span>()</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"Hello, World!"</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>In the REPL we can try running this:</p>
<pre class="shell"><code>julia&gt; using MyPackage
julia&gt; MyPackage.hello_world()</code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="st">"Hello, World!"</span></span></code></pre>
</div>
<p>Note that we needed <code>using MyPackage</code> to tell Julia to
make the name <code>MyPackage</code> available for us to refer to. We
then called the <code>hello_world</code> function that is part of that
module.</p>
<div id="the-world-is-not-enough" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="the-world-is-not-enough" class="callout-inner">
<h3 class="callout-title">The world is not enough</h3>
<div class="callout-content">
<p>But perhaps the “World” is not inclusive enough. Let’s try saying
hello to the whole universe. Try modifying the function to say “Hello,
Universe!” then call it in the REPL again.</p>
<p>Before doing this - what do you think the result will be?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">hello_world</span>()</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"Hello, Universe!"</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<pre class="shell"><code><span><span class="va">julia</span><span class="op">&gt;</span> <span class="fu">MyPackage.hello_world</span><span class="op">(</span><span class="op">)</span></span></code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="st">"Hello, World!"</span></span></code></pre>
</div>
<p>Why did this happen? The answer is that Julia is using the version of
the package as it existed when it was first loaded. The modifications
you have made have not been tracked or recompiled, so the original
function is still being called.</p>
<p>If you reload Julia (exit then open the REPL again) and try again,
you will see the result now says “Universe” as desired.</p>
<p>Change the message back to <code>Hello, World!</code> for now.</p>
</div>
</div>
</div>
</div>
<p>Julia uses the package <code>MyPackage</code> in whatever state it is
when <code>using</code> is first called. Subsequent changes to the
source code do not trigger automatic recompilation, unless e.g. Julia is
restarted. This is problematic since, during development, we often want
to make changes to our code without restarting the Julia session to
check it. We can achieve this with <code>Revise.jl</code>.</p>
<div class="section level3">
<h3 id="installing-revise-jl">Installing <code>Revise.jl</code>
<a class="anchor" aria-label="anchor" href="#installing-revise-jl"></a>
</h3>
<p>Make sure you are in the default environment when you install
<code>Revise.jl</code>, as we generally do not want developer
dependencies to be a part of the package. Anything you install in the
default shared environment will be available in specific environments
too due to what is called “environment stacking”.</p>
<pre class="shell"><code>pkg&gt; activate # No argument, so as to pick the default environment
pkg&gt; status
pkg&gt; add Revise</code></pre>
</div>
<div class="section level3">
<h3 id="trying-out-revise-jl">Trying out <code>Revise.jl</code>
<a class="anchor" aria-label="anchor" href="#trying-out-revise-jl"></a>
</h3>
<p>Now we are ready to try out <code>Revise</code>. Exit the Julia REPL
and reload it, then indicate we wish to use <code>Revise</code>.</p>
<pre class="shell"><code>julia
julia&gt; using Revise
pkg&gt; activate . # Start using our local package environment again</code></pre>
<div id="callout2" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>You must load <code>Revise</code> <em>before</em> loading any
packages you want it to track.</p>
</div>
</div>
</div>
<p>Try loading and using our package again.</p>
<pre class="shell"><code>julia&gt; using MyPackage
julia&gt; MyPackage.hello_world()</code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="st">"Hello, World!"</span></span></code></pre>
</div>
<p>Now try editing the message to say <code>Goodbye, World!</code>.
Remember to save your changes.</p>
<pre class="shell"><code><span><span class="va">julia</span><span class="op">&gt;</span> <span class="fu">MyPackage.hello_world</span><span class="op">(</span><span class="op">)</span></span></code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="st">"Goodbye, World!"</span></span></code></pre>
</div>
<p>Now, thanks to <code>Revise</code>, the change to the package’s code
was being tracked and was automatically recompiled. This means you can
make changes to the package and have them be active without needing to
reload the Julia REPL.</p>
<div id="callout3" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>While <code>Revise</code> does its best to track any changes made,
there are some limits to what can be done in a single Julia session. For
example, changes to type definitions or <code>const</code>s (among
others) will probably still necessitate restarting your Julia
session.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>You can use the <code>BestieTemplate</code> to generate a new
package structure complete with tooling for best practices in Julia
development.</li>
<li>The <code>Revise.jl</code> module can automatically reload parts of
your code that have changed.</li>
<li>Best practice: file names should reflect module names.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-090-best-practices"><p>Content from <a href="090-best-practices.html">Best practices</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/090-best-practices.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I setup unit testing?</li>
<li>What about documentation?</li>
<li>Are there good Github Actions available for CI/CD?</li>
<li>I like autoformatters for my code, what is the best one for
Julia?</li>
<li>How can I make all this a bit easier?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>tests</li>
<li>documentation</li>
<li>GitHub workflows</li>
<li>JuliaFormatter.jl</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In this lesson, we will cover issues of best practices in Julia
package development. In particular, this covers testing, documentation
and formatting.</p>
<p>If you followed the instructions from the previous lesson (using the
<code>BestieTemplate</code> to generate a package) then all these topics
have already been handled.</p>
<p>We will start with adding a new function to our
<code>MyPackage.jl</code> package, and show how to quickly add unit
tests and documentation.</p>
<section><h2 class="section-heading" id="preparing-for-developing">Preparing for developing<a class="anchor" aria-label="anchor" href="#preparing-for-developing"></a>
</h2>
<hr class="half-width">
<p>As before, we open the Julia REPL, activate our package and load
<code>Revise</code>:</p>
<pre class="shell"><code>julia
julia&gt; activate .
julia&gt; using Revise</code></pre>
</section><section><h2 class="section-heading" id="the-roots-of-a-cubic-polynomial">The roots of a cubic polynomial<a class="anchor" aria-label="anchor" href="#the-roots-of-a-cubic-polynomial"></a>
</h2>
<hr class="half-width">
<p>The following is a function for computing the roots of a cubic
polynomial</p>
<p><span class="math display">\[ax^3 + bx^2 + cx + d = 0.\]</span></p>
<p>There is an interesting story about these equations. It was known for
a long time how to solve quadratic equations. In 1535 the Italian
mathematician Tartaglia discovered a way to solve cubic equations, but
guarded his secret carefully. He was later persuaded by Cardano to
reveal his secret on the condition that Cardano wouldn’t reveal it
further. However, later Cardano found out that an earlier mathematician
Scipione del Ferro had also cracked the problem and decided that this
anulled his deal with Tartaglia, and published anyway. These days, the
formula is known as Cardano’s formula.</p>
<p>The interesting bit is that this method requires the use of complex
numbers.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">cubic_roots</span>(a, b, c, d)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>	cNaN <span class="op">=</span> <span class="cn">NaN</span><span class="op">+</span><span class="cn">NaN</span><span class="op">*</span><span class="cn">im</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>	</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>	<span class="cf">if</span> (a <span class="op">!=</span> <span class="fl">0</span>)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>		delta0 <span class="op">=</span> b<span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="fl">3</span><span class="op">*</span>a<span class="op">*</span>c</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>		delta1 <span class="op">=</span> <span class="fl">2</span><span class="op">*</span>b<span class="op">^</span><span class="fl">3</span> <span class="op">-</span> <span class="fl">9</span><span class="op">*</span>a<span class="op">*</span>b<span class="op">*</span>c <span class="op">+</span> <span class="fl">27</span><span class="op">*</span>a<span class="op">^</span><span class="fl">2</span><span class="op">*</span>d</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>		cc <span class="op">=</span> ((delta1 <span class="op">+</span> <span class="fu">sqrt</span>(delta1<span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="fl">4</span><span class="op">*</span>delta0<span class="op">^</span><span class="fl">3</span> <span class="op">+</span> <span class="fl">0im</span>)) <span class="op">/</span> <span class="fl">2</span>)<span class="op">^</span>(<span class="fl">1</span><span class="op">/</span><span class="fl">3</span>)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>		zeta <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">1im</span><span class="op">/</span><span class="fl">2</span> <span class="op">*</span> <span class="fu">sqrt</span>(<span class="fl">3</span>)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>		k <span class="op">=</span> (<span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>)</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>		<span class="cf">return</span> (<span class="op">-</span><span class="fl">1</span><span class="op">/</span>(<span class="fl">3</span><span class="op">*</span>a)) <span class="op">.*</span> (b <span class="op">.+</span> zeta<span class="op">.^</span>k <span class="op">.*</span> cc <span class="op">.+</span> delta0 <span class="op">./</span> (zeta<span class="op">.^</span>k <span class="op">.*</span> cc))</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>	<span class="cf">end</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>	<span class="cf">if</span> (b <span class="op">!=</span> <span class="fl">0</span>)</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>		delta <span class="op">=</span> <span class="fu">sqrt</span>(c<span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="fl">4</span> <span class="op">*</span> b <span class="op">*</span> d <span class="op">+</span> <span class="fl">0im</span>)</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>		<span class="cf">return</span> ((<span class="op">-</span>c <span class="op">-</span> delta) <span class="op">/</span> (<span class="fl">2</span><span class="op">*</span>b), (<span class="op">-</span>c <span class="op">+</span> delta) <span class="op">/</span> (<span class="fl">2</span><span class="op">*</span>b), cNaN)</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>	<span class="cf">end</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>	<span class="cf">if</span> (c <span class="op">!=</span> <span class="fl">0</span>)</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>		<span class="cf">return</span> (<span class="op">-</span>d<span class="op">/</span>c <span class="op">+</span> <span class="fl">0.0im</span>, cNaN, cNaN)</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>	<span class="cf">end</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>	<span class="cf">if</span> (d <span class="op">!=</span> <span class="fl">0</span>)</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>		<span class="cf">return</span> (cNaN, cNaN, cNaN)</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>	<span class="cf">end</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>	<span class="cf">return</span> (<span class="fl">0.0</span><span class="op">+</span><span class="fl">0.0im</span>, cNaN, cNaN)</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>We would like to add the above <code>cubic_roots()</code> function to
the <code>MyPackage.jl</code> package.</p>
<p>Add it to the <code>src/MyPackage.jl</code> file and save.</p>
<p>Let us load our package and attempt to use the
<code>cubic_roots()</code> function:</p>
<pre class="shell"><code>julia&gt; using MyPackage
julia&gt; MyPackage.cubic_roots(1,1,1,1)</code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(-1.0 - 0.0im, -3.700743415417188e-17 - 1.0im, -9.25185853854297e-17 + 1.0im)</code></pre>
</div>
<p>We see that it is indeed returning some roots to the equation we
defined: <span class="math display">\[x^3 + x^2 + x + 1 =
0.\]</span></p>
<div class="section level3">
<h3 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a>
</h3>
<div class="section level4">
<h4 id="testing-hello_world">Testing <code>hello_world()</code>
<a class="anchor" aria-label="anchor" href="#testing-hello_world"></a>
</h4>
<p>If we are to develop our package further, we may worry that any
changes we make might break existing functionality. For this reason, it
is important to add automated tests that can tell us immediately if the
behaviour of our existing functions has changed.</p>
<p>In the <code>test/</code> directory of <code>MyPackage.jl</code> you
should see that there already exists an example test for the
<code>hello_world()</code> function, in
<code>test-basic-test.jl</code>:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="pp">@testset</span> <span class="st">"MyPackage.jl"</span> <span class="cf">begin</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="pp">@test</span> MyPackage.<span class="fu">hello_world</span>() <span class="op">==</span> <span class="st">"Hello, World!"</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="cf">end</span></span></code></pre>
</div>
<p><code>@testset</code> is used to define a suite of many tests, while
<code>@test</code> defines a single check. In this case, there is one
test and it checks that the <code>hello_world()</code> function indeed
returns “Hello, World!”.</p>
</div>
<div class="section level4">
<h4 id="running-the-tests">Running the tests<a class="anchor" aria-label="anchor" href="#running-the-tests"></a>
</h4>
<p>We first need to add the standard Julia <code>Test</code>
package:</p>
<pre class="shell"><code>pkg&gt; add Test</code></pre>
<p>Then we can run all tests for our package by simply typing
<code>test</code>:</p>
<pre class="shell"><code><span><span class="va">pkg</span><span class="op">&gt;</span> <span class="va">test</span></span></code></pre>
<p>The outcome of our <code>hello_world()</code> test now will depend on
what state the <code>hello_world()</code> function is currently in. If
you modified it in the previous lesson and it no longer returns “Hello,
World!”, then the test will fail. Try changing the function to make the
tests fail and then pass again.</p>
<div id="add-a-test-for-cubic_roots" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="add-a-test-for-cubic_roots" class="callout-inner">
<h3 class="callout-title">Add a test for <code>cubic_roots</code>
</h3>
<div class="callout-content">
<p>Create a new file in the <code>test/</code> directory, called
<code>test-cubic.jl</code>.</p>
<p>Using what you know from the <code>hello_world()</code> tests, can
you populate this file with a test for the following case:</p>
<ul>
<li>For the special case with <span class="math display">\[a=0, b=0,
c=0, d=0\]</span> check that the only (non-NaN) solution is 0.</li>
</ul>
<p>Hint: You only need to check the first element of the returned
tuple.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>The contents of <code>test-cubic.jl</code> should be e.g.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="pp">@testset</span> <span class="st">"MyPackage.jl"</span> <span class="cf">begin</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    <span class="pp">@test</span> MyPackage.<span class="fu">cubic_roots</span>(<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>)[<span class="fl">1</span>] <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="cf">end</span></span></code></pre>
</div>
<p>Then, running <code>pkg&gt; test</code> will result in a pass.</p>
<p>Note that the equality check would also work with:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>    <span class="pp">@test</span> MyPackage.<span class="fu">cubic_roots</span>(<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>)[<span class="fl">1</span>] <span class="op">==</span> <span class="fl">0.0</span></span></code></pre>
</div>
<p>and</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>    <span class="pp">@test</span> MyPackage.<span class="fu">cubic_roots</span>(<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>)[<span class="fl">1</span>] <span class="op">==</span> <span class="fl">0.0</span><span class="op">+</span><span class="fl">0.0im</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a>
</h3>
<div class="section level4">
<h4 id="documenting-hello_world">Documenting <code>hello_world()</code>
<a class="anchor" aria-label="anchor" href="#documenting-hello_world"></a>
</h4>
<p>The <code>hello_world()</code> function has a docstring before
it:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="st">    hi = hello_world()</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="st">A simple function to return "Hello, World!"</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="st">"""</span></span></code></pre>
</div>
<p>This is low-level technical documentation for this particular
function.</p>
</div>
<div class="section level4">
<h4 id="using-the-repl-help-mode">Using the REPL help mode<a class="anchor" aria-label="anchor" href="#using-the-repl-help-mode"></a>
</h4>
<p>In the Julia REPL, pressing <code>?</code> will enter help mode. You
can then type the name of a function you would like documentation
about:</p>
<pre class="shell"><code>julia&gt; # Press '?'
help?&gt; MyPackage.hello_world()</code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>
  │ Warning
  │
  │  The following bindings may be internal; they may change or be removed in future versions:
  │
  │    •  MyPackage.hello_world

  hi = hello_world()

  A simple function to return "Hello, World!"</code></pre>
</div>
</div>
<div class="section level4">
<h4 id="building-the-docs">Building the docs<a class="anchor" aria-label="anchor" href="#building-the-docs"></a>
</h4>
<p>The standard package for building beautiful documentation websites
for Julia packages is <code>Documenter.jl</code>. It can be seen in the
<code>Project.toml</code> for the <code>docs/</code> directory that this
is indeed the package that <code>BestieTemplate.jl</code> has set up for
us.</p>
<p>In <code>docs/make.jl</code> we see <code>Documenter</code> being
used to build the documentation website, that is then deployed to GitHub
Pages where it is served from.</p>
<p>However, presently the code makes a lot of assumptions about being
used with git on GitHub, and local builds tend not to render nicely. For
a taste of how it looks when fully rendered, see e.g. <a href="https://partitionedarrays.github.io/PartitionedArrays.jl/stable/" class="external-link uri">https://partitionedarrays.github.io/PartitionedArrays.jl/stable/</a>.</p>
</div>
</div>
<div class="section level3">
<h3 id="formatting">Formatting<a class="anchor" aria-label="anchor" href="#formatting"></a>
</h3>
<p>A good automatic formatter for Julia is
<code>JuliaFormatter.jl</code></p>
<pre class="shell"><code>pkg&gt; add JuliaFormatter
julia&gt; using JuliaFormatter</code></pre>
<p>Then you can try it out on our source file:</p>
<pre class="shell"><code><span><span class="va">julia</span><span class="op">&gt;</span> <span class="fu">format</span><span class="op">(</span><span class="st">"src/MyPackage.jl"</span><span class="op">)</span></span></code></pre>
<p>Not a huge amount will change, but you may notice that spaces are
inserted around arithmetic operators, for example:</p>
<pre><code><span><span class="va">cNaN</span> <span class="op">=</span> <span class="cn">NaN</span><span class="op">+</span><span class="cn">NaN</span><span class="op">*</span><span class="va">im</span></span></code></pre>
<p>becomes</p>
<pre><code><span><span class="va">cNaN</span> <span class="op">=</span> <span class="cn">NaN</span> <span class="op">+</span> <span class="cn">NaN</span> <span class="op">*</span> <span class="va">im</span></span></code></pre>
<p>The configuration for the formatting in our package is set in
<code>.JuliaFormatter.toml</code>. In practice, you will not run this
formatter manually, but it will be automated by workflows created by the
<code>BestieTemplate</code>. This course does not focus on these
(largely they are integrated with <code>git</code> and
<code>GitHub</code>) but they are helpful with ensuring a clean code
base with minimal effort.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Julia has integrated support for unit testing.</li>
<li>
<code>Documenter.jl</code> is the standard package for generating
documentation.</li>
<li>The Julia ecosystem is well equiped to help you keep your code in
fit shape.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-100-introduction-performance"><p>Content from <a href="100-introduction-performance.html">Type Stability</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/100-introduction-performance.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is type stability?</li>
<li>Why is type stability so important for performance?</li>
<li>What is the origin of type unstable code? How can I prevent it?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Learn to diagnose type stability using <code>@code_warntype</code>
and <code>@profview</code>
</li>
<li>Understand how and why to avoid global mutable variables.</li>
<li>Analyze the problem when passing functions as members of a
struct.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In this episode we will look into <strong>type stability</strong>, a
very important topic when it comes to writing efficient Julia. We will
first show some small examples, trying to explain what type stability
means and how you can create code that is not type stable. Then we will
have two examples: one computing the growth of a coral reef under
varying sea level, the other computing the value of <span class="math inline">\(\pi\)</span> using the Chudnovsky algorithm.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools</span></span></code></pre>
</div>
<section><h2 class="section-heading" id="type-stability">Type stability<a class="anchor" aria-label="anchor" href="#type-stability"></a>
</h2>
<hr class="half-width">
<p>If types cannot be inferred at compile time, a function cannot be
entirely compiled to machine code. This means that evaluation will be
slow as molasses. One example of a type instability is when a function’s
return type depends on run-time values:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">safe_inv</span>(x<span class="op">::</span><span class="dt">T</span>) <span class="kw">where</span> {T}</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">==</span> <span class="fu">zero</span>(T)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>        <span class="cn">nothing</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="fu">one</span>(T) <span class="op">/</span> x</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="pp">@code_warntype</span> <span class="fu">safe_inv</span>(<span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">2</span>)</span></code></pre>
</div>
<p>In this case we may observe that the induced type is
<code>Union{Nothing, T}</code>. If we run <code>@code_warntype</code> we
can see the yellow highlighting of the union type. Having union-types
can be hint that the compiler is in uncertain territory. However, union
types are at the very core of how Julia approaches iteration and
therefore for-loops, so usually this will not lead to run-time
dispatches being triggered.</p>
<p>The situation is much worse when mutable globals are in place.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="fu">replace_x</span>(f, vs) <span class="op">=</span> [(<span class="fu">f</span>(v) ? x <span class="op">:</span> v) for v <span class="kw">in</span> vs]</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">replace_x</span>((<span class="op">&lt;</span>)(<span class="fl">0</span>), <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">2</span>)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="pp">@code_warntype</span> <span class="fu">replace_x</span>((<span class="op">&lt;</span>)(<span class="fl">0</span>), <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">2</span>)</span></code></pre>
</div>
<p>We can follow this up with:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>x <span class="op">=</span> <span class="st">"sloppy code!"</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="fu">replace_x</span>((<span class="op">&lt;</span>)(<span class="fl">0</span>), <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">2</span>)</span></code></pre>
</div>
<div id="use-parameters-or-const" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="use-parameters-or-const" class="callout-inner">
<h3 class="callout-title">Use parameters or <code>const</code>
</h3>
<div class="callout-content">
<p>Change the definition of <code>replace_x</code> by passing
<code>x</code> as a parameter. Change the definition of <code>x</code>
to a constant using <code>const</code>. Time the result against the type
unstable version.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="functions-in-structs">Functions in structs<a class="anchor" aria-label="anchor" href="#functions-in-structs"></a>
</h2>
<hr class="half-width">
<p>Every function has its own unique type. This can be a problem when we
want to get some functional user input. The following computes the
sedimentation history of a coral reef, following a paper by Bosscher
&amp; Schlager 1992:</p>
<p><span class="math display">\[\frac{\partial y}{\partial t} = g_m
\tanh \left(\frac{I_0 \exp(-kw)}{I_k}\right),\]</span></p>
<p>where <span class="math inline">\(g_m\)</span> is the maximum growth
rate, <span class="math inline">\(I_0\)</span> is the insolation (light
intensity at sea-level), <span class="math inline">\(I_k\)</span> the
saturation intensity, <span class="math inline">\(k\)</span> the
extinction coefficient and <span class="math inline">\(w\)</span> the
waterdepth, being <span class="math inline">\(sl(t) - y +
\sigma*t\)</span>, where <span class="math inline">\(sl(t)\)</span> is
the sea level and <span class="math inline">\(\sigma\)</span> is the
subsidence rate. The model uses the <span class="math inline">\(\tanh\)</span> function to interpolate between
maximum growth and zero growth, modified by the exponential extinction
of sun light as we go deeper into the water. Details don’t matter much,
the point being that we’d like to be able to specify the sea level as an
input parameter in functional form.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">Unitful</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="pp">@kwdef</span> <span class="kw">struct</span> Input</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="st">"The sea level as a function of time"</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    sea_level <span class="op">=</span> _ <span class="op">-&gt;</span> <span class="fl">0.0</span>u<span class="st">"m"</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    <span class="st">"Maximum growth rate of the coral, in m/Myr"</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>    maximum_growth_rate<span class="op">::</span><span class="dt">typeof</span>(<span class="fl">1.0</span>u<span class="st">"m/Myr"</span>) <span class="op">=</span> <span class="fl">0.2</span>u<span class="st">"mm/yr"</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    <span class="st">"The light intensity at which maximum growth is attained, in W/m^2"</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>    saturation_intensity<span class="op">::</span><span class="dt">typeof</span>(<span class="fl">1.0</span>u<span class="st">"W/m^2"</span>) <span class="op">=</span> <span class="fl">50.0</span>u<span class="st">"W/m^2"</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    <span class="st">"The rate at which growth rate drops every meter of water depth, in 1/m"</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    extinction_coefficient<span class="op">::</span><span class="dt">typeof</span>(<span class="fl">1.0</span>u<span class="st">"m^-1"</span>) <span class="op">=</span> <span class="fl">0.05</span>u<span class="st">"m^-1"</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>    <span class="st">"The light intensity of the Sun, in W/m^2"</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>    insolation<span class="op">::</span><span class="dt">typeof</span>(<span class="fl">1.0</span>u<span class="st">"W/m^2"</span>) <span class="op">=</span> <span class="fl">400.0</span>u<span class="st">"W/m^2"</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>    <span class="st">"Subsidence rate is the rate at which the plateau drops, in m/Myr"</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    subsidence_rate<span class="op">::</span><span class="dt">typeof</span>(<span class="fl">1.0</span>u<span class="st">"m/Myr"</span>) <span class="op">=</span> <span class="fl">50.0</span>u<span class="st">"m/Myr"</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a><span class="kw">function</span> <span class="fu">growth_rate</span>(input)</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>    sea_level <span class="op">=</span> input.sea_level</span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">df</span>(y, t)</span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>        <span class="co"># w = input.sea_level(t) - y + input.subsidence_rate * t</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>        w <span class="op">=</span> <span class="fu">sea_level</span>(t) <span class="op">-</span> y <span class="op">+</span> input.subsidence_rate <span class="op">*</span> t</span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>        g_m <span class="op">=</span> input.maximum_growth_rate</span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>        I_0 <span class="op">=</span> input.insolation</span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>        I_k <span class="op">=</span> input.saturation_intensity</span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>        k <span class="op">=</span> input.extinction_coefficient</span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>        w <span class="op">&gt;</span> <span class="fl">0</span>u<span class="st">"m"</span> ? g_m <span class="op">*</span> <span class="fu">tanh</span>(I_0 <span class="op">*</span> <span class="fu">exp</span>(<span class="op">-</span>k <span class="op">*</span> w) <span class="op">/</span> I_k) <span class="op">:</span> <span class="fl">0.0</span>u<span class="st">"m/Myr"</span></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">forward_euler</span>(df, y0<span class="op">::</span><span class="dt">T</span>, t) <span class="kw">where</span> {T}</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    result <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{T}</span>(<span class="cn">undef</span>, <span class="fu">length</span>(t) <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    result[<span class="fl">1</span>] <span class="op">=</span> y <span class="op">=</span> y0</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    dt <span class="op">=</span> <span class="fu">step</span>(t)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(t)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>        y <span class="op">=</span> y <span class="op">+</span> <span class="fu">df</span>(y, t[i]) <span class="op">*</span> dt</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>        result[i<span class="op">+</span><span class="fl">1</span>] <span class="op">=</span> y</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    </span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">let</span> input <span class="op">=</span> <span class="fu">Input</span>(sea_level<span class="op">=</span>t<span class="op">-&gt;</span><span class="fl">20.0</span>u<span class="st">"m"</span> <span class="op">*</span> <span class="fu">sin</span>(<span class="fl">2</span>π<span class="op">*</span>t<span class="op">/</span><span class="fl">200</span>u<span class="st">"kyr"</span>))</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    initial_topography <span class="op">=</span> (<span class="fl">0.0</span><span class="op">:-</span><span class="fl">1.0</span><span class="op">:-</span><span class="fl">100.0</span>)u<span class="st">"m"</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    result <span class="op">=</span> <span class="fu">stack</span>(<span class="fu">forward_euler</span>(<span class="fu">growth_rate</span>(input), y0, (<span class="fl">0.0</span><span class="op">:</span><span class="fl">0.001</span><span class="op">:</span><span class="fl">1.0</span>)u<span class="st">"Myr"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>        <span class="cf">for</span> y0 <span class="kw">in</span> initial_topography) <span class="op">.-</span> <span class="fl">1.0</span>u<span class="st">"Myr"</span> <span class="op">*</span> input.subsidence_rate</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>()</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>], xlabel<span class="op">=</span><span class="st">"y0"</span>, ylabel<span class="op">=</span><span class="st">"y"</span>, xreversed<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> <span class="fu">eachrow</span>(result[<span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">:</span><span class="kw">end</span>,<span class="op">:</span>])</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>        <span class="fu">lines!</span>(ax, initial_topography<span class="op">/</span>u<span class="st">"m"</span>, r<span class="op">/</span>u<span class="st">"m"</span>, color<span class="op">=:</span>black)</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    fig</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a><span class="cf">end</span></span></code></pre>
</div>
<p>What is wrong with this code?</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">let</span> input <span class="op">=</span> <span class="fu">Input</span>(sea_level<span class="op">=</span>t<span class="op">-&gt;</span><span class="fl">20.0</span>u<span class="st">"m"</span> <span class="op">*</span> <span class="fu">sin</span>(<span class="fl">2</span>π<span class="op">*</span>t<span class="op">/</span><span class="fl">200</span>u<span class="st">"kyr"</span>)),</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    y0 <span class="op">=</span> <span class="op">-</span><span class="fl">50.0</span>u<span class="st">"m"</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="pp">@code_warntype</span> <span class="fu">forward_euler</span>(<span class="fu">growth_rate</span>(input), y0, (<span class="fl">0.0</span><span class="op">:</span><span class="fl">0.001</span><span class="op">:</span><span class="fl">1.0</span>)u<span class="st">"Myr"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>The function in <code>Input</code> is untyped. We could try to type
the argument with a type parameter, but that doesn’t work so well with
<code>@kwdef</code> (we’d have to redefine the constructor). The problem
is also fixed if we recapture the <code>sea_level</code> parameter in
the local scope of the <code>growth_rate</code> function, see <a href="https://docs.julialang.org/en/v1/manual/performance-tips/#man-performance-captured" class="external-link">Performance
Tips</a>.</p>
<div id="fix-the-code" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="fix-the-code" class="callout-inner">
<h3 class="callout-title">Fix the code</h3>
<div class="callout-content">
<p>Modify the <code>growth_rate</code> function such that the
<code>sea_level</code> look-up becomes type stable. Assign the parameter
to a value with local scope.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">growth_rate</span>(input)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    sea_level <span class="op">=</span> input.sea_level</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">df</span>(y, t)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>        w <span class="op">=</span> <span class="fu">sea_level</span>(t) <span class="op">-</span> y <span class="op">+</span> input.subsidence_rate <span class="op">*</span> t</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>        g_m <span class="op">=</span> input.maximum_growth_rate</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>        I_0 <span class="op">=</span> input.insolation</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>        I_k <span class="op">=</span> input.saturation_intensity</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>        k <span class="op">=</span> input.extinction_coefficient</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>        w <span class="op">&gt;</span> <span class="fl">0</span>u<span class="st">"m"</span> ? g_m <span class="op">*</span> <span class="fu">tanh</span>(I_0 <span class="op">*</span> <span class="fu">exp</span>(<span class="op">-</span>k <span class="op">*</span> w) <span class="op">/</span> I_k) <span class="op">:</span> <span class="fl">0.0</span>u<span class="st">"m/Myr"</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="kw">let</span> input <span class="op">=</span> <span class="fu">Input</span>(sea_level<span class="op">=</span>t<span class="op">-&gt;</span><span class="fl">20.0</span>u<span class="st">"m"</span> <span class="op">*</span> <span class="fu">sin</span>(<span class="fl">2</span>π<span class="op">*</span>t<span class="op">/</span><span class="fl">200</span>u<span class="st">"kyr"</span>)),</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    y0 <span class="op">=</span> <span class="op">-</span><span class="fl">50.0</span>u<span class="st">"m"</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    <span class="pp">@code_warntype</span> <span class="fu">forward_euler</span>(<span class="fu">growth_rate</span>(input), y0, (<span class="fl">0.0</span><span class="op">:</span><span class="fl">0.001</span><span class="op">:</span><span class="fl">1.0</span>)u<span class="st">"Myr"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="multi-threading-and-type-stability">Multi-threading and type stability<a class="anchor" aria-label="anchor" href="#multi-threading-and-type-stability"></a>
</h2>
<hr class="half-width">
<p>Here we have an algorithm that computes the value of π to high
precision. We can make this algorithm parallel by recursively calling
<code>Threads.@spawn</code>, and then <code>fetch</code> on each task.
Unfortunately the return type of <code>fetch</code> is never known at
compile time. We can keep the type instability localized by declaring
the return types.</p>
<p>The following algorithm is <a href="https://en.wikipedia.org/wiki/Chudnovsky_algorithm" class="external-link">copy-pasted
from Wikipedia</a>.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">binary_split_1</span>(a, b)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>    Pab <span class="op">=</span> <span class="fu">-</span>(<span class="fl">6</span><span class="op">*</span>a <span class="op">-</span> <span class="fl">5</span>)<span class="fu">*</span>(<span class="fl">2</span><span class="op">*</span>a <span class="op">-</span> <span class="fl">1</span>)<span class="fu">*</span>(<span class="fl">6</span><span class="op">*</span>a <span class="op">-</span> <span class="fl">1</span>)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    Qab <span class="op">=</span> <span class="fl">10939058860032000</span> <span class="op">*</span> a<span class="op">^</span><span class="fl">3</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    Rab <span class="op">=</span> Pab <span class="op">*</span> (<span class="fl">545140134</span><span class="op">*</span>a <span class="op">+</span> <span class="fl">13591409</span>)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    <span class="cf">return</span> Pab, Qab, Rab</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="fu">setprecision</span>(<span class="fl">20</span>, base<span class="op">=</span><span class="fl">30</span>) <span class="cf">do</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>    _, q, r <span class="op">=</span> <span class="fu">binary_split_1</span>(<span class="fu">big</span>(<span class="fl">1</span>), <span class="fu">big</span>(<span class="fl">2</span>))</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>    (<span class="fl">426880</span> <span class="op">*</span> <span class="fu">sqrt</span>(<span class="fu">big</span>(<span class="fl">10005.0</span>)) <span class="op">*</span> q) <span class="op">/</span> (<span class="fl">13591409</span><span class="op">*</span>q <span class="op">+</span> r)</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="co"># The last few digits are wrong... check</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="fu">setprecision</span>(<span class="fl">20</span>, base<span class="op">=</span><span class="fl">30</span>) <span class="cf">do</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>    <span class="cn">π</span> <span class="op">|&gt;</span> <span class="dt">BigFloat</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a><span class="co"># The algorithm refines by recursive binary splitting</span></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a><span class="co"># Recursion is fine here: we go 2logN deep.</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a><span class="kw">function</span> <span class="fu">binary_split</span>(a, b)</span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>    <span class="cf">if</span> b <span class="op">==</span> a <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>        <span class="fu">binary_split_1</span>(a, b)</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>        m <span class="op">=</span> <span class="fu">div</span>(a <span class="op">+</span> b, <span class="fl">2</span>)</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>        Pam, Qam, Ram <span class="op">=</span> <span class="fu">binary_split</span>(a, m)</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a>        Pmb, Qmb, Rmb <span class="op">=</span> <span class="fu">binary_split</span>(m, b)</span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>        </span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>        Pab <span class="op">=</span> Pam <span class="op">*</span> Pmb</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>        Qab <span class="op">=</span> Qam <span class="op">*</span> Qmb</span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>        Rab <span class="op">=</span> Qmb <span class="op">*</span> Ram <span class="op">+</span> Pam <span class="op">*</span> Rmb</span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>        <span class="cf">return</span> Pab, Qab, Rab</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a><span class="kw">function</span> <span class="fu">chudnovsky</span>(n)</span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a>    P1n, Q1n, R1n <span class="op">=</span> <span class="fu">binary_split</span>(<span class="fu">big</span>(<span class="fl">1</span>), n)</span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a>    <span class="cf">return</span> (<span class="fl">426880</span> <span class="op">*</span> <span class="fu">sqrt</span>(<span class="fu">big</span>(<span class="fl">10005.0</span>)) <span class="op">*</span> Q1n) <span class="op">/</span> (<span class="fl">13591409</span><span class="op">*</span>Q1n <span class="op">+</span> R1n)</span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a><span class="fu">setprecision</span>(<span class="fl">10000</span>)</span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">chudnovsky</span>(<span class="fu">big</span>(<span class="fl">20000</span>))</span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a><span class="co"># We can create a parallel version by spawning jobs. These are green threads.</span></span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a></span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a><span class="kw">function</span> <span class="fu">binary_split_td</span>(a<span class="op">::</span><span class="dt">T</span>, b<span class="op">::</span><span class="dt">T</span>) <span class="kw">where</span> {T}</span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a>    <span class="cf">if</span> b <span class="op">==</span> a <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a>        <span class="fu">binary_split_1</span>(a, b)</span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a>        m <span class="op">=</span> <span class="fu">div</span>(a <span class="op">+</span> b, <span class="fl">2</span>)</span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a>        t1 <span class="op">=</span> <span class="pp">@Threads</span>.spawn <span class="fu">binary_split_td</span>(a, m)</span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a>        t2 <span class="op">=</span> <span class="pp">@Threads</span>.spawn <span class="fu">binary_split_td</span>(m, b)</span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a>        Pam, Qam, Ram <span class="op">=</span> <span class="fu">fetch</span>(t1)</span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a>        Pmb, Qmb, Rmb <span class="op">=</span> <span class="fu">fetch</span>(t2)</span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a>        </span>
<span id="cb12-57"><a href="#cb12-57" tabindex="-1"></a>        Pab <span class="op">=</span> Pam <span class="op">*</span> Pmb</span>
<span id="cb12-58"><a href="#cb12-58" tabindex="-1"></a>        Qab <span class="op">=</span> Qam <span class="op">*</span> Qmb</span>
<span id="cb12-59"><a href="#cb12-59" tabindex="-1"></a>        Rab <span class="op">=</span> Qmb <span class="op">*</span> Ram <span class="op">+</span> Pam <span class="op">*</span> Rmb</span>
<span id="cb12-60"><a href="#cb12-60" tabindex="-1"></a>        <span class="cf">return</span> Pab, Qab, Rab</span>
<span id="cb12-61"><a href="#cb12-61" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb12-62"><a href="#cb12-62" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-63"><a href="#cb12-63" tabindex="-1"></a></span>
<span id="cb12-64"><a href="#cb12-64" tabindex="-1"></a><span class="kw">function</span> <span class="fu">chudnovsky_td</span>(n)</span>
<span id="cb12-65"><a href="#cb12-65" tabindex="-1"></a>    P1n, Q1n, R1n <span class="op">=</span> <span class="fu">binary_split_td</span>(<span class="fu">big</span>(<span class="fl">1</span>), n)</span>
<span id="cb12-66"><a href="#cb12-66" tabindex="-1"></a>    <span class="cf">return</span> (<span class="fl">426880</span> <span class="op">*</span> <span class="fu">sqrt</span>(<span class="fu">big</span>(<span class="fl">10005.0</span>)) <span class="op">*</span> Q1n) <span class="op">/</span> (<span class="fl">13591409</span><span class="op">*</span>Q1n <span class="op">+</span> R1n)</span>
<span id="cb12-67"><a href="#cb12-67" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>The following may show why the parallel code isn’t faster yet.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">setprecision</span>(<span class="fl">10000</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">chudnovsky_td</span>(<span class="fu">big</span>(<span class="fl">20000</span>))</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="pp">@profview</span> <span class="fu">chudnovsky_td</span>(<span class="fu">big</span>(<span class="fl">200000</span>))</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="pp">@code_warntype</span> <span class="fu">chudnovsky_td</span>(<span class="fu">big</span>(<span class="fl">6</span>))</span></code></pre>
</div>
<ul>
<li>The red areas in the flame graph show type unstable code (marked
with <strong>run-time dispatch</strong>)</li>
<li>Yellow regions are allocations.</li>
<li>The same can be seen in the code, as a kind of histogram back
drop.</li>
</ul>
<p>The code is also inefficient because <code>poptask</code> is very
prominent. We can make sure that each task is a bit beefier by reverting
to the serial code at some point. Insert the following in
<code>binary_split_td</code>:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>elseif b <span class="op">-</span> a <span class="op">&lt;=</span> <span class="fl">1024</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    <span class="fu">binary_split</span>(a, b)</span></code></pre>
</div>
<p>We can limit the type instability by changing the <code>fetch</code>
lines:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>Pam<span class="op">::</span><span class="dt">T</span>, Qam<span class="op">::</span><span class="dt">T</span>, Ram<span class="op">::</span><span class="dt">T </span><span class="op">=</span> <span class="fu">fetch</span>(t1)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>Pmb<span class="op">::</span><span class="dt">T</span>, Qmb<span class="op">::</span><span class="dt">T</span>, Rmb<span class="op">::</span><span class="dt">T </span><span class="op">=</span> <span class="fu">fetch</span>(t2)</span></code></pre>
</div>
<div id="rerun-the-profiler" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="rerun-the-profiler" class="callout-inner">
<h3 class="callout-title">Rerun the profiler</h3>
<div class="callout-content">
<p>Rerun the profiler and <code>@code_warntype</code>. Is the type
instability gone?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">binary_split_td</span>(a<span class="op">::</span><span class="dt">T</span>, b<span class="op">::</span><span class="dt">T</span>) <span class="kw">where</span> {T}</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>    <span class="cf">if</span> b <span class="op">==</span> a <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>        <span class="fu">binary_split_1</span>(a, b)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>    <span class="cf">elseif</span> b <span class="op">-</span> a <span class="op">&lt;=</span> <span class="fl">1024</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>        <span class="fu">binary_split</span>(a, b)</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>        m <span class="op">=</span> <span class="fu">div</span>(a <span class="op">+</span> b, <span class="fl">2</span>)</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>        t1 <span class="op">=</span> <span class="pp">@Threads</span>.spawn <span class="fu">binary_split_td</span>(a, m)</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>        t2 <span class="op">=</span> <span class="pp">@Threads</span>.spawn <span class="fu">binary_split_td</span>(m, b)</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>        Pam<span class="op">::</span><span class="dt">T</span>, Qam<span class="op">::</span><span class="dt">T</span>, Ram<span class="op">::</span><span class="dt">T </span><span class="op">=</span> <span class="fu">fetch</span>(t1)</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>        Pmb<span class="op">::</span><span class="dt">T</span>, Qmb<span class="op">::</span><span class="dt">T</span>, Rmb<span class="op">::</span><span class="dt">T </span><span class="op">=</span> <span class="fu">fetch</span>(t2)</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>        </span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>        Pab <span class="op">=</span> Pam <span class="op">*</span> Pmb</span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>        Qab <span class="op">=</span> Qam <span class="op">*</span> Qmb</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>        Rab <span class="op">=</span> Qmb <span class="op">*</span> Ram <span class="op">+</span> Pam <span class="op">*</span> Rmb</span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>        <span class="cf">return</span> Pab, Qab, Rab</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>Yes!</p>
</div>
</div>
</div>
</div>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>A good summary on type stability can be found in the following blog
post: - <a href="https://www.juliabloggers.com/writing-type-stable-julia-code/" class="external-link">Writing
type-stable Julia code</a></p>
</div>
</div>
</div>
<hr>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Type instabilities are the bane of efficient Julia</li>
<li>We can discover type instability using <code>@profview</code>, and
analyze further using <code>@code_warntype</code>.</li>
<li>Don’t use mutable global variables.</li>
<li>Write your code inside functions.</li>
<li>Specify element types for containers and structs.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-120-allocations"><p>Content from <a href="120-allocations.html">Reducing allocations on the Logistic Map</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/120-allocations.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I reduce the number of allocations?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Apply a code transformation to write to pre-allocated memory.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="about-memory">About Memory<a class="anchor" aria-label="anchor" href="#about-memory"></a>
</h2>
<hr class="half-width">
<p>There are roughly two types of memory in a computer program:</p>
<ul>
<li>stack: memory that lives statically inside a function. This memory
is very fast, but the size is limited and has to be known at
<strong>compile time</strong>. Examples: variables of known size created
in a block scope, and released after.</li>
<li>heap: memory that is associated with the entire process. Needs to be
allocated. Examples: arrays, strings. In general heap allocation (and
freeing) is slow: the process has to ask the OS for memory.</li>
</ul>
<p>Later on we will talk some more about memory. In the current episode
we’ll see how we can reduce allocations.</p>
</section><section><h2 class="section-heading" id="logistic-map">Logistic map<a class="anchor" aria-label="anchor" href="#logistic-map"></a>
</h2>
<hr class="half-width">
<p>Logistic growth (in economy or biology) is sometimes modelled using
the recurrence formula:</p>
<p><span class="math display">\[N_{i+1} = r N_{i} (1 -
N_{i}),\]</span></p>
<p>also known as the <strong>logistic map</strong>, where <span class="math inline">\(r\)</span> is the <strong>reproduction
factor</strong>. For low values of <span class="math inline">\(N\)</span> this behaves as exponential growth.
However, most growth processes will hit a ceiling at some point. Let’s
try:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">#| id: logistic-map</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">logistic_map</span>(r) <span class="op">=</span> n <span class="op">-&gt;</span> r <span class="op">*</span> n <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> n)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">IterTools</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="im">using</span> <span class="bu">.Iterators</span>: take, flatten</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">take</span>(<span class="fu">iterated</span>(<span class="fu">logistic_map</span>(<span class="fl">3.0</span>), <span class="fl">0.001</span>), <span class="fl">200</span>) <span class="op">|&gt;</span> collect <span class="op">|&gt;</span> lines</span></code></pre>
</div>
<div id="vary-r" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="vary-r" class="callout-inner">
<h3 class="callout-title">Vary <code>r</code>
</h3>
<div class="callout-content">
<p>Try different values of <span class="math inline">\(r\)</span>, what
do you see?</p>
<p>Extra (advanced!): see the <a href="https://docs.makie.org/stable/reference/blocks/slider" class="external-link">Makie
documentation on <code>Slider</code></a>. Can you make an interactive
plot?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">Printf</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>()</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    sl_r <span class="op">=</span> <span class="fu">Slider</span>(fig[<span class="fl">2</span>, <span class="fl">2</span>], range<span class="op">=</span><span class="fl">1.0</span><span class="op">:</span><span class="fl">0.001</span><span class="op">:</span><span class="fl">4.0</span>, startvalue<span class="op">=</span><span class="fl">2.0</span>)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    <span class="fu">Label</span>(fig[<span class="fl">2</span>,<span class="fl">1</span>], <span class="fu">lift</span>(r<span class="op">-&gt;</span><span class="pp">@sprintf</span>(<span class="st">"r = %.3f"</span>, r), sl_r.value))</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    points <span class="op">=</span> <span class="fu">lift</span>(sl_r.value) <span class="cf">do</span> r</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>        <span class="fu">take</span>(<span class="fu">iterated</span>(<span class="fu">logistic_map</span>(r), <span class="fl">0.001</span>), <span class="fl">50</span>) <span class="op">|&gt;</span> collect</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>], limits<span class="op">=</span>(<span class="cn">nothing</span>, (<span class="fl">0.0</span>, <span class="fl">1.0</span>)))</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    <span class="fu">plot!</span>(ax, points)</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    <span class="fu">lines!</span>(ax, points)</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    fig</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<figure><img src="fig/logistic-map-orbits.png" alt="a grid of 8 different plots with qualitative different behaviour" class="figure mx-auto d-block"><div class="figcaption">Orbits of logistic map for 8 different values of
<span class="math inline">\(r\)</span>.</div>
</figure><div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Plotting code </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" aria-labelledby="headingSpoiler1" data-bs-parent="#accordionSpoiler1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co">#| classes: ["task"]</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co">#| collect: figures</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">#| creates: episodes/fig/logistic-map-orbits.png</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="kw">module</span> Script</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="im">using</span> <span class="bu">IterTools</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="im">using</span> <span class="bu">.Iterators</span>: take</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="kw">function</span> <span class="fu">main</span>()</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>    <span class="fu">logistic_map</span>(r) <span class="op">=</span> n <span class="op">-&gt;</span> r <span class="op">*</span> n <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> n)</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size<span class="op">=</span>(<span class="fl">1024</span>, <span class="fl">512</span>))</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>    <span class="cf">for</span> (i, r) <span class="kw">in</span> <span class="fu">enumerate</span>(<span class="fu">LinRange</span>(<span class="fl">2.6</span>, <span class="fl">4.0</span>, <span class="fl">8</span>))</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>        ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fu">div</span>(i<span class="op">-</span><span class="fl">1</span>, <span class="fl">4</span>)<span class="op">+</span><span class="fl">1</span>, <span class="fu">mod1</span>(i, <span class="fl">4</span>)], title<span class="op">=</span><span class="st">"r=</span><span class="sc">$$</span>r<span class="st">"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>        pts <span class="op">=</span> <span class="fu">take</span>(<span class="fu">iterated</span>(<span class="fu">logistic_map</span>(r), <span class="fl">0.001</span>), <span class="fl">50</span>) <span class="op">|&gt;</span> collect</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>        <span class="fu">lines!</span>(ax, pts, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>        <span class="fu">plot!</span>(ax, pts, markersize<span class="op">=</span><span class="fl">5.0</span>)</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>    <span class="fu">save</span>(<span class="st">"episodes/fig/logistic-map-orbits.png"</span>, fig)</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>Script.<span class="fu">main</span>()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>There seem to be key values of <span class="math inline">\(r\)</span>
where the iteration of the logistic map splits into periodic orbits, and
even get into chaotic behaviour.</p>
<p>We can plot all points for an arbitrary sized orbit for all values of
<span class="math inline">\(r\)</span> between 2.6 and 4.0. First of
all, let’s see how the <code>iterated |&gt; take |&gt; collect</code>
function chain performs.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">take</span>(<span class="fu">iterated</span>(<span class="fu">logistic_map</span>(<span class="fl">3.5</span>), <span class="fl">0.5</span>), <span class="fl">1000</span>) <span class="op">|&gt;</span> collect</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">iterated_fn</span>(f, x, n)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    result <span class="op">=</span> <span class="dt">Float64</span>[]</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>        x <span class="op">=</span> <span class="fu">f</span>(x)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>        <span class="fu">push!</span>(result, x)</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="pp">@btime</span> <span class="fu">iterated_fn</span>(<span class="fu">logistic_map</span>(<span class="fl">3.5</span>), <span class="fl">0.5</span>, <span class="fl">1000</span>)</span></code></pre>
</div>
<p>That seems to be slower than the original! Let’s try to improve:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">iterated_fn</span>(f, x, n)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    result <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{Float64}</span>(<span class="cn">undef</span>, n)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>        x <span class="op">=</span> <span class="fu">f</span>(x)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>        result[i] <span class="op">=</span> x</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">iterated_fn</span>(<span class="fu">logistic_map</span>(<span class="fl">3.5</span>), <span class="fl">0.5</span>, <span class="fl">1000</span>)</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a><span class="pp">@profview</span> <span class="cf">for</span> _<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">100000</span>; <span class="fu">iterated_fn</span>(<span class="fu">logistic_map</span>(<span class="fl">3.5</span>), <span class="fl">0.5</span>, <span class="fl">1000</span>); <span class="cf">end</span></span></code></pre>
</div>
<p>We can do better if we don’t need to allocate:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">iterated_fn!</span>(f, x, out)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(out)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>        x <span class="op">=</span> <span class="fu">f</span>(x)</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>        out[i] <span class="op">=</span> x</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>out <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{Float64}</span>(<span class="cn">undef</span>, <span class="fl">1000</span>)</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">iterated_fn!</span>(<span class="fu">logistic_map</span>(<span class="fl">3.5</span>), <span class="fl">0.5</span>, out)</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="pp">@profview</span> <span class="cf">for</span> _<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">100000</span>; <span class="fu">iterated_fn!</span>(<span class="fu">logistic_map</span>(<span class="fl">3.5</span>), <span class="fl">0.5</span>, out); <span class="cf">end</span></span></code></pre>
</div>
<p>Try to change the 1000 into 10000. What is the conclusion? Small
allocations inside loops contribute to run-time. The
<code>iterator |&gt; collect</code> pattern is usually good enough.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co">#| id: logistic-map</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">logistic_map_points</span>(r<span class="op">::</span><span class="dt">Real</span>, n_skip)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    <span class="fu">make_point</span>(x) <span class="op">=</span> <span class="fu">Point2f</span>(r, x)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    x0 <span class="op">=</span> <span class="fu">nth</span>(<span class="fu">iterated</span>(<span class="fu">logistic_map</span>(r), <span class="fl">0.5</span>), n_skip)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>    <span class="bu">Iterators</span>.<span class="fu">map</span>(make_point, <span class="fu">iterated</span>(<span class="fu">logistic_map</span>(r), x0))</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">take</span>(<span class="fu">logistic_map_points</span>(<span class="fl">3.5</span>, <span class="fl">1000</span>), <span class="fl">1000</span>) <span class="op">|&gt;</span> collect</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co">#| id: logistic-map</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">logistic_map_points</span>(rs<span class="op">::</span><span class="dt">AbstractVector{R}</span>, n_skip, n_take) <span class="kw">where</span> {R <span class="op">&lt;:</span><span class="dt"> Real</span>}</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    <span class="bu">Iterators</span>.<span class="fu">flatten</span>(<span class="bu">Iterators</span>.<span class="fu">take</span>(<span class="fu">logistic_map_points</span>(r, n_skip), n_take) <span class="cf">for</span> r <span class="kw">in</span> rs) </span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="cf">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">logistic_map_points</span>(<span class="fu">LinRange</span>(<span class="fl">2.6</span>, <span class="fl">4.0</span>, <span class="fl">1000</span>), <span class="fl">1000</span>, <span class="fl">1000</span>) <span class="op">|&gt;</span> collect</span></code></pre>
</div>
<p>First of all, let’s visualize the output because it’s so pretty!</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co">#| id: logistic-map</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_bifurcation_diagram</span>()</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    pts <span class="op">=</span> <span class="fu">logistic_map_points</span>(<span class="fu">LinRange</span>(<span class="fl">2.6</span>, <span class="fl">4.0</span>, <span class="fl">10000</span>), <span class="fl">1000</span>, <span class="fl">10000</span>) <span class="op">|&gt;</span> collect</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size<span class="op">=</span>(<span class="fl">1024</span>, <span class="fl">768</span>))</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>    ax <span class="op">=</span> Makie.<span class="fu">Axis</span>(fig[<span class="fl">1</span>,<span class="fl">1</span>], limits<span class="op">=</span>((<span class="fl">2.6</span>, <span class="fl">4.0</span>), <span class="cn">nothing</span>), xlabel<span class="op">=</span><span class="st">"r"</span>, ylabel<span class="op">=</span><span class="st">"N"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    <span class="fu">datashader!</span>(ax, pts, async<span class="op">=</span><span class="cn">false</span>, colormap<span class="op">=:</span>deep)</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>    fig</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="fu">plot_bifurcation_diagram</span>()</span></code></pre>
</div>
<figure><img src="fig/bifurcation-diagram.png" alt="indescribable beauty" class="figure mx-auto d-block"><div class="figcaption">The bifurcation diagram</div>
</figure><div id="accordionSpoiler2" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler2" aria-expanded="false" aria-controls="collapseSpoiler2">
  <h3 class="accordion-header" id="headingSpoiler2">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Plotting code </h3>
</button>
<div id="collapseSpoiler2" class="accordion-collapse collapse" aria-labelledby="headingSpoiler2" data-bs-parent="#accordionSpoiler2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co">#| classes: ["task"]</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co">#| collect: figures</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co">#| creates: episodes/fig/bifurcation-diagram.png</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="kw">module</span> Script</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="im">using</span> <span class="bu">IterTools</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="im">using</span> <span class="bu">.Iterators</span>: take</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="op">&lt;&lt;</span>logistic<span class="op">-</span>map<span class="op">&gt;&gt;</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="kw">function</span> <span class="fu">main</span>()</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">plot_bifurcation_diagram</span>()</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    <span class="fu">save</span>(<span class="st">"episodes/fig/bifurcation-diagram.png"</span>, fig)</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>Script.<span class="fu">main</span>()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="pp">@profview</span> <span class="cf">for</span> _<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span> <span class="fu">logistic_map_points</span>(<span class="fu">LinRange</span>(<span class="fl">2.6</span>, <span class="fl">4.0</span>, <span class="fl">1000</span>), <span class="fl">1000</span>, <span class="fl">1000</span>) <span class="op">|&gt;</span> collect <span class="cf">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">collect!</span>(it, tgt)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>    <span class="cf">for</span> (i, v) <span class="kw">in</span> <span class="fu">zip</span>(<span class="fu">eachindex</span>(tgt), it)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>       tgt[i] <span class="op">=</span> v</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="kw">function</span> <span class="fu">logistic_map_points_td</span>(rs<span class="op">::</span><span class="dt">AbstractVector{R}</span>, n_skip, n_take) <span class="kw">where</span> {R <span class="op">&lt;:</span><span class="dt"> Real</span>}</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>    result <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{Point2d}</span>(<span class="cn">undef</span>, n_take, <span class="fu">length</span>(rs))</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>    <span class="co"># Threads.@threads for i in eachindex(rs)</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>    <span class="cf">for</span> (r, c) <span class="kw">in</span> <span class="fu">zip</span>(rs, <span class="fu">eachcol</span>(result))</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>        <span class="fu">collect!</span>(<span class="fu">logistic_map_points</span>(r, n_skip), c)</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">reshape</span>(result, <span class="op">:</span>)</span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">logistic_map_points_td</span>(<span class="fu">LinRange</span>(<span class="fl">2.6</span>, <span class="fl">4.0</span>, <span class="fl">1000</span>), <span class="fl">1000</span>, <span class="fl">1000</span>)</span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="fu">datashader</span>(a)</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">logistic_map_points_td</span>(<span class="fu">LinRange</span>(<span class="fl">2.6</span>, <span class="fl">4.0</span>, <span class="fl">1000</span>), <span class="fl">1000</span>, <span class="fl">1000</span>)</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="pp">@profview</span> <span class="fu">logistic_map_points_td</span>(<span class="fu">LinRange</span>(<span class="fl">2.6</span>, <span class="fl">4.0</span>, <span class="fl">1000</span>), <span class="fl">1000</span>, <span class="fl">1000</span>)</span></code></pre>
</div>
<div id="rewrite-the-logistic_map_points-function" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="rewrite-the-logistic_map_points-function" class="callout-inner">
<h3 class="callout-title">Rewrite the <code>logistic_map_points</code>
function</h3>
<div class="callout-content">
<p>Rewrite the last function, so that everything is in one body (Fortran
style!). Is this faster than using iterators?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">logistic_map_points_raw</span>(rs<span class="op">::</span><span class="dt">AbstractVector{R}</span>, n_skip, n_take, out<span class="op">::</span><span class="dt">AbstractVector{P}</span>) <span class="kw">where</span> {R <span class="op">&lt;:</span><span class="dt"> Real</span>, P}</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="co"># result = Array{Float32}(undef, 2, n_take, length(rs))</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="co"># result = Array{Point2f}(undef, n_take, length(rs))</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    <span class="pp">@assert</span> <span class="fu">length</span>(out) <span class="op">==</span> <span class="fu">length</span>(rs) <span class="op">*</span> n_take</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>    <span class="co"># result = reshape(reinterpret(Float32, out), 2, n_take, length(rs))</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>    result <span class="op">=</span> <span class="fu">reshape</span>(out, n_take, <span class="fu">length</span>(rs))</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(rs)</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>        x <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>        r <span class="op">=</span> rs[i]</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n_skip</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>            x <span class="op">=</span> r <span class="op">*</span> x <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> x)</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n_take</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>            x <span class="op">=</span> r <span class="op">*</span> x <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> x)</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>            result[j, i] <span class="op">=</span> <span class="fu">P</span>(r, x)</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>            <span class="co">#result[1, j, i] = r</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>            <span class="co">#result[2, j, i] = x</span></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>        <span class="co"># result[1, :, i] .= r</span></span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a>    <span class="co"># return reshape(reinterpret(Point2f, result), :)</span></span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a>    <span class="co"># return reshape(result, :)</span></span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a>    out</span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a>out <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{Point2d}</span>(<span class="cn">undef</span>, <span class="fl">1000000</span>)</span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a><span class="fu">logistic_map_points_raw</span>(<span class="fu">LinRange</span>(<span class="fl">2.6</span>, <span class="fl">4.0</span>, <span class="fl">1000</span>), <span class="fl">1000</span>, <span class="fl">1000</span>, out)</span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a><span class="fu">datashader</span>(out)</span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">logistic_map_points_raw</span>(<span class="fu">LinRange</span>(<span class="fl">2.6</span>, <span class="fl">4.0</span>, <span class="fl">1000</span>), <span class="fl">1000</span>, <span class="fl">1000</span>, out)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<hr>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Allocations are slow.</li>
<li>Growing arrays dynamically induces allocations.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-130-value-types-and-ca"><p>Content from <a href="130-value-types-and-ca.html">Value types: game of life</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/130-value-types-and-ca.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I use dispatch to implement different versions of a
function?</li>
<li>How can I optimise against memory allocations of small arrays?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand the concept of value types.</li>
<li>Understand <code>::Type{...}</code> syntax.</li>
<li>Apply <code>StaticArrays</code> to optimise certain operations.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Let’s build cellular automata! Cellular automata are discrete systems
consisting of cells that behave according to some well defined rules
locally, but then often show surprising behaviour globally. We’ll look
at two examples: 1-dimensional so-called <strong>Elementary Cellular
Automata</strong>, and the 2-dimensional <strong>Game of
Life</strong>.</p>
<p>To implement these cellular automata we’ll implement a generic
function for performing <strong>stencil operations</strong>: these are
operations that take an array as input, and then compute an output array
from preset neighbourhoods of the input array.</p>
<table class="table">
<colgroup>
<col width="48%">
<col width="51%">
</colgroup>
<thead><tr class="header">
<th>map</th>
<th>stencil</th>
</tr></thead>
<tbody><tr class="odd">
<td><img src="fig/map_operation.svg" alt="boxes and arrows" class="figure"></td>
<td><img src="fig/stencil_operation.svg" alt="boxes and arrows" class="figure"></td>
</tr></tbody>
</table>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Image source </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" aria-labelledby="headingSpoiler1" data-bs-parent="#accordionSpoiler1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">GraphvizDotLang</span>: digraph, edge, node, save</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>g_map <span class="op">=</span> <span class="fu">digraph</span>() <span class="op">|&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    <span class="fu">edge</span>(<span class="st">"a1"</span>, <span class="st">"b1"</span>) <span class="op">|&gt;</span> <span class="fu">edge</span>(<span class="st">"a2"</span>, <span class="st">"b2"</span>) <span class="op">|&gt;</span> <span class="fu">edge</span>(<span class="st">"a3"</span>, <span class="st">"b3"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">save</span>(g_map, <span class="st">"episodes/fig/map_operation.svg"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>g_stencil <span class="op">=</span> <span class="fu">digraph</span>() <span class="op">|&gt;</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>    <span class="fu">edge</span>(<span class="st">"a1"</span>, <span class="st">"b1"</span>) <span class="op">|&gt;</span> <span class="fu">edge</span>(<span class="st">"a1"</span>, <span class="st">"b2"</span>) <span class="op">|&gt;</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>    <span class="fu">edge</span>(<span class="st">"a2"</span>, <span class="st">"b1"</span>) <span class="op">|&gt;</span> <span class="fu">edge</span>(<span class="st">"a2"</span>, <span class="st">"b2"</span>) <span class="op">|&gt;</span> <span class="fu">edge</span>(<span class="st">"a2"</span>, <span class="st">"b3"</span>) <span class="op">|&gt;</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>    <span class="fu">edge</span>(<span class="st">"a3"</span>, <span class="st">"b2"</span>) <span class="op">|&gt;</span> <span class="fu">edge</span>(<span class="st">"a3"</span>, <span class="st">"b3"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="fu">save</span>(g_stencil, <span class="st">"episodes/fig/stencil_operation.svg"</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>In this episode we’re using the following modules:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">using</span> <span class="bu">StaticArrays</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="im">using</span> <span class="bu">Images</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="im">using</span> <span class="bu">FileIO</span></span></code></pre>
</div>
<section><h2 class="section-heading" id="value-types">Value types<a class="anchor" aria-label="anchor" href="#value-types"></a>
</h2>
<hr class="half-width">
<p>Our cellular automaton will live inside a box. And we want to be
generic over different types of boundary conditions. There are two
fundamental ways to deal with user choices like that: <strong>run
time</strong> and <strong>compile time</strong>.</p>
<p>We can use multiple dispatch to implement different boundary
types.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co">#| id: stencils</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="kw">abstract type</span> BoundaryType{dim} <span class="kw">end</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="kw">struct</span> Periodic{dim} <span class="op">&lt;:</span><span class="dt"> BoundaryType{dim} </span><span class="kw">end</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="kw">struct</span> Constant{dim, val} <span class="op">&lt;:</span><span class="dt"> BoundaryType{dim} </span><span class="kw">end</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="pp">@inline</span> <span class="fu">get_bounded</span>(<span class="op">::</span><span class="dt">Type{Periodic{dim}}</span>, arr, idx) <span class="kw">where</span> {dim} <span class="op">=</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>    <span class="fu">checkbounds</span>(<span class="dt">Bool</span>, arr, idx) ? arr[idx] <span class="op">:</span> </span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>    arr[<span class="fu">mod1</span>.(<span class="fu">Tuple</span>(idx), <span class="fu">size</span>(arr))<span class="op">...</span>]</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="pp">@inline</span> <span class="fu">get_bounded</span>(<span class="op">::</span><span class="dt">Type{Constant{dim, val}}</span>, arr, idx) <span class="kw">where</span> {dim, val} <span class="op">=</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>    <span class="fu">checkbounds</span>(<span class="dt">Bool</span>, arr, idx) ? arr[idx] <span class="op">:</span> val</span></code></pre>
</div>
<p>Here we have to convert <code>CartesianIndex</code> to a tuple to do
broadcasting operations over them. Try what happens if you don’t.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">Test</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="pp">@testset</span> <span class="st">"Boundary"</span> <span class="cf">begin</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="pp">@testset</span> <span class="st">"Boundary.Periodic"</span> <span class="cf">begin</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    a <span class="op">=</span> <span class="fu">reshape</span>(<span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, <span class="fl">3</span>, <span class="fl">3</span>)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    <span class="pp">@test</span> <span class="fu">get_bounded</span>(Periodic{<span class="fl">2</span>}, a, <span class="fu">CartesianIndex</span>(<span class="fl">0</span>, <span class="fl">0</span>)) <span class="op">==</span> <span class="fl">9</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="pp">@test</span> <span class="fu">get_bounded</span>(Periodic{<span class="fl">2</span>}, a, <span class="fu">CartesianIndex</span>(<span class="fl">4</span>, <span class="fl">5</span>)) <span class="op">==</span> <span class="fl">4</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="pp">@testset</span> <span class="st">"Boundary.Constant"</span> <span class="cf">begin</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    a <span class="op">=</span> <span class="fu">reshape</span>(<span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, <span class="fl">3</span>, <span class="fl">3</span>)</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    <span class="pp">@test</span> <span class="fu">get_bounded</span>(Constant{<span class="fl">2</span>, <span class="fl">0</span>}, a, <span class="fu">CartesianIndex</span>(<span class="fl">2</span>, <span class="fl">2</span>)) <span class="op">==</span> <span class="fl">5</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    <span class="pp">@test</span> <span class="fu">get_bounded</span>(Constant{<span class="fl">2</span>, <span class="fl">0</span>}, a, <span class="fu">CartesianIndex</span>(<span class="fl">5</span>, <span class="fl">0</span>)) <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="cf">end</span></span></code></pre>
</div>
<div id="reflected-boundaries" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="reflected-boundaries" class="callout-inner">
<h3 class="callout-title">Reflected boundaries</h3>
<div class="callout-content">
<p>Extend the <code>get_bounded</code> method to also work with
<code>Reflected</code> boundaries.</p>
<p>Hint 1: a reflected box is also periodic with a period
<code>2n</code> where <code>n</code> is the width of the box.</p>
<p>Hint 2: beware off-by-one errors! Use a unit test to check that your
function is behaving as should.</p>
<p>Hint 3: The following function may help.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="pp">@inline</span> <span class="fu">modflip</span>(a, l) <span class="op">=</span> <span class="kw">let</span> b <span class="op">=</span> <span class="fu">mod1</span>(a, <span class="fl">2</span>l)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    b <span class="op">&gt;</span> l ? <span class="fl">2</span>l <span class="op">-</span> b <span class="op">+</span> <span class="fl">1</span> <span class="op">:</span> b</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">#| id: stencils</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="kw">struct</span> Reflected{dim} <span class="op">&lt;:</span><span class="dt"> BoundaryType{dim} </span><span class="kw">end</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="pp">@inline</span> <span class="fu">get_bounded</span>(<span class="op">::</span><span class="dt">Type{Reflected{dim}}</span>, arr, idx) <span class="kw">where</span> {dim} <span class="op">=</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="fu">checkbounds</span>(<span class="dt">Bool</span>, arr, idx) ? arr[idx] <span class="op">:</span> </span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    arr[<span class="fu">modflip</span>.(<span class="fu">Tuple</span>(idx), <span class="fu">size</span>(arr))<span class="op">...</span>]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="write-to-output-parameter">Write to output parameter<a class="anchor" aria-label="anchor" href="#write-to-output-parameter"></a>
</h3>
<p>We’re now ready to write our first <code>stencil!</code> function.
This function takes as an input another function, a boundary type, a
stencil size, an input and output array.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">stencil!</span>(f, <span class="op">::</span><span class="dt">Type{BT}</span>, sz, inp<span class="op">::</span><span class="dt">AbstractArray{T,dim}</span>, out<span class="op">::</span><span class="dt">AbstractArray{RT,dim}</span>) <span class="kw">where</span> {T, RT, dim, BT <span class="op">&lt;:</span><span class="dt"> BoundaryType{dim}</span>}</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    center <span class="op">=</span> <span class="fu">CartesianIndex</span>((<span class="fu">div</span>.(sz, <span class="fl">2</span>) <span class="op">.+</span> <span class="fl">1</span>)<span class="op">...</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    nb <span class="op">=</span> <span class="fu">Array</span><span class="dt">{T}</span>(<span class="cn">undef</span>, sz<span class="op">...</span>)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(<span class="fu">IndexCartesian</span>(), inp)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="fu">eachindex</span>(<span class="fu">IndexCartesian</span>(), nb)</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>            nb[j] <span class="op">=</span> <span class="fu">get_bounded</span>(BT, inp, i <span class="op">-</span> center <span class="op">+</span> j)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>        out[i] <span class="op">=</span> <span class="fu">f</span>(nb)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="fu">stencil!</span>(f, <span class="op">::</span><span class="dt">Type{BT}</span>, sz) <span class="kw">where</span> {BT} <span class="op">=</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>    (inp, out) <span class="op">-&gt;</span> <span class="fu">stencil!</span>(f, BT, sz, inp, out)</span></code></pre>
</div>
<p>Note that we pass <code>IndexCartesian()</code> to
<code>eachindex</code> to force it to give us cartesian indices instead
of linear ones. We’re ready to implement ECA.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">eca</span>(n) <span class="op">=</span> nb <span class="op">-&gt;</span> <span class="fl">1</span> <span class="op">&amp;</span> (n <span class="op">&gt;&gt;</span> ((nb[<span class="fl">1</span>] <span class="op">&lt;&lt;</span> <span class="fl">2</span>) <span class="op">|</span> (nb[<span class="fl">2</span>] <span class="op">&lt;&lt;</span> <span class="fl">1</span>) <span class="op">|</span> nb[<span class="fl">3</span>]))</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="fu">rule</span>(n) <span class="op">=</span> <span class="fu">stencil!</span>(<span class="fu">eca</span>(n), Reflected{<span class="fl">1</span>}, <span class="fl">3</span>)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">to_color</span>(b) <span class="op">=</span> !b ? <span class="fu">RGB</span>(<span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>) <span class="op">:</span> <span class="fu">RGB</span>(<span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">to_image</span>(arr) <span class="op">=</span> <span class="fu">to_color</span>.(arr)<span class="ch">'</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">rand</span>(<span class="dt">Bool</span>, <span class="fl">800</span>, <span class="fl">600</span>) <span class="op">|&gt;</span> to_image</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>n <span class="op">=</span> <span class="fl">1024</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Bool</span>, n)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>b <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Bool</span>, n)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>a[n <span class="op">÷</span> <span class="fl">2</span>] <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="fu">rule</span>(<span class="fl">30</span>)(a, b) <span class="op">|&gt;</span> to_image</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>a, b <span class="op">=</span> b, a</span></code></pre>
</div>
<div id="create-an-image" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="create-an-image" class="callout-inner">
<h3 class="callout-title">Create an image</h3>
<div class="callout-content">
<p>Create an image (of say 1024x512) that shows the state of the
one-dimensional ECA on one axis and successive generations on the other
axis.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>Using iterators:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">IterTools</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="kw">function</span> <span class="fu">run_eca_iterators</span>(r, n)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    <span class="bu">Iterators</span>.<span class="fu">take</span>(</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>        <span class="fu">iterated</span>(</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>            <span class="kw">let</span> b <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Bool</span>, n); <span class="kw">function</span> (x)</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>                <span class="fu">rule</span>(r)(x, b); x, b <span class="op">=</span> b, x; <span class="fu">copy</span>(x) <span class="kw">end</span> <span class="kw">end</span>,</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>            <span class="kw">let</span> a <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Bool</span>, n); a[n<span class="op">÷</span><span class="fl">2</span>] <span class="op">=</span> <span class="cn">true</span>; a <span class="kw">end</span>), n<span class="op">÷</span><span class="fl">2</span>) <span class="op">|&gt;</span> stack</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="fu">run_eca_iterators</span>(<span class="fl">18</span>, <span class="fl">1024</span>) <span class="op">|&gt;</span> to_image</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">run_eca_iterators</span>(<span class="fl">18</span>, <span class="fl">1024</span>)</span></code></pre>
</div>
<p>Using a comprehension:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">run_eca_comprehension</span>(r, n)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>    x <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Bool</span>, n)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>    x[n<span class="op">÷</span><span class="fl">2</span>] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    b <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{Bool}</span>(<span class="cn">undef</span>, n)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    (<span class="cf">begin</span> </span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>        <span class="fu">rule</span>(<span class="fl">30</span>)(x, b)</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>        x, b <span class="op">=</span> b, x</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>        <span class="fu">copy</span>(x)</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    <span class="cf">end</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">512</span>) <span class="op">|&gt;</span> stack</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="fu">run_eca_comprehension</span>(<span class="fl">30</span>, <span class="fl">1024</span>) <span class="op">|&gt;</span> to_image</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">run_eca_comprehension</span>(<span class="fl">30</span>, <span class="fl">1024</span>)</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="pp">@profview</span> <span class="cf">for</span> _<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>; <span class="fu">run_eca_comprehension</span>(<span class="fl">30</span>, <span class="fl">1024</span>) <span class="cf">end</span></span></code></pre>
</div>
<p>Using a builder function:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">run_eca_builder</span>(r<span class="op">::</span><span class="dt">Int</span>, n<span class="op">::</span><span class="dt">Int</span>)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    result <span class="op">=</span> <span class="fu">Array</span><span class="dt">{Bool,2}</span>(<span class="cn">undef</span>, n, n <span class="op">÷</span> <span class="fl">2</span>)</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    result[<span class="op">:</span>, <span class="fl">1</span>] <span class="op">.=</span> <span class="fl">0</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    result[n<span class="op">÷</span><span class="fl">2</span>, <span class="fl">1</span>] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>    f <span class="op">=</span> <span class="fu">rule</span>(r)</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span>(n<span class="op">÷</span><span class="fl">2</span>)</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>        <span class="pp">@views</span> <span class="fu">f</span>(result[<span class="op">:</span>, i<span class="op">-</span><span class="fl">1</span>], result[<span class="op">:</span>, i])</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="fu">run_eca_builder</span>(<span class="fl">73</span>, <span class="fl">1024</span>) <span class="op">|&gt;</span> to_image</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">run_eca_builder</span>(<span class="fl">30</span>, <span class="fl">1024</span>)</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a><span class="pp">@profview</span> <span class="cf">for</span> _<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>; <span class="fu">run_eca_builder</span>(<span class="fl">30</span>, <span class="fl">1024</span>); <span class="cf">end</span></span></code></pre>
</div>
<p>Using a builder function with better data locality:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">run_eca_builder2</span>(r<span class="op">::</span><span class="dt">Int</span>, n<span class="op">::</span><span class="dt">Int</span>)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    x <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Bool</span>, n)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>    x[n<span class="op">÷</span><span class="fl">2</span>] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    b <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{Bool}</span>(<span class="cn">undef</span>, n)</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    result <span class="op">=</span> <span class="fu">Array</span><span class="dt">{Bool,2}</span>(<span class="cn">undef</span>, n, n <span class="op">÷</span> <span class="fl">2</span>)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    result[<span class="op">:</span>, <span class="fl">1</span>] <span class="op">.=</span> x</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span>(n<span class="op">÷</span><span class="fl">2</span>)</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>        <span class="pp">@views</span> <span class="fu">rule</span>(r)(x, b)</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>        x, b <span class="op">=</span> b, x</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>        result[<span class="op">:</span>, i] <span class="op">.=</span> x</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="fu">run_eca_builder2</span>(<span class="fl">30</span>, <span class="fl">1024</span>) <span class="op">|&gt;</span> to_image <span class="op">|&gt;</span> FileIO.<span class="fu">save</span>(<span class="st">"episodes/fig/rule30.png"</span>)</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">run_eca_builder2</span>(<span class="fl">30</span>, <span class="fl">1024</span>)</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="pp">@profview</span> <span class="cf">for</span> _ <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>; <span class="fu">run_eca_builder2</span>(<span class="fl">30</span>, <span class="fl">1024</span>); <span class="cf">end</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<figure><img src="fig/rule30.png" alt="a curious collection of chaotic pixels" class="figure mx-auto d-block"></figure>
</div>
<div class="section level3">
<h3 id="staticarrays">StaticArrays<a class="anchor" aria-label="anchor" href="#staticarrays"></a>
</h3>
<p>We’ve actually already seen static arrays in use, when we used the
<code>Vec3d</code> type to store three dimensional vectors in our
gravity simulation. Static arrays can be very useful to reduce
allocations of small arrays. In our case, the <code>nb</code> array can
be made into a static array.</p>
<p>Beware, that the array size should be a static (compile time)
argument now. It may be instructive to see what happens when you keep
the <code>sz</code> argument as a tuple. Run the profile viewer to see
that you have a type instability. Taking the argument as
<code>::Size{sz}</code> gets rid of this type instability. The
<code>stencil!</code> function should now run nearly twice as fast.</p>
<p>Rerun the timings in the previous exercise to show that this is the
case.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co">#| id: stencils</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="st">    stencil!(f, &lt;: BoundaryType{dim}, Size{sz}, inp, out)</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="st">The function `f` should take an `AbstractArray` with size `sz` as input</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="st">and return a single value. Then, `stencil` applies the function `f` to a</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="st">neighbourhood around each element and writes the output to `out`. </span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="kw">function</span> <span class="fu">stencil!</span>(f, <span class="op">::</span><span class="dt">Type{BT}</span>, <span class="op">::</span><span class="dt">Size{sz}</span>, inp<span class="op">::</span><span class="dt">AbstractArray{T,dim}</span>, out<span class="op">::</span><span class="dt">AbstractArray{RT,dim}</span>) <span class="kw">where</span> {dim, sz, BT <span class="op">&lt;:</span><span class="dt"> BoundaryType{dim}</span>, T, RT}</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>    <span class="pp">@assert</span> <span class="fu">size</span>(inp) <span class="op">==</span> <span class="fu">size</span>(out)</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>    center <span class="op">=</span> <span class="fu">CartesianIndex</span>((<span class="fu">div</span>.(sz, <span class="fl">2</span>) <span class="op">.+</span> <span class="fl">1</span>)<span class="op">...</span>)</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(<span class="fu">IndexCartesian</span>(), inp)</span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>        nb <span class="op">=</span> <span class="fu">SArray</span><span class="dt">{Tuple{sz...}, T}</span>(</span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>            <span class="fu">get_bounded</span>(BT, inp, i <span class="op">-</span> center <span class="op">+</span> j)</span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="fu">CartesianIndices</span>(sz))</span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>        out[i] <span class="op">=</span> <span class="fu">f</span>(nb)</span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a><span class="fu">stencil!</span>(f, <span class="op">::</span><span class="dt">Type{BT}</span>, sz) <span class="kw">where</span> {BT} <span class="op">=</span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>    (inp, out) <span class="op">-&gt;</span> <span class="fu">stencil!</span>(f, BT, sz, inp, out)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">rule</span>(n) <span class="op">=</span> <span class="fu">stencil!</span>(<span class="fu">eca</span>(n), Periodic{<span class="fl">1</span>}, <span class="fu">Size</span>(<span class="fl">3</span>))</span></code></pre>
</div>
</div>
</section><section><h2 class="section-heading" id="game-of-life">Game of Life<a class="anchor" aria-label="anchor" href="#game-of-life"></a>
</h2>
<hr class="half-width">
<p>Game of Life is a two-dimensional cellular automaton, and probably
the most famous one. We set the following rules:</p>
<ul>
<li>if there are three live neighbours, the cell lives.</li>
<li>if there are less than two or more than three live neighbours, the
cell dies.</li>
</ul>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co">#| id: ca</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="fu">game_of_life</span>(a) <span class="op">=</span> <span class="kw">let</span> s <span class="op">=</span> <span class="fu">sum</span>(a) <span class="op">-</span> a[<span class="fl">2</span>, <span class="fl">2</span>]</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    s <span class="op">==</span> <span class="fl">3</span> <span class="op">||</span> (a[<span class="fl">2</span>, <span class="fl">2</span>] <span class="op">&amp;&amp;</span> s <span class="op">==</span> <span class="fl">2</span>)</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">rand</span>(<span class="dt">Bool</span>, <span class="fl">64</span>, <span class="fl">64</span>)</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>b <span class="op">=</span> <span class="fu">zeros</span>(<span class="dt">Bool</span>, <span class="fl">64</span>, <span class="fl">64</span>)</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="fu">stencil!</span>(game_of_life, Periodic{<span class="fl">2</span>}, <span class="fu">Size</span>(<span class="fl">3</span>, <span class="fl">3</span>), a, b) <span class="op">|&gt;</span> to_image</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>a, b <span class="op">=</span> b, a</span></code></pre>
</div>
<div id="animated-life" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="animated-life" class="callout-inner">
<h3 class="callout-title">Animated Life</h3>
<div class="callout-content">
<p>Look up the documentation on <a href="https://docs.makie.org/v0.22/explanations/animation" class="external-link">animations in
Makie</a>. Can you make an animation of the Game of Life? Use the
<code>image!</code> function with argument
<code>interpolation=false</code> to show the image.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<p>Here’s a cool solution with live animation and lots more, just for
your enjoyment.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">tic</span>(f, dt, running_)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>    running<span class="op">::</span><span class="dt">Observable{Bool} </span><span class="op">=</span> running_</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    <span class="pp">@async</span> <span class="cf">begin</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>        <span class="cf">while</span> running[]</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>            <span class="fu">sleep</span>(dt[])</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>            <span class="fu">f</span>()</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="kw">function</span> <span class="fu">run_life</span>()</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>()</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>    sz <span class="op">=</span> (<span class="fl">256</span>, <span class="fl">256</span>)</span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>    state <span class="op">=</span> <span class="fu">Observable</span>(<span class="fu">rand</span>(<span class="dt">Bool</span>, sz<span class="op">...</span>))</span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a>    temp <span class="op">=</span> <span class="fu">Array</span><span class="dt">{Bool, 2}</span>(<span class="cn">undef</span>, sz<span class="op">...</span>)</span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>    foo <span class="op">=</span> <span class="fu">stencil!</span>(game_of_life, Periodic{<span class="fl">2</span>}, <span class="fu">Size</span>(<span class="fl">3</span>, <span class="fl">3</span>))</span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">next</span>()</span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>        <span class="fu">foo</span>(state[], temp)</span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a>        state[], temp <span class="op">=</span> temp, state[] <span class="co"># copy(temp)</span></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a>    ax <span class="op">=</span> Makie.<span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>], aspect<span class="op">=</span><span class="fl">1</span>)</span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a>    gb <span class="op">=</span> <span class="fu">GridLayout</span>(fig[<span class="fl">2</span>, <span class="fl">1</span>], tellwidth<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a>    playing <span class="op">=</span> <span class="fu">Observable</span>(<span class="cn">false</span>)</span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a>    play_button_text <span class="op">=</span> <span class="fu">lift</span>(<span class="fu">p-&gt;</span>(p ? <span class="st">"Pause"</span> <span class="op">:</span> <span class="st">"Play"</span>), playing)</span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a>    play_button <span class="op">=</span> gb[<span class="fl">1</span>,<span class="fl">1</span>] <span class="op">=</span> <span class="fu">Button</span>(fig, label<span class="op">=</span>play_button_text)</span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a>    rand_button <span class="op">=</span> gb[<span class="fl">1</span>,<span class="fl">2</span>] <span class="op">=</span> <span class="fu">Button</span>(fig, label<span class="op">=</span><span class="st">"Randomize"</span>)</span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a>    speed_slider <span class="op">=</span> gb[<span class="fl">1</span>,<span class="fl">3</span>] <span class="op">=</span> <span class="fu">SliderGrid</span>(fig, (label<span class="op">=</span><span class="st">"delay"</span>, range <span class="op">=</span> <span class="fu">logrange</span>(<span class="fl">0.001</span>, <span class="fl">1.0</span>, <span class="fl">100</span>), startvalue<span class="op">=</span><span class="fl">0.1</span>))</span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a>    <span class="fu">on</span>(play_button.clicks) <span class="cf">do</span> _</span>
<span id="cb19-36"><a href="#cb19-36" tabindex="-1"></a>        p <span class="op">=</span> !playing[]</span>
<span id="cb19-37"><a href="#cb19-37" tabindex="-1"></a>        playing[] <span class="op">=</span> p</span>
<span id="cb19-38"><a href="#cb19-38" tabindex="-1"></a>        <span class="cf">if</span> p</span>
<span id="cb19-39"><a href="#cb19-39" tabindex="-1"></a>            <span class="fu">tic</span>(next, speed_slider.sliders[<span class="fl">1</span>].value, playing)</span>
<span id="cb19-40"><a href="#cb19-40" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb19-41"><a href="#cb19-41" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb19-42"><a href="#cb19-42" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" tabindex="-1"></a>    <span class="fu">on</span>(rand_button.clicks) <span class="cf">do</span> _</span>
<span id="cb19-44"><a href="#cb19-44" tabindex="-1"></a>        state[] <span class="op">=</span> <span class="fu">rand</span>(<span class="dt">Bool</span>, sz<span class="op">...</span>)</span>
<span id="cb19-45"><a href="#cb19-45" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb19-46"><a href="#cb19-46" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" tabindex="-1"></a>    <span class="fu">image!</span>(ax, <span class="fu">lift</span>(to_image, state), interpolate<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb19-48"><a href="#cb19-48" tabindex="-1"></a></span>
<span id="cb19-49"><a href="#cb19-49" tabindex="-1"></a>    fig</span>
<span id="cb19-50"><a href="#cb19-50" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb19-51"><a href="#cb19-51" tabindex="-1"></a></span>
<span id="cb19-52"><a href="#cb19-52" tabindex="-1"></a><span class="fu">run_life</span>()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>There are some nice libraries that you may want to look into:</p>
<ul>
<li>
<a href="https://rafaqz.github.io/Stencils.jl/stable/" class="external-link"><code>Stencils.jl</code></a>
for another implementation of stencils.</li>
<li>
<a href="https://juliadynamics.github.io/Agents.jl/stable/" class="external-link"><code>Agents.jl</code></a>
for agent based modelling.</li>
</ul>
<hr>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Value types are a useful and efficient abstraction</li>
<li>Using StaticArrays can have a dramatic impact on performance</li>
</ul>
</div>
</div>
</div>
<div id="accordionSpoiler2" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler2" aria-expanded="false" aria-controls="collapseSpoiler2">
  <h3 class="accordion-header" id="headingSpoiler2">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div> Source code </h3>
</button>
<div id="collapseSpoiler2" class="accordion-collapse collapse" aria-labelledby="headingSpoiler2" data-bs-parent="#accordionSpoiler2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co">#| file: src/Stencils.jl</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="kw">module</span> Stencils</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>    <span class="im">using</span> <span class="bu">StaticArrays</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>    <span class="op">&lt;&lt;</span>stencils<span class="op">&gt;&gt;</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-140-threads-async-and-tasks"><p>Content from <a href="140-threads-async-and-tasks.html">Threads, ASync and Tasks</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/140-threads-async-and-tasks.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do we distribute work across threads?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Change for-loops to run parallel.</li>
<li>Launch tasks and generate results asynchronously.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">#| file: src/GrayScott.jl</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="kw">module</span> GrayScott</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Using SciML stack
  </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" aria-labelledby="headingSpoiler1" data-bs-parent="#accordionSpoiler1">
<div class="accordion-body">
<p>I’ve tried integrating the Gray-Scott model using libraries from the
SciML toolkit. However, the following code, directly modified from their
documentation doesn’t give anything within reasonable time. In my
opinion this is symptomatic for most of the SciML stack. It never really
works and you never discover why.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">ModelingToolkit</span>, <span class="bu">MethodOfLines</span>, <span class="bu">DomainSets</span>, <span class="bu">OrdinaryDiffEq</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="kw">function</span> <span class="fu">gray_scott_model</span>(F, k, Du, Dv, N, order<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    <span class="pp">@parameters</span> x y t</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="pp">@variables</span> <span class="fu">u</span>(<span class="op">..</span>) <span class="fu">v</span>(<span class="op">..</span>)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>    Dt <span class="op">=</span> <span class="fu">Differential</span>(t)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>    Dx <span class="op">=</span> <span class="fu">Differential</span>(x)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>    Dy <span class="op">=</span> <span class="fu">Differential</span>(y)</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>    Dxx <span class="op">=</span> Dx<span class="op">^</span><span class="fl">2</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>    Dyy <span class="op">=</span> Dy<span class="op">^</span><span class="fl">2</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    <span class="fu">Δ</span>(u) <span class="op">=</span> <span class="fu">Dxx</span>(u) <span class="op">+</span> <span class="fu">Dyy</span>(u)</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>    x_min <span class="op">=</span> y_min <span class="op">=</span> t_min <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>    x_max <span class="op">=</span> y_max <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>    t_max <span class="op">=</span> <span class="fl">10.0</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    <span class="fu">u0</span>(x, y) <span class="op">=</span> <span class="fl">0.01</span> <span class="op">*</span> <span class="fu">exp</span>((<span class="fu">-</span>(x <span class="op">-</span> <span class="fl">0.5</span>)<span class="op">^</span><span class="fl">2</span> <span class="op">-</span> (y <span class="op">-</span> <span class="fl">0.5</span>)<span class="op">^</span><span class="fl">2</span>) <span class="op">/</span> (<span class="fl">2</span> <span class="op">*</span> <span class="fl">0.1</span><span class="op">^</span><span class="fl">2</span>)) <span class="op">/</span> (<span class="fu">sqrt</span>(<span class="fl">2</span>pi) <span class="op">*</span> <span class="fl">0.1</span>)</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    <span class="fu">v0</span>(x, y) <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="fu">u0</span>(x, y)</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>    eqs <span class="op">=</span> <span class="kw">let</span> v <span class="op">=</span> <span class="fu">v</span>(x, y, t),</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>              u <span class="op">=</span> <span class="fu">u</span>(x, y, t)</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>        [<span class="fu">Dt</span>(u) <span class="op">~</span> <span class="op">-</span>u <span class="op">*</span> v<span class="op">^</span><span class="fl">2</span> <span class="op">+</span> F <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> u) <span class="op">+</span> Du <span class="op">*</span> <span class="fu">Δ</span>(u),</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>         <span class="fu">Dt</span>(v) <span class="op">~</span> u <span class="op">*</span> v<span class="op">^</span><span class="fl">2</span> <span class="op">-</span> (F <span class="op">+</span> k) <span class="op">*</span> v <span class="op">+</span> Dv <span class="op">*</span> <span class="fu">Δ</span>(v)]</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>    domains <span class="op">=</span> [x <span class="kw">in</span> <span class="fu">Interval</span>(x_min, x_max),</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>               y <span class="kw">in</span> <span class="fu">Interval</span>(y_min, y_max),</span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a>               t <span class="kw">in</span> <span class="fu">Interval</span>(t_min, t_max)]</span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a>    bcs <span class="op">=</span> [<span class="fu">u</span>(x,y,<span class="fl">0</span>) <span class="op">~</span> <span class="fu">u0</span>(x,y),</span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>           <span class="fu">u</span>(<span class="fl">0</span>,y,t) <span class="op">~</span> <span class="fu">u</span>(<span class="fl">1</span>,y,t),</span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>           <span class="fu">u</span>(x,<span class="fl">0</span>,t) <span class="op">~</span> <span class="fu">u</span>(x,<span class="fl">1</span>,t),</span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a>           <span class="fu">v</span>(x,y,<span class="fl">0</span>) <span class="op">~</span> <span class="fu">v0</span>(x,y),</span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a>           <span class="fu">v</span>(<span class="fl">0</span>,y,t) <span class="op">~</span> <span class="fu">v</span>(<span class="fl">1</span>,y,t),</span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a>           <span class="fu">v</span>(x,<span class="fl">0</span>,t) <span class="op">~</span> <span class="fu">v</span>(x,<span class="fl">1</span>,t)]</span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a>    <span class="pp">@named</span> pdesys <span class="op">=</span> <span class="fu">PDESystem</span>(eqs, bcs, domains, [x, y, t], [<span class="fu">u</span>(x, y, t), <span class="fu">v</span>(x, y, t)])</span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a>    discretization <span class="op">=</span> <span class="fu">MOLFiniteDifference</span>([x<span class="op">=&gt;</span>N, y<span class="op">=&gt;</span>N], t, approx_order<span class="op">=</span>order)</span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">discretize</span>(pdesys, discretization)</span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a>problem <span class="op">=</span> <span class="fu">gray_scott_model</span>(<span class="fl">0.055</span>, <span class="fl">0.062</span>, <span class="fl">0.02</span>, <span class="fl">0.04</span>, <span class="fl">256</span>)</span>
<span id="cb2-46"><a href="#cb2-46" tabindex="-1"></a><span class="fu">solve</span>(problem, <span class="fu">TRBDF2</span>(), saveat<span class="op">=</span><span class="fl">0.1</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<hr>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Basic parallel for-loops are done with the <code>@threads</code>
macro.</li>
<li>Julia has built-in support for atomics.</li>
<li>Channels are primary means of asynchronous communication.</li>
</ul>
</div>
</div>
</div></section><section id="aio-170-gpu-programming"><p>Content from <a href="170-gpu-programming.html">GPU Programming</a></p>
<hr>
<p>Last updated on 2025-01-14 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/170-gpu-programming.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Can I have some Cuda please?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>See what the current state of GPU computing over Julia is.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="state-of-things">State of things<a class="anchor" aria-label="anchor" href="#state-of-things"></a>
</h2>
<hr class="half-width">
<p>There are separate packages for GPU computing, depending on the
hardware you have.</p>
<table class="table">
<thead><tr class="header">
<th>Brand</th>
<th>Lib</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>NVidia</td>
<td><a href="https://github.com/JuliaGPU/CUDA.jl" class="external-link"><code>CUDA.jl</code></a></td>
</tr>
<tr class="even">
<td>AMD</td>
<td><a href="https://github.com/JuliaGPU/AMDGPU.jl" class="external-link"><code>AMDGPU.jl</code></a></td>
</tr>
<tr class="odd">
<td>Intel</td>
<td><a href="https://github.com/JuliaGPU/oneAPI.jl" class="external-link"><code>oneAPI.jl</code></a></td>
</tr>
<tr class="even">
<td>Apple</td>
<td><a href="https://github.com/JuliaGPU/Metal.jl" class="external-link"><code>Metal.jl</code></a></td>
</tr>
</tbody>
</table>
<p>Each of these offer similar abstractions for dealing with array based
computations, though each with slightly different names. CUDA by far has
the best and most mature support. We can get reasonably portable code by
using the above packages in conjunction with
<code>KernelAbstractions</code>.</p>
</section><section><h2 class="section-heading" id="kernelabstractions">
<code>KernelAbstractions</code><a class="anchor" aria-label="anchor" href="#kernelabstractions"></a>
</h2>
<hr class="half-width">
<div class="tabs">
<nav><div id="nav-tab-1" class="nav nav-tabs" role="tablist">
<button class="nav-link active" id="nav-tab-1-Intel" name="Intel" data-bs-toggle="tab" data-bs-target="#nav-tabpanel-1-Intel" type="button" role="tab" aria-controls="nav-tabpanel-1-Intel" aria-selected="true">
  <h3 class="tab-header" id="nav-tab-heading-1-Intel">
  Intel
  </h3>
</button>
<button class="nav-link" id="nav-tab-1-Metal" name="Metal" data-bs-toggle="tab" data-bs-target="#nav-tabpanel-1-Metal" type="button" role="tab" aria-controls="nav-tabpanel-1-Metal" aria-selected="false">
  <h3 class="tab-header" id="nav-tab-heading-1-Metal">
  Metal
  </h3>
</button>
<button class="nav-link" id="nav-tab-1-NVidia" name="NVidia" data-bs-toggle="tab" data-bs-target="#nav-tabpanel-1-NVidia" type="button" role="tab" aria-controls="nav-tabpanel-1-NVidia" aria-selected="false">
  <h3 class="tab-header" id="nav-tab-heading-1-NVidia">
  NVidia
  </h3>
</button>
<button class="nav-link" id="nav-tab-1-AMD" name="AMD" data-bs-toggle="tab" data-bs-target="#nav-tabpanel-1-AMD" type="button" role="tab" aria-controls="nav-tabpanel-1-AMD" aria-selected="false">
  <h3 class="tab-header" id="nav-tab-heading-1-AMD">
  AMD
  </h3>
</button>
</div>
</nav><div id="nav-tabContent-1" class="tab-content">
<div id="nav-tabpanel-1-Intel" class="tab-pane show active" aria-labelledby="nav-tab-1-Intel" role="tabpanel">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">using</span> <span class="bu">oneAPI</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">using</span> <span class="bu">KernelAbstractions</span></span></code></pre>
</div>
</div>
<div id="nav-tabpanel-1-Metal" class="tab-pane" aria-labelledby="nav-tab-1-Metal" role="tabpanel">
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">Metal</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">using</span> <span class="bu">KernelAbstractions</span></span></code></pre>
</div>
</div>
<div id="nav-tabpanel-1-NVidia" class="tab-pane" aria-labelledby="nav-tab-1-NVidia" role="tabpanel">
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">CUDA</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="im">using</span> <span class="bu">KernelAbstractions</span></span></code></pre>
</div>
</div>
<div id="nav-tabpanel-1-AMD" class="tab-pane" aria-labelledby="nav-tab-1-AMD" role="tabpanel">
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">AMDGPU</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="im">using</span> <span class="bu">KernelAbstractions</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="pp">@kernel</span> <span class="kw">function</span> <span class="fu">vector_add</span>(a, b, c)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    I <span class="op">=</span> <span class="pp">@index</span>(Global)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    c[I] <span class="op">=</span> a[I] <span class="op">+</span> b[I]</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="run-on-host">Run on host<a class="anchor" aria-label="anchor" href="#run-on-host"></a>
</h3>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>dev <span class="op">=</span> <span class="fu">CPU</span>()</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>a <span class="op">=</span> <span class="fu">randn</span>(<span class="dt">Float32</span>, <span class="fl">1024</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>b <span class="op">=</span> <span class="fu">randn</span>(<span class="dt">Float32</span>, <span class="fl">1024</span>)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>c <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{Float32}</span>(<span class="cn">undef</span>, <span class="fl">1024</span>)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="fu">vector_add</span>(dev, <span class="fl">512</span>)(a, b, c, ndrange<span class="op">=</span><span class="fu">size</span>(a))</span></code></pre>
</div>
<p>We can perform operations on the GPU simply by operating on device
arrays.</p>
<div class="tabs">
<nav><div id="nav-tab-2" class="nav nav-tabs" role="tablist">
<button class="nav-link active" id="nav-tab-2-Intel" name="Intel" data-bs-toggle="tab" data-bs-target="#nav-tabpanel-2-Intel" type="button" role="tab" aria-controls="nav-tabpanel-2-Intel" aria-selected="true">
  <h3 class="tab-header" id="nav-tab-heading-2-Intel">
  Intel
  </h3>
</button>
<button class="nav-link" id="nav-tab-2-Metal" name="Metal" data-bs-toggle="tab" data-bs-target="#nav-tabpanel-2-Metal" type="button" role="tab" aria-controls="nav-tabpanel-2-Metal" aria-selected="false">
  <h3 class="tab-header" id="nav-tab-heading-2-Metal">
  Metal
  </h3>
</button>
<button class="nav-link" id="nav-tab-2-NVidia" name="NVidia" data-bs-toggle="tab" data-bs-target="#nav-tabpanel-2-NVidia" type="button" role="tab" aria-controls="nav-tabpanel-2-NVidia" aria-selected="false">
  <h3 class="tab-header" id="nav-tab-heading-2-NVidia">
  NVidia
  </h3>
</button>
<button class="nav-link" id="nav-tab-2-AMD" name="AMD" data-bs-toggle="tab" data-bs-target="#nav-tabpanel-2-AMD" type="button" role="tab" aria-controls="nav-tabpanel-2-AMD" aria-selected="false">
  <h3 class="tab-header" id="nav-tab-heading-2-AMD">
  AMD
  </h3>
</button>
</div>
</nav><div id="nav-tabContent-2" class="tab-content">
<div id="nav-tabpanel-2-Intel" class="tab-pane show active" aria-labelledby="nav-tab-2-Intel" role="tabpanel">
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>a_dev <span class="op">=</span> <span class="fu">oneArray</span>(a)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>b_dev <span class="op">=</span> <span class="fu">oneArray</span>(b)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>a_dev <span class="op">.+</span> b_dev</span></code></pre>
</div>
</div>
<div id="nav-tabpanel-2-Metal" class="tab-pane" aria-labelledby="nav-tab-2-Metal" role="tabpanel">
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>a_dev <span class="op">=</span> <span class="fu">MtlArray</span>(a)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>b_dev <span class="op">=</span> <span class="fu">MtlArray</span>(b)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>a_dev <span class="op">.+</span> b_dev</span></code></pre>
</div>
</div>
<div id="nav-tabpanel-2-NVidia" class="tab-pane" aria-labelledby="nav-tab-2-NVidia" role="tabpanel">
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>a_dev <span class="op">=</span> <span class="fu">CuArray</span>(a)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>b_dev <span class="op">=</span> <span class="fu">CuArray</span>(b)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>a_dev <span class="op">.+</span> b_dev</span></code></pre>
</div>
</div>
<div id="nav-tabpanel-2-AMD" class="tab-pane" aria-labelledby="nav-tab-2-AMD" role="tabpanel">
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>a_dev <span class="op">=</span> <span class="fu">ROCArray</span>(a)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>b_dev <span class="op">=</span> <span class="fu">ROCArray</span>(b)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>a_dev <span class="op">.+</span> b_dev</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="computations-on-the-device">Computations on the device<a class="anchor" aria-label="anchor" href="#computations-on-the-device"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>dev <span class="op">=</span> <span class="fu">get_backend</span>(a_dev)</span></code></pre>
</div>
<div id="run-the-vector-add-on-the-device" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="run-the-vector-add-on-the-device" class="callout-inner">
<h3 class="callout-title">Run the vector-add on the device</h3>
<div class="callout-content">
<p>Depending on your machine, try and run the above vector addition on
your GPU. Most PC (Windows or Linux) laptops have an on-board Intel GPU
that can be exploited using <code>oneAPI</code>. If you have a Mac, give
it a shot with <code>Metal</code>. Some of you may have brought a gaming
laptop with a real GPU, then <code>CUDA</code> or <code>AMDGPU</code> is
your choice.</p>
<p>Compare the run time of <code>vector_add</code> to the threaded CPU
version and the array implementation. Make sure to run
<code>KernelAbstractions.synchronize(backend)</code> when you time
results.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>c_dev <span class="op">=</span> <span class="fu">oneArray</span>(<span class="fu">zeros</span>(<span class="dt">Float32</span>, <span class="fl">1024</span>))</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="fu">vector_add</span>(dev, <span class="fl">512</span>)(a_dev, b_dev, c_dev, ndrange<span class="op">=</span><span class="fl">1024</span>)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="fu">all</span>(<span class="fu">Array</span>(c_dev) <span class="op">.==</span> a <span class="op">.+</span> b)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="kw">function</span> <span class="fu">test_vector_add</span>()</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>	<span class="fu">vector_add</span>(dev, <span class="fl">512</span>)(a_dev, b_dev, c_dev, ndrange<span class="op">=</span><span class="fl">1024</span>)</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>	KernelAbstractions.<span class="fu">synchronize</span>(dev) </span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">test_vector_add</span>()</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="cf">begin</span> c_dev <span class="op">.=</span> a_dev <span class="op">.+</span> b_dev; KernelAbstractions.<span class="fu">synchronize</span>(dev) <span class="cf">end</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="pp">@benchmark</span> c <span class="op">.=</span> a <span class="op">.+</span> b</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="implement-the-julia-fractal" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="implement-the-julia-fractal" class="callout-inner">
<h3 class="callout-title">Implement the Julia fractal</h3>
<div class="callout-content">
<p>Use the GPU library that is appropriate for your laptop. Do you
manage to get any speedup?</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">julia_host</span>(c<span class="op">::</span><span class="dt">ComplexF32</span>, s<span class="op">::</span><span class="dt">Float32</span>, maxit<span class="op">::</span><span class="dt">Int</span>, out<span class="op">::</span><span class="dt">AbstractMatrix{Int}</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>	w, h <span class="op">=</span> <span class="fu">size</span>(out)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>	<span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> idx <span class="kw">in</span> <span class="fu">CartesianIndices</span>(out)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>		x <span class="op">=</span> (idx[<span class="fl">1</span>] <span class="op">-</span> w <span class="op">÷</span> <span class="fl">2</span>) <span class="op">*</span> s</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>		y <span class="op">=</span> (idx[<span class="fl">2</span>] <span class="op">-</span> h <span class="op">÷</span> <span class="fl">2</span>) <span class="op">*</span> s</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>		z <span class="op">=</span> x <span class="op">+</span> <span class="fl">1f0im</span> <span class="op">*</span> y</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>		out[idx] <span class="op">=</span> maxit</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>		<span class="cf">for</span> k <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>maxit</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>			z <span class="op">=</span> z<span class="op">*</span>z <span class="op">+</span> c</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>			<span class="cf">if</span> <span class="fu">abs</span>(z) <span class="op">&gt;</span> <span class="fl">2f0</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>				out[idx] <span class="op">=</span> k</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>				<span class="cf">break</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>			<span class="cf">end</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>		<span class="cf">end</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>	<span class="cf">end</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>c <span class="op">=</span> <span class="op">-</span><span class="fl">0.7269f0</span><span class="op">+</span><span class="fl">0.1889f0im</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>out_host <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{Int}</span>(<span class="cn">undef</span>, <span class="fl">1920</span>, <span class="fl">1080</span>)</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a><span class="fu">julia_host</span>(c, <span class="fl">1f0</span><span class="op">/</span><span class="fl">600</span>, <span class="fl">1024</span>, out_host)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">GLMakie</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="fu">heatmap</span>(out_host)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">julia_host</span>(c, <span class="fl">1f0</span><span class="op">/</span><span class="fl">600</span>, <span class="fl">1024</span>, out_host)</span></code></pre>
</div>
<p>Hint 1: you need to convert the <code>@index(Global)</code> index
into a <code>(i, j)</code> pair. You can do this by computing the
quotient and remainder to the image width.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>idx <span class="op">=</span> <span class="pp">@index</span>(Global)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>i <span class="op">=</span> (idx<span class="op">-</span><span class="fl">1</span>) <span class="op">%</span> w <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>j <span class="op">=</span> (idx<span class="op">-</span><span class="fl">1</span>) <span class="op">÷</span> w <span class="op">+</span> <span class="fl">1</span></span></code></pre>
</div>
<p>Hint 2: on Intel we needed a gang size that divides the width of the
image, in this case <code>480</code> seemed to work.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="pp">@kernel</span> <span class="kw">function</span> <span class="fu">julia_dev</span>(c<span class="op">::</span><span class="dt">ComplexF32</span>, s<span class="op">::</span><span class="dt">Float32</span>, maxit<span class="op">::</span><span class="dt">Int</span>, out)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>	w, h <span class="op">=</span> <span class="fu">size</span>(out)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>	idx <span class="op">=</span> <span class="pp">@index</span>(Global)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>	i <span class="op">=</span> (idx<span class="op">-</span><span class="fl">1</span>) <span class="op">%</span> w <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>	j <span class="op">=</span> (idx<span class="op">-</span><span class="fl">1</span>) <span class="op">÷</span> w <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>	x <span class="op">=</span> (i <span class="op">-</span> w <span class="op">÷</span> <span class="fl">2</span>) <span class="op">*</span> s</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>	y <span class="op">=</span> (j <span class="op">-</span> h <span class="op">÷</span> <span class="fl">2</span>) <span class="op">*</span> s</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>	z <span class="op">=</span> x <span class="op">+</span> <span class="fl">1f0im</span> <span class="op">*</span> y</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>	out[idx] <span class="op">=</span> maxit</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>	<span class="cf">for</span> k <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>maxit</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>		z <span class="op">=</span> z<span class="op">*</span>z <span class="op">+</span> c</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>		<span class="cf">if</span> <span class="fu">abs</span>(z) <span class="op">&gt;</span> <span class="fl">2f0</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>			out[idx] <span class="op">=</span> k</span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>			<span class="cf">break</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>		<span class="cf">end</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>	<span class="cf">end</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>out <span class="op">=</span> <span class="fu">oneArray</span>(<span class="fu">zeros</span>(<span class="dt">Int</span>, <span class="fl">1920</span>, <span class="fl">1080</span>))</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>backend <span class="op">=</span> <span class="fu">get_backend</span>(out)</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="fu">julia_dev</span>(backend, <span class="fl">480</span>)(c, <span class="fl">1f0</span><span class="op">/</span><span class="fl">600</span>, <span class="fl">1024</span>, out, ndrange<span class="op">=</span><span class="fu">size</span>(out))</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="fu">all</span>(<span class="fu">Array</span>(out) <span class="op">.==</span> out_host)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="cf">begin</span> <span class="fu">julia_dev</span>(backend, <span class="fl">480</span>)(c, <span class="fl">1f0</span><span class="op">/</span><span class="fl">600</span>, <span class="fl">1024</span>, out, ndrange<span class="op">=</span><span class="fu">size</span>(out)); KernelAbstractions.<span class="fu">synchronize</span>(backend) <span class="cf">end</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<hr>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>We can compile Julia code to GPU backends using
<code>KernelAbstractions</code>.</li>
<li>Even on smaller laptops, significant speedups can be achieved, given
the right problem.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-180-cool-libraries"><p>Content from <a href="180-cool-libraries.html">Recap and Recommended libraries</a></p>
<hr>
<p>Last updated on 2025-02-09 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/180-cool-libraries.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Is there a recommended set of standard libraries?</li>
<li>What is the equivalent of SciPy in Julia.</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Get street-wise.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>This is a nice closing episode.</p>
<section><h2 class="section-heading" id="notebooks">Notebooks<a class="anchor" aria-label="anchor" href="#notebooks"></a>
</h2>
<hr class="half-width">
<p>Use <code>Pluto.jl</code>!</p>
</section><section><h2 class="section-heading" id="reactive-programming">Reactive programming<a class="anchor" aria-label="anchor" href="#reactive-programming"></a>
</h2>
<hr class="half-width">
<p>At several points in this lesson we saw the use of
<code>Observables.jl</code> to create interactive demos with
<code>Makie.jl</code>. If you want to build more complicated interfaces,
you may want to take a look at <code>GtkObservables.jl</code>.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">Observables</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>x <span class="op">=</span> <span class="fu">Observable</span>(<span class="fl">3.0</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>y <span class="op">=</span> <span class="fu">map</span>(sqrt, x)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>x[] <span class="op">=</span> <span class="fl">25.0</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>y[]</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="logging-and-progress-bars">Logging and Progress bars<a class="anchor" aria-label="anchor" href="#logging-and-progress-bars"></a>
</h2>
<hr class="half-width">
<p>Logging is done through the <a href="https://docs.julialang.org/en/v1/stdlib/Logging/" class="external-link"><code>Logging</code>
library</a> that is part of the standard library.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">Logging</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="pp">@warn</span> <span class="st">"Hello, World!"</span></span></code></pre>
</div>
<p>While there is a package called <code>ProgressBars.jl</code> that
seems quite popular, it is better to use <code>ProgressLogging.jl</code>
to log progress of a computation. This utility hooks into the logging
system and integrates well with Pluto and VS Code.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">using</span> <span class="bu">ProgressLogging</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="pp">@progress</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="fu">sleep</span>(<span class="fl">0.02</span>)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="cf">end</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="parallel-pipelines">Parallel pipelines<a class="anchor" aria-label="anchor" href="#parallel-pipelines"></a>
</h2>
<hr class="half-width">
<p>We’ve seen that we can use <code>IterTools.jl</code> to extend the
functionality of standard Julia <code>Iterators</code>, at only a
marginal performance hit.</p>
<p>The <code>Transducers.jl</code> package is a fundamental when
building pipelines for parallel processing. Transducers are an
interesting concept from functional programming, developed by the great
Rich Hickey of Clojure fame. Several packages build on top of
<code>Transducers.jl</code> with a more imperative interface,
<code>FLoops.jl</code> for instance.</p>
</section><section><h2 class="section-heading" id="sciml-verse">SciML-verse<a class="anchor" aria-label="anchor" href="#sciml-verse"></a>
</h2>
<hr class="half-width">
<p>There is a large group of libraries managed by the same group under
the nomer <code>SciML</code>. These libraries are focussed on scientific
modelling and machine learning. Some of these libraries are incredibly
useful on their own:</p>
<ul>
<li>
<code>Symbolics.jl</code> for symbolic computation</li>
<li>
<code>Integrals.jl</code> for numeric integration</li>
<li>
<code>DifferentialEquations.jl</code> for solving differential
equations</li>
<li>
<code>MethodOfLines.jl</code> for solving PDEs</li>
</ul>
<p>etc.</p>
<p>These libraries are very powerful and offer highly abstracted
interfaces to problems. The downside is that they pull in a massive
amount of dependencies (While this is also true for a package like
<code>Makie.jl</code>, plotting is usually not a core buisness for a
package, so <code>Makie</code> will usually be an optional dependency.
The same can’t be said of numerical algorithms). Also, the high level of
abstraction means that code can be hard to debug.</p>
<hr>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>SciML toolkit is dominant but not always the best choice.</li>
<li>Search for libraries that specify your needs.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-a01-collatz"><p>Content from <a href="a01-collatz.html">Appendix: Iterators and type stability</a></p>
<hr>
<p>Last updated on 2024-05-27 |

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/episodes/a01-collatz.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>I tried to be smart, but now my code is slow. What happened?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand how iterators work under the hood.</li>
<li>Understand why parametric types can improve performance.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>This example is inspired on <a href="https://juliafolds.github.io/data-parallelism/tutorials/quick-introduction/" class="external-link">material
by Takafumi Arakaki</a>.</p>
<p>The Collatz conjecture states that the integer sequence</p>
<p><span class="math display">\[x_{i+1} = \begin{cases}x_i / 2
&amp;\text{if $x_i$ is even}\\
	3x_i + 1 &amp;\text{if $x_i$ is odd}
\end{cases}\]</span></p>
<p>reaches the number <span class="math inline">\(1\)</span> for all
starting numbers <span class="math inline">\(x_0\)</span>.</p>
<div class="codewrapper sourceCode" id="a-collatz">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="a-collatz-1"><a href="#a-collatz-1" tabindex="-1"></a><span class="fu">collatz</span>(x) <span class="op">=</span> <span class="fu">iseven</span>(x) ? x <span class="op">÷</span> <span class="fl">2</span> <span class="op">:</span> <span class="fl">3</span>x <span class="op">+</span> <span class="fl">1</span></span></code></pre>
</div>
<section><h2 class="section-heading" id="stopping-time">Stopping time<a class="anchor" aria-label="anchor" href="#stopping-time"></a>
</h2>
<hr class="half-width">
<p>We can try to test the Collatz conjecture for some initial numbers,
by checking how long they take to reach <span class="math inline">\(1\)</span>. A simple implementation would be as
follows:</p>
<div class="codewrapper sourceCode" id="count-until">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="count-until-1"><a href="#count-until-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">count_until_fn</span>(pred, fn, init)</span>
<span id="count-until-2"><a href="#count-until-2" tabindex="-1"></a>  n <span class="op">=</span> <span class="fl">1</span></span>
<span id="count-until-3"><a href="#count-until-3" tabindex="-1"></a>  x <span class="op">=</span> init</span>
<span id="count-until-4"><a href="#count-until-4" tabindex="-1"></a>  <span class="cf">while</span> <span class="cn">true</span></span>
<span id="count-until-5"><a href="#count-until-5" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">pred</span>(x)</span>
<span id="count-until-6"><a href="#count-until-6" tabindex="-1"></a>      <span class="cf">return</span> n</span>
<span id="count-until-7"><a href="#count-until-7" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="count-until-8"><a href="#count-until-8" tabindex="-1"></a>    x <span class="op">=</span> <span class="fu">fn</span>(x)</span>
<span id="count-until-9"><a href="#count-until-9" tabindex="-1"></a>    n <span class="op">+=</span> <span class="fl">1</span></span>
<span id="count-until-10"><a href="#count-until-10" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="count-until-11"><a href="#count-until-11" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="a-collatz">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="a-collatz-1"><a href="#a-collatz-1" tabindex="-1"></a><span class="fu">collatz_stopping_time_v1</span>(n<span class="op">::</span><span class="dt">Int</span>) <span class="op">=</span> <span class="fu">count_until_fn</span>(<span class="op">==</span>(<span class="fl">1</span>), collatz, n)</span></code></pre>
</div>
<p>This is nice. We have a reusable function that counts how many times
we need to recursively apply a function, until we reach a preset
condition (predicate). However, in Julia there is a deeper abstraction
for iterators, called iterators.</p>
<p>The <code>count_until</code> function for iterators becomes a little
more intuitive.</p>
<div class="codewrapper sourceCode" id="count-until">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="count-until-1"><a href="#count-until-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">count_until</span>(pred, iterator)</span>
<span id="count-until-2"><a href="#count-until-2" tabindex="-1"></a>  <span class="cf">for</span> (i, <span class="cn">e</span>) <span class="kw">in</span> <span class="fu">enumerate</span>(iterator)</span>
<span id="count-until-3"><a href="#count-until-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">pred</span>(<span class="cn">e</span>)</span>
<span id="count-until-4"><a href="#count-until-4" tabindex="-1"></a>      <span class="cf">return</span> i</span>
<span id="count-until-5"><a href="#count-until-5" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="count-until-6"><a href="#count-until-6" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="count-until-7"><a href="#count-until-7" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">-</span><span class="fl">1</span></span>
<span id="count-until-8"><a href="#count-until-8" tabindex="-1"></a><span class="kw">end</span></span></code></pre>
</div>
<p>Now, all we need to do is write an iterator for our recursion.</p>
<div id="iterators" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="iterators" class="callout-inner">
<h3 class="callout-title">Iterators</h3>
<div class="callout-content">
<p>Custom iterators in Julia are implemented using the
<code>Base.iterate</code> method. This is one way to create lazy
collections or even infinite ones. We can write an iterator that takes a
function and iterates over its results recursively.</p>
<p>We implement two instances of <code>Base.iterate</code>: one is the
initializer</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">iterate</span><span class="er">(</span><span class="ex">i::Iterator</span><span class="kw">)</span> <span class="ex">-</span><span class="op">&gt;</span> <span class="er">(</span><span class="ex">item_0,</span> state_0<span class="kw">)</span></span></code></pre>
</div>
<p>the second handles all consecutive calls</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">iterate</span><span class="er">(</span><span class="ex">i::Iterator,</span> state_n<span class="kw">)</span> <span class="ex">-</span><span class="op">&gt;</span> <span class="er">(</span><span class="ex">item_n+1,</span> state_n+1<span class="kw">)</span></span></code></pre>
</div>
<p>Then, many functions also need to know the size of the iterator,
through <code>Base.IteratorSize(::Iterator)</code>. In our case this is
<code>IsInfinite()</code>. If you know the length in advance, also
implement <code>Base.length</code>.</p>
<p>You may also want to implement <code>Base.IteratorEltype()</code> and
<code>Base.eltype</code>.</p>
<p>Later on, we will see how we can achieve similar results using
channels.</p>
<p><a href="https://docs.julialang.org/en/v1/base/collections/#lib-collections-iteration" class="external-link">Reference</a></p>
</div>
</div>
</div>
<p>Our new iterator can compute the next state from the previous value,
so state and emitted value will be the same in this example.</p>
<div class="codewrapper sourceCode" id="iterated-untyped">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="iterated-untyped-1"><a href="#iterated-untyped-1" tabindex="-1"></a><span class="kw">struct</span> Iterated</span>
<span id="iterated-untyped-2"><a href="#iterated-untyped-2" tabindex="-1"></a>  fn</span>
<span id="iterated-untyped-3"><a href="#iterated-untyped-3" tabindex="-1"></a>  init</span>
<span id="iterated-untyped-4"><a href="#iterated-untyped-4" tabindex="-1"></a><span class="kw">end</span></span>
<span id="iterated-untyped-5"><a href="#iterated-untyped-5" tabindex="-1"></a></span>
<span id="iterated-untyped-6"><a href="#iterated-untyped-6" tabindex="-1"></a><span class="fu">iterated</span>(fn) <span class="op">=</span> init <span class="op">-&gt;</span> <span class="fu">Iterated</span>(fn, init)</span>
<span id="iterated-untyped-7"><a href="#iterated-untyped-7" tabindex="-1"></a><span class="fu">iterated</span>(fn, init) <span class="op">=</span> <span class="fu">Iterated</span>(fn, init)</span>
<span id="iterated-untyped-8"><a href="#iterated-untyped-8" tabindex="-1"></a></span>
<span id="iterated-untyped-9"><a href="#iterated-untyped-9" tabindex="-1"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">iterate</span>(i<span class="op">::</span><span class="dt">Iterated</span>)</span>
<span id="iterated-untyped-10"><a href="#iterated-untyped-10" tabindex="-1"></a>  i.init, i.init</span>
<span id="iterated-untyped-11"><a href="#iterated-untyped-11" tabindex="-1"></a><span class="kw">end</span></span>
<span id="iterated-untyped-12"><a href="#iterated-untyped-12" tabindex="-1"></a></span>
<span id="iterated-untyped-13"><a href="#iterated-untyped-13" tabindex="-1"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">iterate</span>(i<span class="op">::</span><span class="dt">Iterated</span>, state)</span>
<span id="iterated-untyped-14"><a href="#iterated-untyped-14" tabindex="-1"></a>  x <span class="op">=</span> i.<span class="fu">fn</span>(state)</span>
<span id="iterated-untyped-15"><a href="#iterated-untyped-15" tabindex="-1"></a>  x, x</span>
<span id="iterated-untyped-16"><a href="#iterated-untyped-16" tabindex="-1"></a><span class="kw">end</span></span>
<span id="iterated-untyped-17"><a href="#iterated-untyped-17" tabindex="-1"></a></span>
<span id="iterated-untyped-18"><a href="#iterated-untyped-18" tabindex="-1"></a><span class="bu">Base</span>.<span class="fu">IteratorSize</span>(<span class="op">::</span><span class="dt">Iterated</span>) <span class="op">=</span> <span class="bu">Base</span>.<span class="fu">IsInfinite</span>()</span>
<span id="iterated-untyped-19"><a href="#iterated-untyped-19" tabindex="-1"></a><span class="bu">Base</span>.<span class="fu">IteratorEltype</span>(<span class="op">::</span><span class="dt">Iterated</span>) <span class="op">=</span> <span class="bu">Base</span>.<span class="fu">EltypeUnknown</span>()</span></code></pre>
</div>
<p>There is a big problem with this implementation: it is slow as
molasses. We don’t know the types of the members of
<code>Recursion</code> before hand, and neither does the compiler. The
compiler will see a <code>iterate(::Recursion)</code> implementation
that can contain members of any type. This means that the return value
tuple needs to be dynamically allocated, and the call
<code>i.fn(state)</code> is indeterminate.</p>
<p>We can make this code a lot faster by writing a generic function
implementation, that specializes for every case that we encounter.</p>
<div id="function-types" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="function-types" class="callout-inner">
<h3 class="callout-title">Function types</h3>
<div class="callout-content">
<p>In Julia, every function has its own unique type. There is an
overarching abstract <code>Function</code> type, but not all function
objects (that implement <code>(::T)(args...)</code> semantics) derive
from that class. The only way to capture function types statically is by
making them generic, as in the following example.</p>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="iterated">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="iterated-1"><a href="#iterated-1" tabindex="-1"></a><span class="kw">struct</span> Iterated{Fn,T}</span>
<span id="iterated-2"><a href="#iterated-2" tabindex="-1"></a>  fn<span class="op">::</span><span class="dt">Fn</span></span>
<span id="iterated-3"><a href="#iterated-3" tabindex="-1"></a>  init<span class="op">::</span><span class="dt">T</span></span>
<span id="iterated-4"><a href="#iterated-4" tabindex="-1"></a><span class="kw">end</span></span>
<span id="iterated-5"><a href="#iterated-5" tabindex="-1"></a></span>
<span id="iterated-6"><a href="#iterated-6" tabindex="-1"></a><span class="fu">iterated</span>(fn) <span class="op">=</span> init <span class="op">-&gt;</span> <span class="fu">Iterated</span>(fn, init)</span>
<span id="iterated-7"><a href="#iterated-7" tabindex="-1"></a><span class="fu">iterated</span>(fn, init) <span class="op">=</span> <span class="fu">Iterated</span>(fn, init)</span>
<span id="iterated-8"><a href="#iterated-8" tabindex="-1"></a></span>
<span id="iterated-9"><a href="#iterated-9" tabindex="-1"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">iterate</span>(i<span class="op">::</span><span class="dt">Iterated{Fn,T}</span>) <span class="kw">where</span> {Fn,T}</span>
<span id="iterated-10"><a href="#iterated-10" tabindex="-1"></a>  i.init, i.init</span>
<span id="iterated-11"><a href="#iterated-11" tabindex="-1"></a><span class="kw">end</span></span>
<span id="iterated-12"><a href="#iterated-12" tabindex="-1"></a></span>
<span id="iterated-13"><a href="#iterated-13" tabindex="-1"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">iterate</span>(i<span class="op">::</span><span class="dt">Iterated{Fn,T}</span>, state<span class="op">::</span><span class="dt">T</span>) <span class="kw">where</span> {Fn,T}</span>
<span id="iterated-14"><a href="#iterated-14" tabindex="-1"></a>  x <span class="op">=</span> i.<span class="fu">fn</span>(state)</span>
<span id="iterated-15"><a href="#iterated-15" tabindex="-1"></a>  x, x</span>
<span id="iterated-16"><a href="#iterated-16" tabindex="-1"></a><span class="kw">end</span></span>
<span id="iterated-17"><a href="#iterated-17" tabindex="-1"></a></span>
<span id="iterated-18"><a href="#iterated-18" tabindex="-1"></a><span class="bu">Base</span>.<span class="fu">IteratorSize</span>(<span class="op">::</span><span class="dt">Iterated</span>) <span class="op">=</span> <span class="bu">Base</span>.<span class="fu">IsInfinite</span>()</span>
<span id="iterated-19"><a href="#iterated-19" tabindex="-1"></a><span class="bu">Base</span>.<span class="fu">IteratorEltype</span>(<span class="op">::</span><span class="dt">Iterated</span>) <span class="op">=</span> <span class="bu">Base</span>.<span class="fu">HasEltype</span>()</span>
<span id="iterated-20"><a href="#iterated-20" tabindex="-1"></a><span class="bu">Base</span>.<span class="fu">eltype</span>(<span class="op">::</span><span class="dt">Iterated{Fn,T}</span>) <span class="kw">where</span> {Fn,T} <span class="op">=</span> T</span></code></pre>
</div>
<p>With this definition for <code>Recursion</code>, we can write our new
function for the Collatz stopping time:</p>
<div class="codewrapper sourceCode" id="a-collatz">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="a-collatz-1"><a href="#a-collatz-1" tabindex="-1"></a><span class="fu">collatz_stopping_time_v2</span>(n<span class="op">::</span><span class="dt">Int</span>) <span class="op">=</span> <span class="fu">count_until</span>(<span class="op">==</span>(<span class="fl">1</span>), <span class="fu">recurse</span>(collatz, n))</span></code></pre>
</div>
<p>Retrieving the same run times as we had with our first
implementation.</p>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Collatz module
  </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" aria-labelledby="headingSpoiler1" data-bs-parent="#accordionSpoiler1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb3" file="examples/Collatz/src/Collatz.jl">
<h3 class="code-label">JULIA<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode julia" tabindex="0"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="kw">module</span> Collatz</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="op">&lt;&lt;</span>count<span class="op">-</span>until<span class="op">&gt;&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="op">&lt;&lt;</span>iterated<span class="op">&gt;&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="op">&lt;&lt;</span>a<span class="op">-</span>collatz<span class="op">&gt;&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="kw">end</span> <span class="co"># module Collatz</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>When things are slow, try adding more types.</li>
<li>Writing abstract code that is also performant is not easy.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/" class="external-link">Source</a></p>
				<p><a href="https://github.com/esciencecenter-digital-skills/efficient-computing-in-julia/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:j.hidding@esciencecenter.nl">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11" class="external-link">sandpaper (0.16.11)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.7" class="external-link">pegboard (0.7.7)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://esciencecenter-digital-skills.github.io/efficient-computing-in-julia/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, Julia, lesson",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://esciencecenter-digital-skills.github.io/efficient-computing-in-julia/aio.html",
  "identifier": "https://esciencecenter-digital-skills.github.io/efficient-computing-in-julia/aio.html",
  "dateCreated": "2024-01-01",
  "dateModified": "2025-02-10",
  "datePublished": "2025-02-10"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

